<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TPHA å°åŒ—åŸå¸‚ç‹©çµæ´»å‹•è¡Œç¨‹è¡¨</title>
    
    <!-- 0. ç™½å±æ•‘æ˜Ÿï¼šå…¨åŸŸéŒ¯èª¤æ•æ‰ -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            // å¿½ç•¥ ResizeObserver éŒ¯èª¤ï¼Œé€™æ˜¯ç€è¦½å™¨å¸¸è¦‹çš„è‰¯æ€§éŒ¯èª¤
            if (msg.includes("ResizeObserver loop")) return false;
            
            document.body.innerHTML = `
                <div style="padding:20px; color:white; background:#ef4444; font-family:sans-serif; height:100vh; overflow:auto;">
                    <h2 style="margin-top:0;">âš ï¸ ç³»çµ±ç™¼ç”ŸéŒ¯èª¤ (ç™½å±åµéŒ¯)</h2>
                    <p><strong>éŒ¯èª¤è¨Šæ¯:</strong> ${msg}</p>
                    <p><strong>ä½ç½®:</strong> Line ${line}:${col}</p>
                    <pre style="background:rgba(0,0,0,0.2); padding:10px; border-radius:8px; overflow:auto; white-space:pre-wrap;">${error ? error.stack : 'No stack trace'}</pre>
                    <button onclick="location.reload()" style="background:white; color:#ef4444; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; font-weight:bold; margin-top:10px;">é‡æ–°æ•´ç†é é¢</button>
                    <button onclick="localStorage.clear();location.reload()" style="background:transparent; border:1px solid white; color:white; padding:10px 20px; border-radius:5px; cursor:pointer; margin-top:10px; margin-left:10px;">æ¸…é™¤å¿«å–ä¸¦é‡æ•´</button>
                </div>
            `;
            return false;
        };
    </script>

    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ React å…¨åŸŸè®Šæ•¸ç‰ˆæœ¬ (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. è¼‰å…¥ Babel (ç¿»è­¯ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. è¼‰å…¥ Lucide åœ–æ¨™ -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 5. è¼‰å…¥ Recharts åœ–è¡¨åº« (æ›´æ›ç‚ºç©©å®š CDN) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-is/18.2.0/umd/react-is.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.10.3/Recharts.min.js"></script>

    <!-- 6. è¼‰å…¥ Firebase Compat ç‰ˆæœ¬ -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glass-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .custom-select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        
        /* è·‘é¦¬ç‡ˆå‹•ç•« */
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .animate-marquee {
            display: inline-block;
            white-space: nowrap;
            animation: marquee 20s linear infinite;
        }
        .marquee-container:hover .animate-marquee {
            animation-play-state: paused;
        }
        
        /* éŠæˆ²åŒ–æ¨£å¼ */
        .xp-bar-fill { transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }
        .quest-card { transition: all 0.2s ease; }
        .quest-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; border: 2px solid transparent; background-clip: content-box; }
        
        /* åƒç´ é¢¨åœ–ç‰‡ä¿®æ­£ */
        .pixel-art { image-rendering: pixelated; }
        .schedule-title-wrap { overflow: visible; }
        .schedule-side-decor { pointer-events: none; user-select: none; z-index: 5; }
        @media (max-width: 767px) {
            .schedule-side-decor {
                display: block !important;
                width: var(--decor-mobile-width) !important;
                opacity: 1 !important;
            }
            .schedule-side-decor-left {
                left: 0 !important;
            }
            .schedule-side-decor-right {
                right: 0 !important;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. å®‰å…¨å•Ÿå‹• React ---
        const { useState, useMemo, useEffect, useRef } = React;

        // --- 2. Firebase è¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyBtfR8N9Dw9kG3jQSfJSs0p0MLvlQaOR74",
            authDomain: "crm-sys-4184a.firebaseapp.com",
            projectId: "crm-sys-4184a",
            storageBucket: "crm-sys-4184a.firebasestorage.app",
            messagingSenderId: "943273685158",
            appId: "1:943273685158:web:8ca441dd78dcb5b956c467",
            measurementId: "G-2M2W340ZKB"
        };

        // å®‰å…¨åˆå§‹åŒ– Firebase
        let app, auth, db;
        try {
            if (typeof firebase !== 'undefined' && firebase.apps) {
                if (!firebase.apps.length) {
                    app = firebase.initializeApp(firebaseConfig);
                } else {
                    app = firebase.app();
                }
                auth = firebase.auth();
                db = firebase.firestore();

                try {
                    db.settings({ experimentalForceLongPolling: true });
                } catch (error) {
                    console.warn("Firebase settings failed (safe to ignore):", error);
                }
                console.log("Firebase initialized successfully");
            } else {
                console.error("Firebase SDK not loaded.");
            }
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }

        // --- 3. Firebase èªæ³•ç›¸å®¹å±¤ (Adapter) ---
        const wrapSnapshot = (snap) => {
            if (!snap) return null;
            if (snap.docs) return snap; 
            return {
                id: snap.id,
                ref: snap.ref,
                metadata: snap.metadata,
                data: () => snap.data(),
                exists: () => snap.exists,
                _original: snap
            };
        };
        const collection = (dbInstance, ...pathSegments) => { if (!dbInstance) return null; return dbInstance.collection(pathSegments.join('/')); };
        const doc = (dbInstance, ...pathSegments) => { if (!dbInstance) return null; return dbInstance.doc ? dbInstance.doc(pathSegments.join('/')) : db.doc(pathSegments.join('/')); };
        const setDoc = async (docRef, data, options) => { if (!docRef) return; return docRef.set(data, options); };
        const updateDoc = async (docRef, data) => { if (!docRef) return; return docRef.update(data); };
        const deleteDoc = async (docRef) => { if (!docRef) return; return docRef.delete(); };
        const addDoc = async (collRef, data) => { if (!collRef) return; return collRef.add(data); };
        const writeBatch = (dbInstance) => dbInstance.batch();
        const onSnapshot = (ref, callback) => {
            if (!ref) return () => {};
            return ref.onSnapshot(
                (snap) => callback(wrapSnapshot(snap)),
                (error) => { console.warn("Firestore è®€å–å¤±æ•—:", error); }
            );
        };
        const signInAnonymously = (authInstance) => authInstance.signInAnonymously();
        const onAuthStateChanged = (authInstance, callback) => authInstance.onAuthStateChanged(callback);

        const defaultAppId = 'default-app-id';
        const CSV_HEADER = "æ—¥æœŸ,æ´»å‹•åç¨±,è¬›å¸«,å®¢æˆ¶å§“å,é‡‘é¡,äº¤é€šæ–¹å¼,èº«åˆ†è­‰å­—è™Ÿ,ç”Ÿæ—¥,Email,å ±åç®¡é“,ç¤¾ç¾¤æš±ç¨±,å‚™è¨»,è¨‚è³¼æ—¥,æ‰‹æ©Ÿ,å ±åˆ°ç‹€æ…‹";
       
        // --- Utils & Constants ---
        const getLocalDateStr = () => {
            const d = new Date();
            const offset = d.getTimezoneOffset() * 60000;
            const localISOTime = (new Date(d - offset)).toISOString().slice(0, 10);
            return localISOTime;
        };

        const Logo = ({ className }) => {
            return (
                <div className={`flex items-center justify-center ${className}`}>
                    <img src="LOGOä¿®å¾©æª”.png" className="h-8 w-auto object-contain" alt="Logo" />
                </div>
            );
        };

        const Icon = ({ name, size = 24, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (!window.lucide) return;
                const { icons, createElement } = window.lucide;
                const iconName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                const iconNode = icons[iconName];
                if (iconNode && containerRef.current) {
                    containerRef.current.innerHTML = '';
                    const svgElement = createElement(iconNode);
                    svgElement.setAttribute('width', size);
                    svgElement.setAttribute('height', size);
                    const existingClass = svgElement.getAttribute('class') || '';
                    svgElement.setAttribute('class', `${existingClass} ${className}`.trim());
                    containerRef.current.appendChild(svgElement);
                }
            }, [name, size, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center shrink-0"></span>;
        };

        const TagSelector = ({ definitions, value, onChange, onAddTag }) => {
            const renderGroup = (label, type, options, colorClass, activeColorClass) => (
                <div className="mb-3">
                    <label className="text-xs font-bold text-slate-500 mb-1.5 block flex items-center justify-between">
                        {label}
                        <button 
                            onClick={() => {
                                const newTag = prompt(`æ–°å¢${label}æ¨™ç±¤:`);
                                if (newTag) onAddTag(type, newTag);
                            }}
                            className="text-[10px] bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 hover:text-blue-600 hover:bg-blue-50 transition"
                        >
                            + æ–°å¢
                        </button>
                    </label>
                    <div className="flex flex-wrap gap-2">
                        {options.map(opt => (
                            <button
                                key={opt}
                                type="button"
                                onClick={() => onChange(type, value[type] === opt ? '' : opt)}
                                className={`px-3 py-1.5 text-xs rounded-lg border transition-all ${
                                    value[type] === opt 
                                    ? activeColorClass 
                                    : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'
                                }`}
                            >
                                {opt}
                            </button>
                        ))}
                        {options.length === 0 && <span className="text-xs text-slate-300 italic">ç„¡é¸é …</span>}
                    </div>
                </div>
            );

            return (
                <div className="bg-slate-50 p-3 rounded-xl border border-slate-200">
                    {renderGroup('æ´»å‹•ç­‰ç´š', 'levels', definitions.levels || [], 'border-blue-200', 'bg-blue-600 text-white border-blue-600 shadow-sm')}
                    {renderGroup('æ´»å‹•ç¨®é¡', 'types', definitions.types || [], 'border-emerald-200', 'bg-emerald-600 text-white border-emerald-600 shadow-sm')}
                    {renderGroup('æ´»å‹•åœ°é»', 'locations', definitions.locations || [], 'border-purple-200', 'bg-purple-600 text-white border-purple-600 shadow-sm')}
                </div>
            );
        };

        const DebugPanel = ({ onClose }) => (
            <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                <div className="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                    <h3 className="font-bold text-lg mb-2">ç³»çµ±ç‹€æ…‹</h3>
                    <div className="bg-slate-100 p-3 rounded text-xs font-mono text-slate-600 mb-4">Status: Online (Safe Mode)<br/>Version: 3.8.6 (BugFix)<br/>Firebase: Compat</div>
                    <button onClick={onClose} className="w-full bg-slate-800 text-white py-2 rounded-lg text-sm">é—œé–‰</button>
                </div>
            </div>
        );

        const DEFAULT_TASKS_TEMPLATE = [
            { id: 'insurance', type: 'insurance', name: 'è¾¦ç†ä¿éšª', fields: [{ label: 'ä¿å–®è™Ÿç¢¼', value: '' }], completed: false },
            { id: 'pre_letter', type: 'pre_letter', name: 'å¯„é€è¡Œå‰ä¿¡', fields: [{ label: 'å¯„é€æ—¥æœŸ', value: '' }], completed: false },
            { id: 'post_letter', type: 'post_letter', name: 'å¯„é€èŠ±çµ®ä¿¡', fields: [{ label: 'ç…§ç‰‡é€£çµ', value: '' }], completed: false },
        ];

        const DEFAULT_STATUS_RULES = [
            { min: 0, max: 10, label: 'å ±åä¸­', color: 'green' },
            { min: 11, max: 20, label: 'æœ€å¾Œå¸­æ¬¡', color: 'orange' },
            { min: 21, max: 999, label: 'å·²é¡æ»¿', color: 'red' }
        ];
       
        const DEFAULT_TAG_DEFS = {
            levels: ['ä¸€èˆ¬å¤§çœ¾', 'é€²éš', 'è¦ªå­é™å®š', 'ç¤¾ç¾¤é™å®š', 'åŒ…åœ˜'],
            types: ['è›‡é¡è§€å¯Ÿ', 'å¤œé–“ç”Ÿæ…‹', 'æ­¥é“å°è¦½', 'ç”Ÿæ…‹è¬›åº§', 'è›™é¡è§€å¯Ÿ', 'æ˜†èŸ²è§€å¯Ÿ'],
            locations: ['æ–°åº—å ´', 'åŒ—æŠ•å ´', 'å…§æ¹–å ´', 'ä¿¡ç¾©å ´', 'å¯Œé™½å…¬åœ’', 'è™å±±æºª']
        };

        const DEFAULT_PUBLIC_THEME = {
            pageBg: '#fff7ed',
            pageBgAlt: '#fef3c7',
            surfaceBg: '#ffffff',
            surfaceBorder: '#fde68a',
            textColor: '#334155',
            titleColor: '#1e293b',
            accentColor: '#2563eb'
        };

        const PUBLIC_THEME_PRESETS = [
            { id: 'sunny', label: 'æ™´ç©ºç¥ç€', values: { pageBg: '#fff7ed', pageBgAlt: '#fef3c7', surfaceBg: '#ffffff', surfaceBorder: '#fde68a', textColor: '#334155', titleColor: '#1e293b', accentColor: '#2563eb' } },
            { id: 'forest', label: 'æ£®æ—è–„éœ§', values: { pageBg: '#ecfdf5', pageBgAlt: '#d1fae5', surfaceBg: '#ffffff', surfaceBorder: '#a7f3d0', textColor: '#14532d', titleColor: '#064e3b', accentColor: '#059669' } },
            { id: 'ocean', label: 'æµ·æ´‹æ™¨å…‰', values: { pageBg: '#f0f9ff', pageBgAlt: '#dbeafe', surfaceBg: '#ffffff', surfaceBorder: '#bfdbfe', textColor: '#1e3a8a', titleColor: '#1e40af', accentColor: '#0284c7' } },
            { id: 'newyear', label: 'æ–°å¹´å–œæ…¶', values: { pageBg: '#fff1f2', pageBgAlt: '#ffe4b5', surfaceBg: '#fffaf0', surfaceBorder: '#f59e0b', textColor: '#7f1d1d', titleColor: '#991b1b', accentColor: '#dc2626' } }
        ];

        const normalizePublicTheme = (theme) => ({ ...DEFAULT_PUBLIC_THEME, ...(theme || {}) });

        const DEFAULT_PUBLIC_SIDE_DECOR = {
            leftImage: '',
            rightImage: '',
            width: 180,
            mobileWidth: 0,
            offsetY: 0,
            offsetX: 24,
            opacity: 1
        };

        const DEFAULT_OUTING_POSTER_CONFIG = [
            { filename: 'new-year.gif', label: 'æ–°å¹´å‡ºå¤–', weight: 40 },
            { filename: 'climbing.gif', label: 'å±±æ—å–æ', weight: 35 },
            { filename: 'frog_jumping.gif', label: 'é‡å¤–è§€å¯Ÿ', weight: 25 }
        ];

        const normalizePublicSideDecor = (decor) => ({
            ...DEFAULT_PUBLIC_SIDE_DECOR,
            ...(decor || {}),
            // åªä½¿ç”¨æ–°éŒ¨é»åç§»ï¼Œä¸å†åƒèˆŠ top
            offsetY: Number((decor && decor.offsetY) ?? DEFAULT_PUBLIC_SIDE_DECOR.offsetY),
            offsetX: Number((decor && decor.offsetX) ?? DEFAULT_PUBLIC_SIDE_DECOR.offsetX),
            mobileWidth: Number((decor && decor.mobileWidth) ?? DEFAULT_PUBLIC_SIDE_DECOR.mobileWidth)
        });

        const COLOR_OPTIONS = [
            { value: 'blue', label: 'è—è‰² (æ­£å¸¸)', bg: 'bg-blue-50', border: 'border-blue-100', text: 'text-blue-600', hover: 'hover:bg-blue-100' },
            { value: 'green', label: 'ç¶ è‰² (å……è¶³)', bg: 'bg-green-50', border: 'border-green-100', text: 'text-green-600', hover: 'hover:bg-green-100' },
            { value: 'orange', label: 'æ©˜è‰² (ç·Šå¼µ)', bg: 'bg-orange-50', border: 'border-orange-100', text: 'text-orange-600', hover: 'hover:bg-orange-100' },
            { value: 'red', label: 'ç´…è‰² (æ»¿å“¡)', bg: 'bg-red-50', border: 'border-red-100', text: 'text-red-600', hover: 'hover:bg-red-100' },
            { value: 'purple', label: 'ç´«è‰² (ç‰¹åˆ¥)', bg: 'bg-purple-50', border: 'border-purple-100', text: 'text-purple-600', hover: 'hover:bg-purple-100' },
            { value: 'slate', label: 'ç°è‰² (æˆªæ­¢)', bg: 'bg-slate-50', border: 'border-slate-200', text: 'text-slate-500', hover: 'hover:bg-slate-100' },
        ];

        const TASK_GROUP_COLORS = [
            { border: 'border-blue-200', bg: 'bg-blue-50', text: 'text-blue-800', icon: 'text-blue-500' },
            { border: 'border-emerald-200', bg: 'bg-emerald-50', text: 'text-emerald-800', icon: 'text-emerald-500' },
            { border: 'border-amber-200', bg: 'bg-amber-50', text: 'text-amber-800', icon: 'text-amber-500' },
            { border: 'border-purple-200', bg: 'bg-purple-50', text: 'text-purple-800', icon: 'text-purple-500' },
            { border: 'border-rose-200', bg: 'bg-rose-50', text: 'text-rose-800', icon: 'text-rose-500' },
            { border: 'border-cyan-200', bg: 'bg-cyan-50', text: 'text-cyan-800', icon: 'text-cyan-500' },
        ];

        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
        const getDayOfYear = (dateStr) => {
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return 0;
            const start = new Date(date.getFullYear(), 0, 0);
            const diff = date - start;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        };
        const MONTH_LABELS = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const createProjectConsoleTemplate = (name) => ({
            id: `proj_${Date.now()}_${Math.random().toString(36).slice(2, 7)}`,
            name: name || "æ–°å°ˆæ¡ˆ",
            pm: "æœªè¨­å®š",
            department: "æœªè¨­å®š",
            totalBudget: 0,
            deadline: new Date().toISOString().split('T')[0],
            status: "active",
            workPackages: [],
            issues: [],
            createdAt: new Date().toISOString()
        });
        const normalizeConsoleTask = (task, idx, wpId) => ({
            id: task?.id || `${wpId}.${idx + 1}`,
            name: task?.name || task?.title || "æ–°ä»»å‹™",
            owner: task?.owner || task?.assignee || "æœªæŒ‡æ´¾",
            plan: {
                start: task?.plan?.start || task?.dueDate || new Date().toISOString().split('T')[0],
                end: task?.plan?.end || task?.dueDate || new Date().toISOString().split('T')[0],
                cost: Number(task?.plan?.cost || task?.kpi?.target || 0)
            },
            actual: {
                start: task?.actual?.start || task?.dueDate || new Date().toISOString().split('T')[0],
                end: task?.actual?.end || task?.dueDate || new Date().toISOString().split('T')[0],
                cost: Number(task?.actual?.cost || task?.kpi?.current || 0)
            },
            progress: Number(task?.progress ?? (task?.completed ? 100 : 0))
        });
        const normalizeConsoleProject = (project, fallbackId) => {
            const id = project?.id || fallbackId || `proj_${Date.now()}`;
            const workspaceStatus = project?.workspaceStatus || (project?.status === 'archived' ? 'archived' : 'active');
            let workPackages = Array.isArray(project?.workPackages) ? project.workPackages : [];
            if (!workPackages.length) {
                const sourceTasks = Array.isArray(project?.phases) && project.phases.length > 0
                    ? project.phases.flatMap(p => p.tasks || [])
                    : (Array.isArray(project?.subTasks) ? project.subTasks : []);
                if (sourceTasks.length > 0) {
                    workPackages = [{ id: 'WP1', name: 'ç¬¬ä¸€å·¥ä½œåŒ…', tasks: sourceTasks }];
                }
            }
            workPackages = workPackages.map((wp, wpIdx) => {
                const wpId = wp?.id || `WP${wpIdx + 1}`;
                return {
                    id: wpId,
                    name: wp?.name || `å·¥ä½œåŒ… ${wpIdx + 1}`,
                    tasks: Array.isArray(wp?.tasks) ? wp.tasks.map((t, tIdx) => normalizeConsoleTask(t, tIdx, wpId)) : []
                };
            });
            return {
                ...project,
                id,
                name: project?.name || "æœªå‘½åå°ˆæ¡ˆ",
                pm: project?.pm || project?.owner || "æœªè¨­å®š",
                department: project?.department || "æœªè¨­å®š",
                totalBudget: Number(project?.totalBudget || 0),
                deadline: project?.deadline || new Date().toISOString().split('T')[0],
                status: workspaceStatus,
                workspaceStatus,
                workPackages,
                issues: Array.isArray(project?.issues) ? project.issues : [],
                createdAt: project?.createdAt || new Date().toISOString()
            };
        };
        const toCSVField = (text) => {
            if (!text) return '';
            const str = String(text);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };

        const getWeightedOutingPoster = (posterList, excludeFilename = null) => {
            if (!Array.isArray(posterList) || posterList.length === 0) return null;
            const validList = posterList
                .filter(item => item && item.filename)
                .map(item => ({ ...item, weight: Math.max(1, parseInt(item.weight, 10) || 1) }));
            if (validList.length === 0) return null;
            const shouldExclude = excludeFilename && validList.length > 1 && validList.some(item => item.filename === excludeFilename);
            const candidateList = shouldExclude
                ? validList.filter(item => item.filename !== excludeFilename)
                : validList;
            const totalWeight = candidateList.reduce((sum, item) => sum + item.weight, 0);
            let cursor = Math.random() * totalWeight;
            for (const item of candidateList) {
                if (cursor < item.weight) return item;
                cursor -= item.weight;
            }
            return candidateList[0];
        };

        const getTaskStatusStyle = (taskType, eventDateStr) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const target = new Date(eventDateStr);
            const diffTime = target.getTime() - today.getTime();
            const daysDiff = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (taskType === 'insurance') {
                if (daysDiff <= 3 && daysDiff >= 0) return { color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200', label: 'æ€¥è¿«' };
                if (daysDiff < 0) return { color: 'text-slate-400', bg: 'bg-slate-100', border: 'border-slate-200', label: 'å·²é' };
                return { color: 'text-slate-600', bg: 'bg-white', border: 'border-slate-200', label: 'å¾…è¾¦' };
            }
            if (taskType === 'post_letter') {
                const daysSinceEvent = -daysDiff; 
                if (daysSinceEvent < 1) return { color: 'text-slate-400', bg: 'bg-slate-50', border: 'border-slate-200', label: 'æœªé–‹å§‹' };
                if (daysSinceEvent === 1) return { color: 'text-green-600', bg: 'bg-green-50', border: 'border-green-200', label: 'å»ºè­°å¯„é€' };
                if (daysSinceEvent >= 3) return { color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200', label: 'å»¶é²' };
            }
            return { color: 'text-slate-600', bg: 'bg-white', border: 'border-slate-200', label: '' };
        };

        const getPromiseStatus = (date, time) => {
            if (!date) return { status: 'normal', color: 'text-slate-600', bg: 'bg-white' };
            const now = new Date();
            const dueStr = time ? `${date}T${time}` : `${date}T23:59`;
            const due = new Date(dueStr);
            const diffMs = due - now;
            const diffHrs = diffMs / (1000 * 60 * 60);
            if (diffMs < 0) return { status: 'overdue', color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200', label: 'å·²éæœŸ' };
            if (diffHrs < 24) return { status: 'urgent', color: 'text-orange-600', bg: 'bg-orange-50', border: 'border-orange-200', label: '24hå…§' };
            return { status: 'future', color: 'text-green-700', bg: 'bg-green-50', border: 'border-green-200', label: 'é€²è¡Œä¸­' };
        };

        const getEventStatus = (count, capacity, config, dateStr, globalRules) => {
            if (dateStr) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const evtDate = new Date(dateStr);
                if (evtDate < today) {
                    return { label: 'ğŸ”š å·²çµæŸ', color: 'slate', colorObj: COLOR_OPTIONS.find(c => c.value === 'slate'), isFull: true, isEnded: true };
                }
            }
            if (capacity > 0 && count >= capacity) {
                return { label: 'ğŸˆµ å·²é¡æ»¿', color: 'slate', colorObj: COLOR_OPTIONS.find(c => c.value === 'slate'), isFull: true };
            }
            const rules = Array.isArray(config?.statusRules) && config.statusRules.length > 0 ? config.statusRules : (Array.isArray(globalRules) ? globalRules : DEFAULT_STATUS_RULES);
            const matchedRule = rules.find(r => r && count >= parseInt(r.min) && count <= parseInt(r.max));
            if (matchedRule) {
                const colorObj = COLOR_OPTIONS.find(c => c.value === matchedRule.color) || COLOR_OPTIONS[0];
                return { label: matchedRule.label || 'å ±åä¸­', color: matchedRule.color || 'blue', colorObj: colorObj || COLOR_OPTIONS[0], isFull: false };
            }
            return { label: 'å ±åä¸­', color: 'blue', colorObj: COLOR_OPTIONS[0], isFull: false };
        };

        const downloadCSV = (csvContent, filename = 'export.csv') => {
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        const NavItem = ({ id, icon, label, activeTab, setActiveTab, onClick }) => (
            <button onClick={() => { setActiveTab(id); if(onClick) onClick(); }} className={`flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 w-full text-left ${activeTab === id ? 'bg-blue-600 text-white shadow-lg shadow-blue-200' : 'text-slate-500 hover:bg-white hover:shadow-sm'}`}>
                <Icon name={icon} size={20} />
                <span className="font-medium tracking-wide">{label}</span>
            </button>
        );

        // --- Modals ---
        const CircularProgress = ({ value, max, color = "text-blue-600", size = 60, strokeWidth = 5 }) => {
            const radius = (size - strokeWidth) / 2;
            const circumference = radius * 2 * Math.PI;
            const safeValue = Math.min(Math.max(value, 0), max);
            const offset = circumference - (safeValue / max) * circumference;
           
            return (
                <div className="relative flex items-center justify-center" style={{ width: size, height: size }}>
                    <svg className="transform -rotate-90 w-full h-full">
                        <circle cx={size/2} cy={size/2} r={radius} stroke="currentColor" strokeWidth={strokeWidth} fill="transparent" className="text-slate-100" />
                        <circle cx={size/2} cy={size/2} r={radius} stroke="currentColor" strokeWidth={strokeWidth} fill="transparent" strokeDasharray={circumference} strokeDashoffset={offset} strokeLinecap="round" className={`${color} transition-all duration-1000 ease-out`} />
                    </svg>
                    <div className="absolute text-[10px] font-bold text-slate-600">
                        {Math.round((safeValue/max)*100)}%
                    </div>
                </div>
            );
        };

        const LoginModal = ({ onClose, onLogin }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState(false);
            const handleSubmit = (e) => { e.preventDefault(); onLogin(password, (isSuccess) => { if (!isSuccess) setError(true); }); };
            return (
                <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-sm p-8 shadow-2xl"><div className="flex flex-col items-center mb-6"><div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 mb-3"><Icon name="lock" size={24} /></div><h3 className="text-xl font-bold text-slate-800">ç®¡ç†å“¡ç™»å…¥</h3><p className="text-sm text-slate-500">è«‹è¼¸å…¥å¯†ç¢¼ä»¥å­˜å–å¾Œå°</p></div><form onSubmit={handleSubmit} className="space-y-4"><div><input type="password" className={`w-full p-3 border rounded-xl outline-none transition-all text-center tracking-widest font-bold text-lg ${error ? 'border-red-500 bg-red-50' : 'border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200'}`} placeholder="è¼¸å…¥å¯†ç¢¼" value={password} onChange={e => { setPassword(e.target.value); setError(false); }} autoFocus />{error && <p className="text-red-500 text-xs text-center mt-2">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦</p>}</div><div className="flex gap-2"><button type="button" onClick={onClose} className="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-lg transition-colors">å–æ¶ˆ</button><button type="submit" className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md transition-colors">ç™»å…¥</button></div></form></div></div>
            );
        };

        const AddPromiseModal = ({ onClose, onSave }) => {
            const [form, setForm] = useState({ content: '', who: '', date: new Date().toISOString().split('T')[0], time: '12:00' });
            return (<div className="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl"><div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Icon name="message-square" className="text-purple-500"/> æ–°å¢æ‰¿è«¾</h3><button onClick={onClose}><Icon name="x" className="text-slate-400 hover:text-slate-600"/></button></div><div className="space-y-4"><div><label className="block text-xs font-bold text-slate-500 mb-1">å…§å®¹</label><textarea className="w-full p-3 border rounded-xl resize-none h-24" value={form.content} onChange={e=>setForm({...form, content: e.target.value})}></textarea></div><div><label className="block text-xs font-bold text-slate-500 mb-1">å°è±¡</label><input type="text" className="w-full p-3 border rounded-xl" value={form.who} onChange={e=>setForm({...form, who: e.target.value})} /></div><div className="grid grid-cols-2 gap-3"><input type="date" className="w-full p-3 border rounded-xl" value={form.date} onChange={e=>setForm({...form, date: e.target.value })} /><input type="time" className="w-full p-3 border rounded-xl" value={form.time} onChange={e=>setForm({...form, time: e.target.value })} /></div><button onClick={()=>{if(!form.content)return;onSave(form)}} className="w-full py-3 bg-purple-600 text-white rounded-xl font-bold shadow-lg shadow-purple-200 mt-2">å»ºç«‹</button></div></div></div>);
        };

        const ProjectTaskEditModal = ({ task, phaseId, onClose, onSave }) => {
            const [form, setForm] = useState({
                title: task.title,
                assignee: task.assignee || '',
                dueDate: task.dueDate || ''
            });
            const [kpi, setKpi] = useState(task.kpi || { name: '', target: '', current: '', unit: '' });
            const [notes, setNotes] = useState(task.notes || []);
            const [newNote, setNewNote] = useState('');

            const handleAddNote = () => {
                if (!newNote.trim()) return;
                const note = {
                    id: Date.now(),
                    content: newNote,
                    date: new Date().toLocaleString()
                };
                setNotes([note, ...notes]);
                setNewNote('');
            };

            const handleSave = () => {
                const updatedTask = {
                    ...task,
                    ...form,
                    kpi,
                    notes
                };
                onSave(phaseId, task.id, updatedTask);
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
                    <div className="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl max-h-[90vh] overflow-y-auto flex flex-col">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                <Icon name="edit-3" className="text-blue-500"/> ç·¨è¼¯ä»»å‹™
                            </h3>
                            <button onClick={onClose}><Icon name="x" className="text-slate-400 hover:text-slate-600"/></button>
                        </div>

                        <div className="space-y-6 flex-1 overflow-y-auto pr-2">
                            <div className="space-y-3">
                                <h4 className="text-sm font-bold text-slate-700 border-b pb-1">åŸºæœ¬è³‡è¨Š</h4>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 mb-1">ä»»å‹™åç¨±</label>
                                    <input type="text" className="w-full p-2 border rounded-lg text-sm" value={form.title} onChange={e => setForm({...form, title: e.target.value})} />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 mb-1">è² è²¬äºº</label>
                                        <input type="text" className="w-full p-2 border rounded-lg text-sm" value={form.assignee} onChange={e => setForm({...form, assignee: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 mb-1">æˆªæ­¢æ—¥æœŸ</label>
                                        <input type="date" className="w-full p-2 border rounded-lg text-sm" value={form.dueDate} onChange={e => setForm({...form, dueDate: e.target.value})} />
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-3 bg-blue-50 p-4 rounded-xl border border-blue-100">
                                <h4 className="text-sm font-bold text-blue-700 border-b border-blue-200 pb-1 flex items-center gap-2">
                                    <Icon name="target" size={14}/> KPI è¨­å®š
                                </h4>
                                <div className="grid grid-cols-3 gap-3">
                                    <div className="col-span-3">
                                        <label className="block text-xs font-bold text-blue-600 mb-1">ç›®æ¨™åç¨±</label>
                                        <input type="text" placeholder="ä¾‹å¦‚: è§¸åŠäººæ•¸" className="w-full p-2 border border-blue-200 rounded-lg text-sm" value={kpi.name} onChange={e => setKpi({...kpi, name: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-blue-600 mb-1">ç›®æ¨™å€¼</label>
                                        <input type="number" placeholder="100" className="w-full p-2 border border-blue-200 rounded-lg text-sm" value={kpi.target} onChange={e => setKpi({...kpi, target: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-blue-600 mb-1">ç›®å‰é€²åº¦</label>
                                        <input type="number" placeholder="50" className="w-full p-2 border border-blue-200 rounded-lg text-sm" value={kpi.current} onChange={e => setKpi({...kpi, current: e.target.value})} />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-blue-600 mb-1">å–®ä½</label>
                                        <input type="text" placeholder="äºº" className="w-full p-2 border border-blue-200 rounded-lg text-sm" value={kpi.unit} onChange={e => setKpi({...kpi, unit: e.target.value})} />
                                    </div>
                                </div>
                            </div>

                            <div className="space-y-3">
                                <h4 className="text-sm font-bold text-slate-700 border-b pb-1 flex items-center gap-2">
                                    <Icon name="file-text" size={14}/> å‚™è¨»ç´€éŒ„
                                </h4>
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        className="flex-1 p-2 border rounded-lg text-sm" 
                                        placeholder="æ–°å¢ä¸€ç­†å‚™è¨»..." 
                                        value={newNote}
                                        onChange={e => setNewNote(e.target.value)}
                                        onKeyDown={e => e.key === 'Enter' && handleAddNote()}
                                    />
                                    <button onClick={handleAddNote} className="px-3 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700">
                                        <Icon name="plus" size={16} />
                                    </button>
                                </div>
                                <div className="max-h-40 overflow-y-auto space-y-2">
                                    {notes.length === 0 && <div className="text-center text-slate-400 text-xs py-4">å°šç„¡å‚™è¨»</div>}
                                    {notes.map(note => (
                                        <div key={note.id} className="bg-slate-50 p-2.5 rounded-lg border border-slate-100 text-sm">
                                            <div className="text-xs text-slate-400 mb-1">{note.date}</div>
                                            <div className="text-slate-700 break-words">{note.content}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div className="flex justify-end gap-2 mt-6 pt-4 border-t">
                            <button onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm">å–æ¶ˆ</button>
                            <button onClick={handleSave} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md text-sm">å„²å­˜è®Šæ›´</button>
                        </div>
                    </div>
                </div>
            );
        };

        const InstructorScheduleModal = ({ date, availableInstructors, restingList, onClose, onToggle, isCompanyRest, onToggleCompanyRest, isOutingDay, outingPosterFilename, outingPosterOptions, outingPeople, onToggleOutingDay, onSetOutingPoster, onToggleOutingPerson }) => {
            return (
                <div className="fixed inset-0 bg-black/50 z-[90] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
                    <div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <Icon name="calendar-days" className="text-blue-600"/> {date} æ’ç­
                            </h3>
                            <button onClick={onClose}><Icon name="x" className="text-slate-400"/></button>
                        </div>
                        
                        <div className="mb-4 p-3 bg-slate-100 rounded-xl flex justify-between items-center border border-slate-200">
                            <span className="font-bold text-slate-700 text-sm">å…¨å…¬å¸ä¼‘å‡è¨­å®š</span>
                            <button 
                                onClick={() => onToggleCompanyRest(date)} 
                                className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all shadow-sm flex items-center gap-1 ${isCompanyRest ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`}
                            >
                                {isCompanyRest ? <><Icon name="x-circle" size={12}/> æœ¬æ—¥å…¬ä¼‘</> : <><Icon name="check-circle" size={12}/> æ­£å¸¸ç‡Ÿé‹</>}
                            </button>
                        </div>

                        <div className="mb-4 p-3 bg-amber-50 rounded-xl border border-amber-200 space-y-3">
                            <div className="flex justify-between items-center">
                                <span className="font-bold text-amber-700 text-sm">æœ¬æ—¥å ´å‹˜</span>
                                <button
                                    onClick={() => onToggleOutingDay(date)}
                                    className={`px-3 py-1.5 rounded-lg text-xs font-bold transition-all shadow-sm flex items-center gap-1 ${isOutingDay ? 'bg-amber-500 text-white' : 'bg-white text-amber-700 border border-amber-200'}`}
                                >
                                    {isOutingDay ? <><Icon name="image" size={12}/> å·²å•Ÿç”¨</> : <><Icon name="x-circle" size={12}/> æœªå•Ÿç”¨</>}
                                </button>
                            </div>
                            <div>
                                <label className="block text-[11px] font-bold text-amber-700 mb-1">æŒ‡å®šé¡¯ç¤ºåœ–ç‰‡ï¼ˆç©ºç™½ = ä¾æ©Ÿç‡æŠ½åœ–ï¼‰</label>
                                <select
                                    className="w-full p-2 border border-amber-200 rounded-lg text-xs bg-white"
                                    value={outingPosterFilename || ''}
                                    onChange={(e) => onSetOutingPoster(date, e.target.value)}
                                >
                                    <option value="">ä¾æ©Ÿç‡è‡ªå‹•é¸åœ–</option>
                                    {(outingPosterOptions || []).map(item => (
                                        <option key={item.filename} value={item.filename}>
                                            {item.label || item.filename} ({item.weight || 0}%)
                                        </option>
                                    ))}
                                </select>
                            </div>
                            <div>
                                <label className="block text-[11px] font-bold text-amber-700 mb-1">å ´å‹˜äººå“¡ï¼ˆé»æ“Šåˆ‡æ›ï¼‰</label>
                                <div className="flex flex-wrap gap-1.5">
                                    {availableInstructors.map(name => {
                                        const active = (outingPeople || []).includes(name);
                                        return (
                                            <button
                                                key={`outing_${name}`}
                                                type="button"
                                                onClick={() => onToggleOutingPerson(date, name)}
                                                className={`text-[11px] px-2 py-1 rounded-full border transition-all ${active ? 'bg-amber-500 text-white border-amber-600' : 'bg-white text-amber-700 border-amber-200 hover:bg-amber-100'}`}
                                            >
                                                {name}
                                            </button>
                                        );
                                    })}
                                    {availableInstructors.length === 0 && <span className="text-[11px] text-amber-500">å°šç„¡è¬›å¸«å¯é¸</span>}
                                </div>
                            </div>
                        </div>

                        <p className="text-xs text-slate-500 mb-4">é»æ“Šåˆ‡æ›å€‹åˆ¥è¬›å¸«ä¸Šå·¥ç‹€æ…‹ (ğŸ”´ ä¼‘å‡ / ğŸŸ¢ å¯ä¸Šå·¥)</p>
                        <div className="space-y-2 max-h-60 overflow-y-auto">
                            {availableInstructors.map(name => { 
                                const isResting = restingList.includes(name); 
                                return (
                                    <div key={name} onClick={() => onToggle(date, name)} className={`flex justify-between items-center p-3 rounded-xl border cursor-pointer transition-all ${isResting ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'}`}>
                                        <span className={`font-bold ${isResting ? 'text-red-700' : 'text-green-700'}`}>{name}</span>
                                        <span className={`text-xs px-2 py-1 rounded-full font-bold ${isResting ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>{isResting ? 'ä¼‘å‡' : 'å¯ä¸Šå·¥'}</span>
                                    </div> 
                                ); 
                            })} 
                            {availableInstructors.length === 0 && <div className="text-center text-slate-400 py-4">æš«ç„¡è¬›å¸«è³‡æ–™ï¼Œè«‹å…ˆå»ºç«‹æ´»å‹•æˆ–æ‰‹å‹•è¼¸å…¥ã€‚</div>}
                        </div>
                        <div className="mt-4 pt-4 border-t flex justify-end">
                            <button onClick={onClose} className="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm">å®Œæˆ</button>
                        </div>
                    </div>
                </div>
            );
        };

        const GlobalRulesModal = ({ currentRules, onClose, onSave }) => {
            const [rules, setRules] = useState(currentRules || DEFAULT_STATUS_RULES);
            const [newRule, setNewRule] = useState({ min: 0, max: 10, label: '', color: 'blue' });
            const addRule = () => { if (!newRule.label) return alert("è«‹è¼¸å…¥é¡¯ç¤ºæ–‡å­—"); const updated = [...rules, newRule].sort((a,b) => parseInt(a.min) - parseInt(b.min)); setRules(updated); setNewRule({ min: parseInt(newRule.max) + 1, max: parseInt(newRule.max) + 10, label: '', color: 'blue' }); };
            const removeRule = (idx) => setRules(rules.filter((_, i) => i !== idx));
            return (<div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl"><div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold text-slate-800">è¨­å®šå…¨åŸŸé è¨­ç‹€æ…‹è¦å‰‡</h3><button onClick={onClose}><Icon name="x" className="text-slate-400"/></button></div><p className="text-xs text-slate-500 mb-4 bg-yellow-50 p-2 rounded text-yellow-700">æ³¨æ„ï¼šé€™è£¡çš„è¨­å®šå°‡å¥—ç”¨åˆ°ã€Œæœªå€‹åˆ¥è¨­å®šè¦å‰‡ã€çš„æ‰€æœ‰æ´»å‹•ã€‚å¦‚æœæ‚¨åœ¨å€‹åˆ¥æ´»å‹•ä¸­è¨­å®šäº†è¦å‰‡ï¼Œå°‡ä»¥å€‹åˆ¥æ´»å‹•ç‚ºæº–ã€‚</p><div className="bg-slate-50 p-3 rounded-lg border border-slate-200 mb-4"><div className="space-y-2 mb-3 max-h-60 overflow-y-auto">{rules.map((rule, idx) => (<div key={idx} className="flex items-center gap-2 text-xs bg-white p-2 rounded border"><span className="w-16 text-center bg-slate-100 rounded py-1">{rule.min}-{rule.max}äºº</span><span className={`flex-1 px-2 py-1 rounded text-center ${COLOR_OPTIONS.find(c=>c.value===rule.color)?.bg} ${COLOR_OPTIONS.find(c=>c.value===rule.color)?.text}`}>{rule.label}</span><button onClick={()=>removeRule(idx)} className="text-slate-400 hover:text-red-500"><Icon name="trash-2" size={14}/></button></div>))}</div><div className="grid grid-cols-4 gap-2 items-end border-t pt-2 border-slate-200"><div><span className="text-[10px] text-slate-400">Min</span><input type="number" className="w-full p-1 text-xs border rounded" value={newRule.min} onChange={e=>setNewRule({...newRule, min: e.target.value})}/></div><div><span className="text-[10px] text-slate-400">Max</span><input type="number" className="w-full p-1 text-xs border rounded" value={newRule.max} onChange={e=>setNewRule({...newRule, max: e.target.value})}/></div><div className="col-span-2"><span className="text-[10px] text-slate-400">æ–‡å­—</span><input type="text" className="w-full p-1 text-xs border rounded" placeholder="å¦‚: ç†±è³£ä¸­" value={newRule.label} onChange={e=>setNewRule({...newRule, label: e.target.value})}/></div><div className="col-span-3"><span className="text-[10px] text-slate-400">é¡è‰²</span><select className="w-full p-1 text-xs border rounded" value={newRule.color} onChange={e=>setNewRule({...newRule, color: e.target.value})}>{COLOR_OPTIONS.map(c=><option key={c.value} value={c.value}>{c.label}</option>)}</select></div><button onClick={addRule} className="h-[26px] bg-slate-800 text-white text-xs rounded hover:bg-slate-700">æ–°å¢</button></div></div><div className="flex justify-end gap-2"><button onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm">å–æ¶ˆ</button><button onClick={()=>onSave(rules)} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm shadow-md">å„²å­˜è¨­å®š</button></div></div></div>);
        };

        const TagSettingsModal = ({ currentDefs, onClose, onSave }) => {
            const [defs, setDefs] = useState(currentDefs || DEFAULT_TAG_DEFS);
            const [newItem, setNewItem] = useState({ type: 'levels', value: '' });

            const addItem = () => {
                if (!newItem.value.trim()) return;
                const updated = { ...defs, [newItem.type]: [...defs[newItem.type], newItem.value.trim()] };
                setDefs(updated);
                setNewItem({ ...newItem, value: '' });
            };

            const removeItem = (type, index) => {
                const updated = { ...defs, [type]: defs[type].filter((_, i) => i !== index) };
                setDefs(updated);
            };

            const renderSection = (title, type, icon) => (
                <div className="mb-4">
                    <h4 className="text-sm font-bold text-slate-700 mb-2 flex items-center gap-2">
                        <Icon name={icon} size={16} /> {title}
                    </h4>
                    <div className="flex flex-wrap gap-2 mb-2">
                        {defs[type].map((item, idx) => (
                            <div key={idx} className="text-xs bg-slate-100 border border-slate-200 px-2 py-1 rounded-full flex items-center gap-1">
                                {item}
                                <button onClick={() => removeItem(type, idx)} className="text-slate-400 hover:text-red-500">
                                    <Icon name="x" size={12} />
                                </button>
                            </div>
                        ))}
                    </div>
                </div>
            );

            return (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
                    <div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-slate-800">ç®¡ç†æ´»å‹•æ¨™ç±¤</h3>
                            <button onClick={onClose}><Icon name="x" className="text-slate-400"/></button>
                        </div>
                        
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 max-h-[60vh] overflow-y-auto mb-4">
                            {renderSection('æ´»å‹•ç­‰ç´š', 'levels', 'bar-chart-2')}
                            {renderSection('æ´»å‹•ç¨®é¡', 'types', 'tag')}
                            {renderSection('æ´»å‹•åœ°é»', 'locations', 'map-pin')}
                        </div>

                        <div className="flex gap-2 items-center bg-white p-2 border rounded-lg mb-4">
                            <select 
                                className="text-xs bg-slate-100 p-2 rounded outline-none border-none"
                                value={newItem.type}
                                onChange={e => setNewItem({ ...newItem, type: e.target.value })}
                            >
                                <option value="levels">ç­‰ç´š</option>
                                <option value="types">ç¨®é¡</option>
                                <option value="locations">åœ°é»</option>
                            </select>
                            <input 
                                type="text" 
                                className="flex-1 text-sm outline-none px-2"
                                placeholder="è¼¸å…¥æ–°æ¨™ç±¤åç¨±..."
                                value={newItem.value}
                                onChange={e => setNewItem({ ...newItem, value: e.target.value })}
                                onKeyDown={e => e.key === 'Enter' && addItem()}
                            />
                            <button onClick={addItem} className="bg-slate-800 text-white p-1.5 rounded hover:bg-slate-700"><Icon name="plus" size={16}/></button>
                        </div>

                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm">å–æ¶ˆ</button>
                            <button onClick={() => onSave(defs)} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm shadow-md">å„²å­˜è¨­å®š</button>
                        </div>
                    </div>
                </div>
            );
        };

        const OutingPosterSettingsModal = ({ currentList, onClose, onSave }) => {
            const initialList = Array.isArray(currentList) && currentList.length > 0
                ? currentList
                : DEFAULT_OUTING_POSTER_CONFIG;
            const [list, setList] = useState(initialList);
            const [draft, setDraft] = useState({ filename: '', label: '', weight: 10 });
            const [editIdx, setEditIdx] = useState(null);

            const handleAddOrUpdate = () => {
                if (!draft.filename.trim()) return alert("è«‹è¼¸å…¥åœ–ç‰‡æª”åæˆ–ç¶²å€");
                const row = {
                    filename: draft.filename.trim(),
                    label: draft.label.trim() || draft.filename.trim(),
                    weight: Math.max(1, parseInt(draft.weight, 10) || 1)
                };
                const next = [...list];
                if (editIdx === null) next.push(row);
                else next[editIdx] = row;
                setList(next);
                setDraft({ filename: '', label: '', weight: 10 });
                setEditIdx(null);
            };

            const handleEdit = (idx) => {
                setEditIdx(idx);
                setDraft(list[idx]);
            };

            const handleDelete = (idx) => {
                const next = list.filter((_, i) => i !== idx);
                setList(next);
                if (editIdx === idx) {
                    setEditIdx(null);
                    setDraft({ filename: '', label: '', weight: 10 });
                }
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
                    <div className="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden">
                        <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                            <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2"><Icon name="image"/> å¤–å‡ºå ´åˆŠè¨­å®š</h3>
                            <button onClick={onClose}><Icon name="x" className="text-slate-400 hover:text-slate-600"/></button>
                        </div>
                        <div className="p-5 space-y-4">
                            <div className="text-xs text-slate-500">è¨­å®šå¯ç”¨åœ–ç‰‡èˆ‡æ©Ÿç‡æ¬Šé‡ã€‚æ—¥æœŸè‹¥æœªæŒ‡å®šåœ–ç‰‡ï¼Œç³»çµ±æœƒä¾æ¬Šé‡è‡ªå‹•é¸åœ–ã€‚</div>
                            <div className="space-y-2 max-h-60 overflow-y-auto">
                                {list.length === 0 && <div className="text-xs text-slate-400 border border-dashed rounded-lg p-4 text-center">å°šç„¡åœ–ç‰‡ï¼Œè«‹æ–°å¢</div>}
                                {list.map((item, idx) => (
                                    <div key={`${item.filename}_${idx}`} className={`p-2 rounded-lg border flex items-center gap-2 ${editIdx === idx ? 'bg-amber-50 border-amber-300' : 'bg-white border-slate-200'}`}>
                                        <div className="flex-1 min-w-0">
                                            <div className="text-xs font-bold text-slate-700 truncate">{item.label || item.filename}</div>
                                            <div className="text-[11px] text-slate-400 truncate">{item.filename}</div>
                                        </div>
                                        <div className="text-xs font-bold bg-slate-100 px-2 py-1 rounded">{item.weight || 0}</div>
                                        <button onClick={() => handleEdit(idx)} className="p-1 text-blue-500 hover:bg-blue-50 rounded"><Icon name="edit-2" size={14}/></button>
                                        <button onClick={() => handleDelete(idx)} className="p-1 text-red-500 hover:bg-red-50 rounded"><Icon name="trash-2" size={14}/></button>
                                    </div>
                                ))}
                            </div>
                            <div className={`p-3 rounded-xl border ${editIdx !== null ? 'bg-amber-50 border-amber-200' : 'bg-slate-50 border-slate-200'}`}>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                                    <input type="text" className="p-2 border rounded-lg text-xs" placeholder="åœ–ç‰‡æª”åæˆ–ç¶²å€" value={draft.filename} onChange={e => setDraft({ ...draft, filename: e.target.value })} />
                                    <input type="text" className="p-2 border rounded-lg text-xs" placeholder="é¡¯ç¤ºåç¨±" value={draft.label} onChange={e => setDraft({ ...draft, label: e.target.value })} />
                                    <input type="number" min="1" className="p-2 border rounded-lg text-xs" placeholder="æ¬Šé‡" value={draft.weight} onChange={e => setDraft({ ...draft, weight: e.target.value })} />
                                </div>
                                <button onClick={handleAddOrUpdate} className="w-full mt-2 py-2 bg-slate-800 text-white rounded-lg text-xs font-bold hover:bg-slate-700">
                                    {editIdx !== null ? 'æ›´æ–°é …ç›®' : 'æ–°å¢é …ç›®'}
                                </button>
                            </div>
                        </div>
                        <div className="p-4 border-t bg-slate-50 flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-200 rounded-lg text-sm">å–æ¶ˆ</button>
                            <button onClick={() => onSave(list)} className="px-5 py-2 bg-amber-600 text-white rounded-lg hover:bg-amber-700 text-sm font-bold">å„²å­˜è¨­å®š</button>
                        </div>
                    </div>
                </div>
            );
        };

        const MascotSettingsModal = ({ currentList, onClose, onSave }) => {
            const defaultThemes = [
                { 
                    id: 'theme_squirrel', 
                    name: 'é£›é¼ ç³»åˆ—', 
                    keywords: 'é£›é¼ ,æ»‘ç¿”', 
                    gifs: [
                        { filename: 'eating.gif', action: 'åƒæ±è¥¿', weight: 20 },
                        { filename: 'cleaning.gif', action: 'æ‰“æƒ', weight: 35 },
                        { filename: 'climbing.gif', action: 'æ”€å²©', weight: 35 },
                        { filename: 'sliding.gif', action: 'æ»‘è¡Œ', weight: 8 },
                        { filename: 'milking.gif', action: 'å–å¥¶', weight: 2 }
                    ]
                }
            ];

            const initData = (currentList && Array.isArray(currentList)) 
                ? (currentList[0] && currentList[0].id ? currentList : defaultThemes) 
                : defaultThemes;

            const [themes, setThemes] = useState(initData);
            const [selectedThemeId, setSelectedThemeId] = useState(initData[0]?.id || 'theme_squirrel');
            const [newGif, setNewGif] = useState({ filename: '', action: '', weight: 10 });
            const [editGifIndex, setEditGifIndex] = useState(null);

            const activeTheme = themes.find(t => t.id === selectedThemeId) || themes[0];

            const addTheme = () => {
                const name = prompt("è«‹è¼¸å…¥æ–°ä¸»é¡Œåç¨± (ä¾‹å¦‚: è›™é¡ç³»åˆ—)");
                if (!name) return;
                const newId = `theme_${Date.now()}`;
                const newTheme = { id: newId, name, keywords: '', gifs: [] };
                const newThemes = [...themes, newTheme];
                setThemes(newThemes);
                setSelectedThemeId(newId);
            };

            const deleteTheme = (id) => {
                if (themes.length <= 1) return alert("è‡³å°‘ä¿ç•™ä¸€å€‹ä¸»é¡Œ");
                if (!confirm("ç¢ºå®šåˆªé™¤æ­¤ä¸»é¡ŒåŠæ‰€æœ‰è¨­å®šï¼Ÿ")) return;
                const newThemes = themes.filter(t => t.id !== id);
                setThemes(newThemes);
                setSelectedThemeId(newThemes[0].id);
            };

            const updateThemeInfo = (key, value) => {
                setThemes(themes.map(t => t.id === selectedThemeId ? { ...t, [key]: value } : t));
            };

            const handleAddOrUpdateGif = () => {
                if (!newGif.filename || !newGif.action) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š");
                const gifData = { ...newGif, weight: parseInt(newGif.weight) || 10 };
                
                const currentGifs = activeTheme.gifs || [];
                const updatedGifs = [...currentGifs];
                
                if (editGifIndex !== null) {
                    updatedGifs[editGifIndex] = gifData;
                    setEditGifIndex(null);
                } else {
                    updatedGifs.push(gifData);
                }

                updateThemeInfo('gifs', updatedGifs);
                setNewGif({ filename: '', action: '', weight: 10 });
            };

            const startEditGif = (idx) => {
                setEditGifIndex(idx);
                setNewGif(activeTheme.gifs[idx]);
            };

            const removeGif = (idx) => {
                const updatedGifs = activeTheme.gifs.filter((_, i) => i !== idx);
                updateThemeInfo('gifs', updatedGifs);
                if (editGifIndex === idx) {
                    setEditGifIndex(null);
                    setNewGif({ filename: '', action: '', weight: 10 });
                }
            };

            if (!activeTheme) return null;

            return (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
                    <div className="bg-white rounded-2xl w-full max-w-4xl p-0 shadow-2xl flex flex-col max-h-[90vh] overflow-hidden">
                        <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                            <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2">
                                <Icon name="settings" className="text-pink-500"/> å‰ç¥¥ç‰©å…¨åŸŸè¨­å®š
                            </h3>
                            <button onClick={onClose}><Icon name="x" className="text-slate-400 hover:text-slate-600"/></button>
                        </div>

                        <div className="flex flex-1 overflow-hidden">
                            <div className="w-1/3 border-r bg-slate-50 p-4 flex flex-col gap-2 overflow-y-auto">
                                <div className="text-xs font-bold text-slate-400 mb-2 uppercase">ä¸»é¡Œåˆ—è¡¨</div>
                                {themes.map(t => (
                                    <div key={t.id} onClick={() => setSelectedThemeId(t.id)} 
                                        className={`p-3 rounded-xl cursor-pointer transition-all flex justify-between items-center group ${t.id === selectedThemeId ? 'bg-white shadow-md border-l-4 border-l-pink-500 text-slate-800' : 'hover:bg-white text-slate-500'}`}>
                                        <span className="font-bold text-sm truncate">{t.name}</span>
                                        <button onClick={(e)=>{e.stopPropagation(); deleteTheme(t.id)}} className="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500"><Icon name="trash-2" size={14}/></button>
                                    </div>
                                ))}
                                <button onClick={addTheme} className="mt-2 py-2 border-2 border-dashed border-slate-300 rounded-xl text-slate-400 text-xs font-bold hover:bg-white hover:text-pink-500 hover:border-pink-300 transition-all flex justify-center items-center gap-1">
                                    <Icon name="plus" size={14}/> æ–°å¢ä¸»é¡Œ
                                </button>
                            </div>

                            <div className="w-2/3 p-6 overflow-y-auto bg-white">
                                <div className="space-y-4 mb-6">
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 mb-1 block">ä¸»é¡Œåç¨±</label>
                                        <input type="text" className="w-full p-2 border rounded-lg text-sm" value={activeTheme.name} onChange={e => updateThemeInfo('name', e.target.value)} />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 mb-1 block">è§¸ç™¼é—œéµå­— (ç”¨é€—è™Ÿåˆ†éš”)</label>
                                        <input type="text" className="w-full p-2 border rounded-lg text-sm bg-yellow-50 focus:bg-white transition-colors" placeholder="ä¾‹å¦‚: é£›é¼ , æ»‘ç¿”, å¤œé–“è§€å¯Ÿ" value={activeTheme.keywords} onChange={e => updateThemeInfo('keywords', e.target.value)} />
                                        <p className="text-[10px] text-slate-400 mt-1">ç•¶æ´»å‹•åç¨±åŒ…å«ä¸Šè¿°ä»»ä¸€é—œéµå­—æ™‚ï¼Œå°‡æœƒé¡¯ç¤ºä¸‹æ–¹çš„ GIF å‹•ç•«ã€‚</p>
                                    </div>
                                </div>

                                <div className="border-t pt-4">
                                    <div className="flex justify-between items-end mb-2">
                                        <label className="text-xs font-bold text-slate-500">GIF å‹•ä½œåˆ—è¡¨ ({activeTheme.gifs?.length || 0})</label>
                                    </div>
                                    
                                    <div className="space-y-2 mb-4">
                                        {(!activeTheme.gifs || activeTheme.gifs.length === 0) && <div className="text-center text-slate-400 text-xs py-4 border border-dashed rounded-lg">å°šç„¡ GIFï¼Œè«‹æ–°å¢</div>}
                                        {activeTheme.gifs?.map((gif, idx) => (
                                            <div key={idx} className={`flex items-center gap-2 p-2 rounded-lg border text-sm ${editGifIndex === idx ? 'bg-blue-50 border-blue-300 ring-1 ring-blue-200' : 'bg-white'}`}>
                                                <div className="flex-1 font-mono text-xs truncate" title={gif.filename}>{gif.filename}</div>
                                                <div className="w-20 truncate">{gif.action}</div>
                                                <div className="w-12 text-center bg-slate-100 rounded text-xs">{gif.weight}</div>
                                                <div className="flex gap-1">
                                                    <button onClick={() => startEditGif(idx)} className="p-1 hover:bg-blue-100 rounded text-blue-500"><Icon name="edit-2" size={14}/></button>
                                                    <button onClick={() => removeGif(idx)} className="p-1 hover:bg-red-100 rounded text-red-500"><Icon name="trash-2" size={14}/></button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>

                                    <div className={`p-3 rounded-xl border transition-all ${editGifIndex !== null ? 'bg-blue-50 border-blue-200' : 'bg-slate-50 border-slate-200'}`}>
                                        <div className="flex justify-between items-center mb-2">
                                            <span className={`text-xs font-bold ${editGifIndex !== null ? 'text-blue-600' : 'text-slate-500'}`}>{editGifIndex !== null ? 'ç·¨è¼¯ä¸­...' : 'æ–°å¢å‹•ä½œ'}</span>
                                            {editGifIndex !== null && <button onClick={()=>{setEditGifIndex(null); setNewGif({filename:'', action:'', weight:10})}} className="text-[10px] text-slate-400 underline">å–æ¶ˆ</button>}
                                        </div>
                                        <div className="flex gap-2 mb-2">
                                            <input type="text" className="flex-[2] p-2 border rounded text-xs" placeholder="æª”å (å¦‚: frog.gif)" value={newGif.filename} onChange={e=>setNewGif({...newGif, filename:e.target.value})}/>
                                            <input type="text" className="flex-[2] p-2 border rounded text-xs" placeholder="å‹•ä½œ (å¦‚: è·³æ°´)" value={newGif.action} onChange={e=>setNewGif({...newGif, action:e.target.value})}/>
                                            <input type="number" className="flex-1 p-2 border rounded text-xs" placeholder="æ¬Šé‡" value={newGif.weight} onChange={e=>setNewGif({...newGif, weight:e.target.value})}/>
                                        </div>
                                        <button onClick={handleAddOrUpdateGif} className={`w-full py-2 rounded-lg text-xs font-bold text-white shadow-sm ${editGifIndex !== null ? 'bg-blue-600 hover:bg-blue-700' : 'bg-slate-800 hover:bg-slate-700'}`}>
                                            {editGifIndex !== null ? 'æ›´æ–° GIF' : 'åŠ å…¥åˆ—è¡¨'}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="p-4 border-t bg-slate-50 flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-200 rounded-lg text-sm">å–æ¶ˆ</button>
                            <button onClick={() => onSave(themes)} className="px-6 py-2 bg-pink-600 text-white rounded-lg hover:bg-pink-700 text-sm shadow-md font-bold">å„²å­˜æ‰€æœ‰è¨­å®š</button>
                        </div>
                    </div>
                </div>
            );
        };

        const EventMascot = ({ eventName, db, dbSource, dailyStats, config }) => {
            const defaultThemes = [
                { 
                    id: 'default',
                    keywords: 'é£›é¼ ,æ»‘ç¿”', 
                    gifs: [
                        { filename: 'eating.gif', action: 'åƒæ±è¥¿', weight: 20 },
                        { filename: 'cleaning.gif', action: 'æ‰“æƒ', weight: 35 },
                        { filename: 'climbing.gif', action: 'æ”€å²©', weight: 35 },
                        { filename: 'sliding.gif', action: 'æ»‘è¡Œ', weight: 8 },
                        { filename: 'milking.gif', action: 'å–å¥¶', weight: 2 }
                    ]
                }
            ];

            const themes = Array.isArray(config) && config.length > 0 ? config : defaultThemes;
            const hasCounted = useRef(false);

            const matchedTheme = useMemo(() => {
                if (!eventName) return null;
                return themes.find(theme => {
                    if (!theme.keywords) return false;
                    const keywords = String(theme.keywords || '').split(/[,ï¼Œã€]/).map(k => k.trim()).filter(k => k);
                    return keywords.some(k => String(eventName || '').includes(k));
                });
            }, [eventName, themes]);

            const selectedItem = useMemo(() => {
                if (!matchedTheme) return null;
                const gifList = matchedTheme.gifs || [];
                if (gifList.length === 0) return null;
                const totalWeight = gifList.reduce((acc, item) => acc + (Number(item.weight) || 0), 0);
                if (totalWeight <= 0) return gifList[0];
                let random = Math.random() * totalWeight;
                for (const item of gifList) {
                    if (random < (Number(item.weight) || 0)) return item;
                    random -= (Number(item.weight) || 0);
                }
                return gifList[0];
            }, [matchedTheme]);

            const gifSrc = selectedItem?.filename || '';
            const actionName = selectedItem?.action || '';

            useEffect(() => {
                if (!db || !dbSource || hasCounted.current || !gifSrc) return;
                hasCounted.current = true; 

                const todayStr = getLocalDateStr();
                const docRef = doc(db, `artifacts/${dbSource}/analytics`, 'stats', 'daily', todayStr);
                const safeKey = gifSrc.replace(/\./g, '_');
                
                // Safety check for Firestore increment
                if (firebase && firebase.firestore && firebase.firestore.FieldValue) {
                    setDoc(docRef, {
                        mascots: {
                            [safeKey]: firebase.firestore.FieldValue.increment(1)
                        }
                    }, { merge: true }).catch(console.error);
                }
            }, [db, dbSource, gifSrc]);

            if (!gifSrc) return null;

            const safeKey = gifSrc.replace(/\./g, '_');
            const luckyNumber = (dailyStats && dailyStats.mascots && dailyStats.mascots[safeKey]) ? dailyStats.mascots[safeKey] : 1;

            return (
                <div className="absolute bottom-0 right-0 z-10 pointer-events-none flex flex-row items-end">
                    <div className="mb-12 mr-[-10px] bg-white/95 border border-slate-200 shadow-lg rounded-2xl rounded-br-none px-3 py-2 text-[10px] leading-tight text-slate-600 animate-in fade-in slide-in-from-bottom-2 duration-700 relative z-20 max-w-[140px]">
                        ä½ æ˜¯ä»Šå¤©ç¬¬ <span className="text-orange-500 font-bold text-sm">{luckyNumber}</span> ä½<br/>
                        çœ‹åˆ°<span className="text-slate-800 font-bold">{matchedTheme.name?.replace('ç³»åˆ—','') || 'å‰ç¥¥ç‰©'}</span> <span className="text-blue-600 font-bold">{actionName}</span>ï¼<br/>
                        <span className="text-yellow-500 font-bold">âœ¨ å¥½å¹¸é‹ âœ¨</span>
                    </div>
                    <img src={gifSrc} alt="Mascot" className="w-36 h-36 object-contain relative z-10" />
                </div>
            );
        };
        
        const AddEventCustomerModal = ({ eventData, historicalData, onClose, onSave }) => {
            const [form, setForm] = useState({
                customerName: '',
                price: '',
                transport: '',
                phone: '',
                email: '',
                idNo: '',
                birthday: '',
                source: '',
                notes: '',
                orderDate: new Date().toISOString().split('T')[0]
            });
            const [matchFound, setMatchFound] = useState(false);

            const uniqueCustomers = useMemo(() => {
                const names = new Set();
                return historicalData
                    .filter(d => d.customerName && d.customerName !== 'é–‹æ”¾å ±åä¸­')
                    .map(d => d.customerName)
                    .filter(name => {
                        if (names.has(name)) return false;
                        names.add(name);
                        return true;
                    })
                    .sort();
            }, [historicalData]);

            useEffect(() => {
                if (!form.customerName) {
                    setMatchFound(false);
                    return;
                }
                const records = historicalData.filter(d => d.customerName === form.customerName);
                if (records.length > 0) {
                    const lastRecord = records[records.length - 1];
                    setForm(prev => ({
                        ...prev,
                        phone: prev.phone || lastRecord.phone || '',
                        email: prev.email || lastRecord.email || '',
                        idNo: prev.idNo || lastRecord.idNo || '',
                        birthday: prev.birthday || lastRecord.birthday || '',
                        transport: prev.transport || lastRecord.transport || '',
                        source: prev.source || lastRecord.source || '',
                    }));
                    setMatchFound(true);
                } else {
                    setMatchFound(false);
                }
            }, [form.customerName, historicalData]);

            const handleSubmit = () => {
                if (!form.customerName) return alert('è«‹è¼¸å…¥å®¢æˆ¶å§“å');
                onSave(form);
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
                    <div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-4">
                            <div>
                                <h3 className="text-lg font-bold text-slate-800">æ–°å¢å ±å</h3>
                                <p className="text-xs text-slate-500">{eventData.date} - {eventData.eventName}</p>
                            </div>
                            <button onClick={onClose}><Icon name="x" className="text-slate-400 hover:text-slate-600"/></button>
                        </div>
                        
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 max-h-[60vh] overflow-y-auto space-y-3">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">å®¢æˆ¶å§“å *</label>
                                <div className="relative">
                                    <input 
                                        type="text" 
                                        list="customer-suggestions"
                                        className="w-full p-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500"
                                        placeholder="è¼¸å…¥å§“åè‡ªå‹•æœå°‹..."
                                        value={form.customerName}
                                        onChange={e => setForm({...form, customerName: e.target.value})}
                                        autoFocus
                                    />
                                    <datalist id="customer-suggestions">
                                        {form.customerName && uniqueCustomers
                                            .filter(name => name.toLowerCase().includes(form.customerName.toLowerCase()))
                                            .slice(0, 10)
                                            .map(name => <option key={name} value={name} />)
                                        }
                                    </datalist>
                                    {matchFound && (
                                        <div className="absolute right-2 top-2 text-xs text-green-600 font-bold flex items-center bg-green-50 px-2 rounded-full border border-green-200">
                                            <Icon name="check" size={12} className="mr-1"/> å·²ä»£å…¥æ­·å²è³‡æ–™
                                        </div>
                                    )}
                                </div>
                            </div>

                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">é‡‘é¡</label><input type="number" className="w-full p-2 border rounded-lg" value={form.price} onChange={e=>setForm({...form, price: e.target.value})} /></div>
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">äº¤é€š</label><select className="w-full p-2 border rounded-lg" value={form.transport} onChange={e=>setForm({...form, transport: e.target.value})}><option value="">æœªå®š</option><option value="å…±ä¹˜">å…±ä¹˜</option><option value="è‡ªè¡Œå‰å¾€">è‡ªè¡Œå‰å¾€</option></select></div>
                            </div>
                            
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">æ‰‹æ©Ÿ</label><input type="text" className="w-full p-2 border rounded-lg" value={form.phone} onChange={e=>setForm({...form, phone: e.target.value})} /></div>
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">èº«åˆ†è­‰</label><input type="text" className="w-full p-2 border rounded-lg" value={form.idNo} onChange={e=>setForm({...form, idNo: e.target.value})} /></div>
                            </div>

                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">ç”Ÿæ—¥</label><input type="date" className="w-full p-2 border rounded-lg" value={form.birthday} onChange={e=>setForm({...form, birthday: e.target.value})} /></div>
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">Email</label><input type="email" className="w-full p-2 border rounded-lg" value={form.email} onChange={e=>setForm({...form, email: e.target.value})} /></div>
                            </div>
                            
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">å ±åç®¡é“</label><input type="text" className="w-full p-2 border rounded-lg" value={form.source} onChange={e=>setForm({...form, source: e.target.value})} /></div>
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">è¨‚è³¼æ—¥</label><input type="date" className="w-full p-2 border rounded-lg" value={form.orderDate} onChange={e=>setForm({...form, orderDate: e.target.value})} /></div>
                            </div>

                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-1">å‚™è¨»</label>
                                <input type="text" className="w-full p-2 border rounded-lg" value={form.notes} onChange={e=>setForm({...form, notes: e.target.value})} />
                            </div>
                        </div>

                        <div className="flex justify-end gap-2 mt-4">
                            <button onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm">å–æ¶ˆ</button>
                            <button onClick={handleSubmit} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md text-sm">ç¢ºèªæ–°å¢</button>
                        </div>
                    </div>
                </div>
            );
        };

        const EventManagerModal = ({ event, config, onClose, onSaveConfig, availableInstructors, instructorSchedule, onCheckInToggle, onDeleteEvent, globalRules, onEditCustomer, tagDefinitions, onAddTag, parsedData, onAddDirectReg, adminPassword }) => {
            const [capacity, setCapacity] = useState(config?.capacity || 12);
            const [internalName, setInternalName] = useState(event.eventName);
            const [isEditingInternalName, setIsEditingInternalName] = useState(false);
            const [tempName, setTempName] = useState(event.eventName);
            const [eventNote, setEventNote] = useState(config?.note || '');
            const [eventTime, setEventTime] = useState(config?.time || '');
            const [eventLink, setEventLink] = useState(config?.link || '');
            const [backendColor, setBackendColor] = useState(config?.backendColor || '#eff6ff'); 
            const [displayName, setDisplayName] = useState(config?.displayName || '');
            const [activityCategory, setActivityCategory] = useState(config?.activityCategory || '');
            const [tasks, setTasks] = useState(config?.tasks || JSON.parse(JSON.stringify(DEFAULT_TASKS_TEMPLATE)));
            const [leadInstructors, setLeadInstructors] = useState(
                config?.leadInstructors && config.leadInstructors.length > 0
                    ? config.leadInstructors
                    : (event.instructor ? event.instructor.split(/[&,]/).map(s=>s.trim()).filter(Boolean) : [])
            );
            const [supportInstructors, setSupportInstructors] = useState(config?.supportInstructors || []);
            const [tempLeadInstructor, setTempLeadInstructor] = useState('');
            const [tempSupportInstructor, setTempSupportInstructor] = useState('');
            const [statusRules, setStatusRules] = useState(config?.statusRules || globalRules || DEFAULT_STATUS_RULES);
            const [newRule, setNewRule] = useState({ min: 0, max: 10, label: '', color: 'blue' });
            const [showAddRegModal, setShowAddRegModal] = useState(false);
            const [tags, setTags] = useState(config?.tags || { levels: '', types: '', locations: '' });
            const [isCancelled, setIsCancelled] = useState(!!config?.isCancelled);
            
            const handleTagChange = (type, val) => { setTags({ ...tags, [type]: val }); };
// åµæ¸¬æ˜¯å¦æœ‰ä»»ä½•è®Šæ›´
            const hasChanges = useMemo(() => {
                const currentInstr = [...leadInstructors, ...supportInstructors].sort().join(' & ');
                const originalInstr = event.instructor || '';
                const originalLeadInstructors = (config?.leadInstructors && config.leadInstructors.length > 0)
                    ? config.leadInstructors
                    : (event.instructor ? event.instructor.split(/[&,]/).map(s=>s.trim()).filter(Boolean) : []);
                const originalSupportInstructors = config?.supportInstructors || [];
                
                return (
                    internalName !== event.eventName ||
                    capacity !== (config?.capacity || 12) ||
                    eventNote !== (config?.note || '') ||
                    eventTime !== (config?.time || '') ||
                    eventLink !== (config?.link || '') ||
                    backendColor !== (config?.backendColor || '#eff6ff') ||
                    displayName !== (config?.displayName || '') ||
                    activityCategory !== (config?.activityCategory || '') ||
                    currentInstr !== originalInstr ||
                    JSON.stringify(leadInstructors) !== JSON.stringify(originalLeadInstructors) ||
                    JSON.stringify(supportInstructors) !== JSON.stringify(originalSupportInstructors) ||
                    JSON.stringify(tasks) !== JSON.stringify(config?.tasks || DEFAULT_TASKS_TEMPLATE) ||
                    JSON.stringify(tags) !== JSON.stringify(config?.tags || { levels: '', types: '', locations: '' }) ||
                    JSON.stringify(statusRules) !== JSON.stringify(config?.statusRules || globalRules || DEFAULT_STATUS_RULES) ||
                    isCancelled !== !!config?.isCancelled
                );
            }, [internalName, capacity, eventNote, eventTime, eventLink, backendColor, displayName, activityCategory, leadInstructors, supportInstructors, tasks, tags, statusRules, isCancelled, event, config]);

            // æ””æˆªé—œé–‰è«‹æ±‚
            const handleRequestClose = () => {
                if (hasChanges) {
                    if (confirm("æ‚¨æœ‰å°šæœªå„²å­˜çš„ç·¨è¼¯å…§å®¹ï¼Œç¢ºå®šè¦ç›´æ¥é—œé–‰å—ï¼Ÿï¼ˆè®Šæ›´å°‡æœƒéºå¤±ï¼‰")) {
                        onClose();
                    }
                } else {
                    onClose();
                }
            };
            const sortedCustomers = useMemo(() => {
                if (!event.customers) return [];
                return [...event.customers].sort((a, b) => {
                    if (a.transport === 'å…±ä¹˜' && b.transport !== 'å…±ä¹˜') return -1;
                    if (a.transport !== 'å…±ä¹˜' && b.transport === 'å…±ä¹˜') return 1;
                    return 0;
                });
            }, [event.customers]);

            const carpoolCount = event.customers ? event.customers.filter(c => c.transport === 'å…±ä¹˜').length : 0;
            const checkedInCount = event.customers ? event.customers.filter(c => c.isCheckedIn).length : 0;

            const handleTaskToggle = (index) => { const newTasks = [...tasks]; newTasks[index].completed = !newTasks[index].completed; setTasks(newTasks); };
            const handleAddTask = () => { const name = prompt("ä»»å‹™åç¨±:"); if(name) setTasks([...tasks, { id: `custom_${Date.now()}`, name, fields: [], completed: false }]); };
            const handleDeleteTask = (index) => { if(confirm("åˆªé™¤?")) { const n=[...tasks]; n.splice(index,1); setTasks(n); } };
            const addLeadInstructor = (name) => {
                const clean = name.trim();
                if(!clean) return;
                const isResting = instructorSchedule[event.date] && instructorSchedule[event.date].includes(clean);
                if (isResting) { if(!confirm(`${clean} åœ¨ ${event.date} å·²æ’ä¼‘ï¼Œç¢ºå®šè¦æ’å…¥å—ï¼Ÿ`)) return; }
                if (!leadInstructors.includes(clean)) setLeadInstructors([...leadInstructors, clean]);
                setTempLeadInstructor('');
            };
            const removeLeadInstructor = (name) => { setLeadInstructors(leadInstructors.filter(i => i !== name)); };
            const addSupportInstructor = (name) => {
                const clean = name.trim();
                if(!clean) return;
                const isResting = instructorSchedule[event.date] && instructorSchedule[event.date].includes(clean);
                if (isResting) { if(!confirm(`${clean} åœ¨ ${event.date} å·²æ’ä¼‘ï¼Œç¢ºå®šè¦æ’å…¥å—ï¼Ÿ`)) return; }
                if (!supportInstructors.includes(clean)) setSupportInstructors([...supportInstructors, clean]);
                setTempSupportInstructor('');
            };
            const removeSupportInstructor = (name) => { setSupportInstructors(supportInstructors.filter(i => i !== name)); };
            const addStatusRule = () => { if (!newRule.label) return alert("è«‹è¼¸å…¥é¡¯ç¤ºæ–‡å­—"); const updatedRules = [...statusRules, newRule].sort((a,b) => parseInt(a.min) - parseInt(b.min)); setStatusRules(updatedRules); setNewRule({ min: parseInt(newRule.max) + 1, max: parseInt(newRule.max) + 10, label: '', color: 'blue' }); };
            const removeStatusRule = (idx) => { setStatusRules(statusRules.filter((_, i) => i !== idx)); };

            const handleSave = () => { 
                const newInstructorStr = Array.from(new Set([...leadInstructors, ...supportInstructors])).sort().join(' & ');
                onSaveConfig({ capacity: parseInt(capacity), tasks, note: eventNote, time: eventTime, link: eventLink, statusRules, displayName, activityCategory, tags, backendColor, isCancelled, leadInstructors, supportInstructors }, newInstructorStr, internalName);    
                onClose(); 
            };
            
            const handleExportList = () => {
                let csv = "\uFEFFå§“å,æ‰‹æ©Ÿ,Email,èº«åˆ†è­‰å­—è™Ÿ,ç”Ÿæ—¥,äº¤é€š,å‚™è¨»,å ±åˆ°ç‹€æ…‹\n";
                sortedCustomers.forEach(c => { const status = c.isCheckedIn ? 'å·²å ±åˆ°' : 'æœªå ±åˆ°'; csv += `${c.customerName},${c.phone},${c.email},${c.idNo},${c.birthday},${c.transport},${toCSVField(c.notes)},${status}\n`; });
                downloadCSV(csv, `${event.eventName}_${event.date}_åå–®.csv`);
            };

            // --- ä¿®æ­£é–‹å§‹ï¼šè£œä¸Šç¼ºå¤±çš„ handleSaveNewReg å‡½å¼ ---
            const handleSaveNewReg = (customerData) => {
                // å‘¼å«ä¸Šå±¤å‚³å…¥çš„ onAddDirectReg å‡½å¼å°‡è³‡æ–™å¯«å…¥ CSV
                onAddDirectReg(event, customerData);
                // é—œé–‰æ–°å¢å ±åè¦–çª—
                setShowAddRegModal(false);
            };
            // --- ä¿®æ­£çµæŸ ---

            const progress = Math.round((tasks.filter(t => t.completed).length / Math.max(tasks.length, 1)) * 100);

            return (
                <div onClick={handleRequestClose} className="fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4 fade-in backdrop-blur-sm cursor-pointer">
                    <div onClick={(e) => e.stopPropagation()} className="bg-white rounded-2xl w-full max-w-lg flex flex-col max-h-[90vh] shadow-2xl m-auto cursor-auto">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-start">
                            <div className="flex-1 mr-4">
                                <div className="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded mb-1 inline-block">{event.date}</div>
                                {!isEditingInternalName ? (
                                    <div className="flex items-center gap-2 group cursor-pointer" onClick={() => { setTempName(internalName); setIsEditingInternalName(true); }}>
                                        <h3 className="text-xl font-bold text-slate-800">{internalName}</h3>
                                        <Icon name="edit-3" size={16} className="text-slate-300 group-hover:text-blue-500 transition-colors" />
                                    </div>
                                ) : (
                                    <div className="flex items-center gap-2 animate-in fade-in zoom-in-95">
                                        <input 
                                            type="text" 
                                            className="text-xl font-bold text-slate-800 border-b-2 border-blue-500 outline-none bg-blue-50 px-1 rounded-t w-full" 
                                            value={tempName} 
                                            onChange={e => setTempName(e.target.value)}
                                            autoFocus
                                        />
                                        <button 
                                            onClick={() => {
                                                const pwd = prompt("ä¿®æ”¹å¾Œå°åç¨±å°‡é€£å‹•æ‰€æœ‰å ±åè³‡æ–™ï¼Œè«‹è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼ç¢ºèªï¼š");
                                                if (pwd === adminPassword) {
                                                    setInternalName(tempName);
                                                    setIsEditingInternalName(false);
                                                } else if (pwd !== null) {
                                                    alert("å¯†ç¢¼éŒ¯èª¤ï¼Œå–æ¶ˆä¿®æ”¹");
                                                }
                                            }}
                                            className="bg-blue-600 text-white p-1 rounded hover:bg-blue-700 shadow-sm"
                                        >
                                            <Icon name="check" size={18} />
                                        </button>
                                        <button onClick={() => setIsEditingInternalName(false)} className="bg-slate-200 text-slate-600 p-1 rounded hover:bg-slate-300">
                                            <Icon name="x" size={18} />
                                        </button>
                                    </div>
                                )}
                                <div className="text-[10px] text-slate-400 mt-1 flex items-center gap-1">
                                    <Icon name="info" size={10}/> å¾Œå°åŸå§‹åç¨± (ä¿®æ”¹å°‡é€£å‹•æ‰€æœ‰å ±åè³‡æ–™)
                                </div>
                            </div>
                            <button onClick={handleRequestClose}><Icon name="x" className="text-slate-400 hover:text-slate-600"/></button>
                        </div>
                        {/* ä»¥ä¸‹å…§å®¹çœç•¥ï¼Œè«‹ä¿ç•™æ‚¨åŸæœ¬çš„åˆ—è¡¨èˆ‡è¨­å®šå€å¡Š */}
                        <div className="p-6 overflow-y-auto space-y-6">
                            <section>
                                <h4 className="font-bold text-slate-700 mb-2 flex items-center"><Icon name="user" size={18} className="mr-2"/> è¬›å¸«åˆ†å·¥</h4>
                                <div className="bg-slate-50 p-3 rounded-xl border border-slate-200">
                                    <div className="mb-3">
                                        <div className="text-xs font-bold text-blue-600 mb-2">ä¸»è¬›ï¼ˆçµ±è¨ˆæœƒæ¡ç”¨ï¼‰</div>
                                        <div className="flex flex-wrap gap-2 mb-2">{leadInstructors.map(ins=><div key={`lead_${ins}`} className="flex items-center bg-white text-blue-700 px-2 py-1 rounded-md text-sm border border-blue-100 shadow-sm"><span className="mr-1">{ins}</span><button onClick={()=>removeLeadInstructor(ins)}><Icon name="x" size={14} className="text-slate-400 hover:text-red-500"/></button></div>)}{leadInstructors.length===0 && <span className="text-xs text-slate-400 py-1">æœªæŒ‡å®šä¸»è¬›</span>}</div>
                                        <div className="flex gap-2"><input type="text" className="flex-1 px-3 py-1.5 border border-slate-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500" value={tempLeadInstructor} onChange={e=>setTempLeadInstructor(e.target.value)} onKeyDown={e=>e.key==='Enter'&&addLeadInstructor(tempLeadInstructor)} placeholder="è¼¸å…¥ä¸»è¬›..."/><button onClick={()=>addLeadInstructor(tempLeadInstructor)} className="px-3 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200"><Icon name="plus" size={16}/></button></div>
                                    </div>
                                    <div className="mb-2">
                                        <div className="text-xs font-bold text-emerald-600 mb-2">è·Ÿåœ˜ï¼ˆä¸åˆ—å…¥ä¸»è¬›é‡çµ±è¨ˆï¼‰</div>
                                        <div className="flex flex-wrap gap-2 mb-2">{supportInstructors.map(ins=><div key={`support_${ins}`} className="flex items-center bg-white text-emerald-700 px-2 py-1 rounded-md text-sm border border-emerald-100 shadow-sm"><span className="mr-1">{ins}</span><button onClick={()=>removeSupportInstructor(ins)}><Icon name="x" size={14} className="text-slate-400 hover:text-red-500"/></button></div>)}{supportInstructors.length===0 && <span className="text-xs text-slate-400 py-1">æœªæŒ‡å®šè·Ÿåœ˜</span>}</div>
                                        <div className="flex gap-2"><input type="text" className="flex-1 px-3 py-1.5 border border-slate-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-emerald-500" value={tempSupportInstructor} onChange={e=>setTempSupportInstructor(e.target.value)} onKeyDown={e=>e.key==='Enter'&&addSupportInstructor(tempSupportInstructor)} placeholder="è¼¸å…¥è·Ÿåœ˜..."/><button onClick={()=>addSupportInstructor(tempSupportInstructor)} className="px-3 bg-emerald-100 text-emerald-600 rounded-lg hover:bg-emerald-200"><Icon name="plus" size={16}/></button></div>
                                    </div>
                                    <div className="flex flex-wrap gap-2">{availableInstructors.slice(0,6).map(i=><div key={i} className="flex gap-1"><button onClick={()=>addLeadInstructor(i)} className="text-xs px-2 py-1 bg-white border rounded-full hover:bg-blue-50 text-slate-600">+ä¸» {i}</button><button onClick={()=>addSupportInstructor(i)} className="text-xs px-2 py-1 bg-white border rounded-full hover:bg-emerald-50 text-slate-600">+è·Ÿ {i}</button></div>)}</div>
                                </div>
                            </section>
                            <section>
                                <div className="flex justify-between items-center mb-3">
                                    <h4 className="font-bold text-slate-700 flex items-center"><Icon name="users" size={18} className="mr-2"/> å ±ååå–® ({checkedInCount}/{event.count})</h4>
                                    <div className="flex gap-2">
                                        <button onClick={()=>setShowAddRegModal(true)} className="text-xs bg-blue-600 text-white px-2 py-1 rounded hover:bg-blue-700 flex items-center shadow-sm"><Icon name="plus" size={12} className="mr-1"/> æ–°å¢å ±å</button>
                                        <button onClick={handleExportList} className="text-xs bg-slate-800 text-white px-2 py-1 rounded hover:bg-slate-700 flex items-center"><Icon name="download" size={12} className="mr-1"/> åŒ¯å‡º</button>
                                        <span className="text-xs font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded-full flex items-center">å…±ä¹˜: {carpoolCount}</span>
                                    </div>
                                </div>
                                <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 max-h-60 overflow-y-auto">
                                    {sortedCustomers.length > 0 ? (
                                        <ul className="space-y-2">
                                            {sortedCustomers.map((c, i) => (
                                                <li key={i} className={`flex justify-between items-center text-sm p-2 rounded-lg ${c.transport === 'å…±ä¹˜' ? 'bg-white border border-orange-100 shadow-sm' : 'border-b border-slate-100'}`}>
                                                    <div className="flex items-center gap-3">
                                                        <button onClick={(e)=>{e.stopPropagation(); onCheckInToggle(c.id, c.isCheckedIn);}} className={`w-5 h-5 rounded flex items-center justify-center border transition-colors ${c.isCheckedIn ? 'bg-green-500 border-green-500 text-white' : 'bg-white border-slate-300 text-transparent hover:border-blue-400'}`}><Icon name="check" size={14} /></button>
                                                        <div className="flex flex-col"><span className={`font-medium ${c.isCheckedIn ? 'text-green-700' : 'text-slate-700'}`}>{c.customerName}</span><span className="text-[10px] text-slate-400">{c.phone || 'ç„¡æ‰‹æ©Ÿ'}</span></div>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <div className="flex flex-col items-end">
                                                            {c.transport === 'å…±ä¹˜' && <span className="text-[10px] text-orange-500 flex items-center mb-0.5"><Icon name="car" size={10} className="mr-0.5"/> å…±ä¹˜</span>}
                                                        </div>
                                                        {c.isCheckedIn && <span className="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded">å·²å ±åˆ°</span>}
                                                        <button onClick={(e)=>{e.stopPropagation(); onEditCustomer(c);}} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors ml-1">
                                                            <Icon name="edit-2" size={14} />
                                                        </button>
                                                    </div>
                                                </li>
                                            ))}
                                        </ul>
                                    ) : <div className="text-slate-400 text-center text-sm py-2">ç›®å‰å°šç„¡å ±å</div>}
                                </div>
                            </section>
                            <section>
                                <h4 className="font-bold text-slate-700 mb-3 flex items-center"><Icon name="settings" size={18} className="mr-2"/> æ´»å‹•è¨­å®š</h4>
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-4">
                                    <div className="grid grid-cols-2 gap-3 bg-white p-3 rounded-lg border border-slate-200">
                                        <div className="col-span-2 text-xs font-bold text-slate-500 border-b pb-1 mb-1">ğŸ“… æ™‚é–“èˆ‡æ™‚ç¨‹è¨­å®š</div>
                                        
                                        <div><span className="text-slate-500 text-xs font-bold mb-1 block">æ´»å‹•æ™‚é–“</span><input type="time" value={eventTime} onChange={e=>setEventTime(e.target.value)} className="w-full px-2 py-1.5 text-center border border-slate-300 rounded-lg font-bold outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50"/></div>
                                        <div><span className="text-slate-500 text-xs font-bold mb-1 block">äººæ•¸ä¸Šé™</span><input type="number" value={capacity} onChange={e=>setCapacity(e.target.value)} className="w-full px-2 py-1.5 text-center border border-slate-300 rounded-lg font-bold outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50"/></div>
                                        
                                        <div>
                                            <span className="text-slate-500 text-xs font-bold mb-1 block flex items-center gap-1" title="æ´»å‹•å¯¦éš›èˆ‰è¾¦çš„å¤©æ•¸"><Icon name="calendar" size={12}/> æŒçºŒå¤©æ•¸</span>
                                            <input type="number" min="1" value={config?.duration || 1} onChange={e=>onSaveConfig({...config, duration: parseInt(e.target.value)||1})} className="w-full px-2 py-1.5 text-center border border-blue-200 rounded-lg font-bold outline-none focus:ring-2 focus:ring-blue-500 bg-blue-50/50 text-blue-700"/>
                                        </div>
                                        <div className="flex gap-1">
            <div className="flex-1">
                <span className="text-amber-600 text-xs font-bold mb-1 block flex items-center gap-1" title="æ´»å‹•å‰éœ€è¦ä½”ç”¨çš„æº–å‚™å¤©æ•¸"><Icon name="clock" size={12}/> å‰ç½®(å¤©)</span>
                <input type="number" min="0" value={config?.prepDays || 0} onChange={e=>onSaveConfig({...config, prepDays: parseInt(e.target.value)||0})} className="w-full px-1 py-1.5 text-center border border-amber-200 rounded-lg font-bold outline-none focus:ring-2 focus:ring-amber-500 bg-amber-50/50 text-amber-700 text-xs"/>
            </div>
            <div className="flex-1">
                <span className="text-amber-600 text-xs font-bold mb-1 block">å‰ç½®æ™‚é–“</span>
                <input type="time" value={config?.prepTime || ''} onChange={e=>onSaveConfig({...config, prepTime: e.target.value})} className="w-full px-1 py-1.5 text-center border border-amber-200 rounded-lg font-bold outline-none focus:ring-2 focus:ring-amber-500 bg-amber-50/50 text-amber-700 text-xs"/>
            </div>
        </div>

                                        <div className="col-span-2 mt-1">
                                            <span className="text-slate-500 text-xs font-bold mb-1 block">å¾Œå°è­˜åˆ¥é¡è‰²</span>
                                            <input type="color" value={backendColor} onChange={e=>setBackendColor(e.target.value)} className="w-full h-[30px] p-0.5 border border-slate-300 rounded-lg cursor-pointer bg-white"/>
                                        </div>
                                    </div>
                                    <div><label className="text-xs font-bold text-slate-500 mb-1 block">å‰å°é¡¯ç¤ºåç¨±</label><input type="text" className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾‹å¦‚: å†¬å­£å¤œè¨ªè›™é¡" value={displayName} onChange={e=>setDisplayName(e.target.value)} /></div>
                                    <div className="bg-rose-50 border border-rose-200 rounded-lg p-3 flex items-center justify-between">
                                        <div>
                                            <label className="text-xs font-bold text-rose-700 block">å¾Œå°æ¨™è¨˜ï¼šæµåœ˜</label>
                                            <p className="text-[10px] text-rose-500 mt-0.5">åƒ…å¾Œå°è­˜åˆ¥ç”¨ï¼Œæœˆçµ±è¨ˆåŒ¯å‡ºæœƒè‡ªå‹•æ‰£é™¤</p>
                                        </div>
                                        <button
                                            type="button"
                                            onClick={() => setIsCancelled(!isCancelled)}
                                            className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-all ${isCancelled ? 'bg-rose-600 text-white border-rose-700' : 'bg-white text-slate-600 border-slate-300 hover:bg-slate-50'}`}
                                        >
                                            {isCancelled ? 'å·²æ¨™è¨˜æµåœ˜' : 'æ¨™è¨˜ç‚ºæµåœ˜'}
                                        </button>
                                    </div>
                                    
                                    <div>
                                        <label className="text-xs font-bold text-indigo-600 mb-1 block flex items-center gap-1"><Icon name="bar-chart-2" size={12}/> æ´»å‹•æ€§è³ªåç¨± (æˆæ•ˆåˆ†æç”¨)</label>
                                        <input type="text" className="w-full px-3 py-2 text-sm border border-indigo-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 bg-indigo-50/30" placeholder="ä¾‹å¦‚: è±¡å±±å¤œé–“å°è¦½ (å°‡åˆä½µå¤šå ´æ¬¡åˆ†æ)" value={activityCategory} onChange={e=>setActivityCategory(e.target.value)} />
                                        <p className="text-[10px] text-slate-400 mt-1">è‹¥å¡«å¯«æ­¤æ¬„ä½ï¼Œåœ¨æˆæ•ˆåˆ†æé é¢å°‡ä»¥æ­¤åç¨±åˆä½µè¨ˆç®—ä¸åŒæ—¥æœŸçš„åŒæ€§è³ªæ´»å‹•ã€‚</p>
                                    </div>

                                    <div className="bg-white p-3 rounded-lg border border-slate-200">
                                        <label className="text-xs font-bold text-slate-500 mb-2 block flex items-center gap-1"><Icon name="tag" size={12}/> æ´»å‹•æ¨™ç±¤ (åˆ†é¡ç¯©é¸ç”¨)</label>
                                        <TagSelector definitions={tagDefinitions} value={tags} onChange={handleTagChange} onAddTag={onAddTag} />
                                    </div>

                                    <div className="bg-white border border-slate-200 rounded-lg p-3"><label className="text-xs font-bold text-slate-500 mb-2 block flex justify-between"><span>è‡ªå®šç¾©ç‹€æ…‹è¦å‰‡ (ä¾ç…§äººæ•¸é¡¯ç¤º)</span><span className="text-[10px] bg-slate-100 px-1 rounded font-normal">å¾ä¸Šåˆ°ä¸‹åŒ¹é…</span></label><div className="space-y-2 mb-3">{statusRules.map((rule, idx) => (<div key={idx} className="flex items-center gap-2 text-xs"><span className="w-12 text-center bg-slate-100 rounded py-1">{rule.min}-{rule.max}äºº</span><span className={`flex-1 px-2 py-1 rounded border text-center ${COLOR_OPTIONS.find(c=>c.value===rule.color)?.bg} ${COLOR_OPTIONS.find(c=>c.value===rule.color)?.text}`}>{rule.label}</span><button onClick={()=>removeStatusRule(idx)} className="text-slate-400 hover:text-red-500"><Icon name="trash-2" size={14}/></button></div>))}</div><div className="grid grid-cols-4 gap-2 items-end bg-slate-50 p-2 rounded border border-slate-100"><div><span className="text-[10px] text-slate-400">Min</span><input type="number" className="w-full p-1 text-xs border rounded" value={newRule.min} onChange={e=>setNewRule({...newRule, min: e.target.value})}/></div><div><span className="text-[10px] text-slate-400">Max</span><input type="number" className="w-full p-1 text-xs border rounded" value={newRule.max} onChange={e=>setNewRule({...newRule, max: e.target.value})}/></div><div className="col-span-2"><span className="text-[10px] text-slate-400">é¡¯ç¤ºæ–‡å­—</span><input type="text" className="w-full p-1 text-xs border rounded" placeholder="å¦‚: å ±åä¸­" value={newRule.label} onChange={e=>setNewRule({...newRule, label: e.target.value})}/></div><div className="col-span-2"><span className="text-[10px] text-slate-400">é¡è‰²</span><select className="w-full p-1 text-xs border rounded" value={newRule.color} onChange={e=>setNewRule({...newRule, color: e.target.value})}>{COLOR_OPTIONS.map(c=><option key={c.value} value={c.value}>{c.label}</option>)}</select></div><div className="col-span-2"><button onClick={addStatusRule} className="w-full py-1 bg-slate-800 text-white text-xs rounded hover:bg-slate-700">æ–°å¢è¦å‰‡</button></div></div></div>
                                    <div><label className="text-xs font-bold text-slate-500 mb-1 block">æ´»å‹•å ±åé€£çµ</label><input type="text" className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://..." value={eventLink} onChange={e=>setEventLink(e.target.value)} /></div>
                                    <div><label className="text-xs font-bold text-slate-500 mb-1 block">æ´»å‹•å°ˆå±¬å‚™è¨»</label><textarea className="w-full p-2 border border-slate-300 rounded-lg text-sm h-20 resize-none focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ä¾‹å¦‚: è¨˜å¾—å¸¶ç„¡ç·šé›»..." value={eventNote} onChange={e=>setEventNote(e.target.value)}></textarea></div>
                                </div>
                            </section>
                            <section>
                                <div className="flex justify-between items-center mb-2"><h4 className="font-bold text-slate-700 flex items-center"><Icon name="check-square" size={18} className="mr-2"/> åŸ·è¡Œä»»å‹™</h4><button onClick={handleAddTask} className="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200 flex items-center"><Icon name="plus" size={14} className="mr-1"/> æ–°å¢</button></div>
                                <div className="w-full h-1.5 bg-slate-100 rounded-full mb-4 overflow-hidden"><div className="h-full bg-green-500 transition-all duration-500" style={{width: `${progress}%`}}></div></div>
                                <div className="space-y-2">{tasks.map((t, i) => (<div key={i} className="flex items-center justify-between p-2.5 border border-slate-200 rounded-lg hover:bg-slate-50 group"><div className="flex items-center gap-3 cursor-pointer" onClick={()=>handleTaskToggle(i)}><div className={`w-4 h-4 rounded border flex items-center justify-center ${t.completed ? 'bg-green-500 border-green-500 text-white' : 'border-slate-300'}`}>{t.completed && <Icon name="check" size={12}/>}</div><span className={`text-sm ${t.completed ? 'text-slate-400 line-through' : 'text-slate-700 font-medium'}`}>{t.name}</span></div><button onClick={()=>handleDeleteTask(i)} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="trash-2" size={14}/></button></div>))}</div>
                            </section>
                        </div>
                        <div className="p-4 border-t border-slate-100 bg-slate-50/50 rounded-b-2xl flex justify-between items-center">
                            <button onClick={onDeleteEvent} className="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-1 font-bold text-sm">
                                <Icon name="trash-2" size={16}/> åˆªé™¤æ­¤æ´»å‹•
                            </button>
                            <div className="flex gap-2">
                                <button onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">å–æ¶ˆ</button>
                                <button onClick={handleSave} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md">å„²å­˜è¨­å®š</button>
                            </div>
                        </div>
                        {showAddRegModal && <AddEventCustomerModal eventData={event} historicalData={parsedData} onClose={()=>setShowAddRegModal(false)} onSave={handleSaveNewReg} />}
                    </div>
                </div>
            );
        };
// --- æœˆæ›†è³‡æ–™åŒ¯å‡ºæ¨¡çµ„ ---
        const CalendarExportModal = ({ events, eventConfigs, onClose }) => {
            const getTodayDateStr = () => {
                const d = new Date();
                const y = d.getFullYear();
                const m = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${y}-${m}-${day}`;
            };

            const normalizeDateString = (value) => {
                if (!value) return '';
                const raw = String(value).trim();
                const match = raw.match(/^(\d{4})[\/-](\d{1,2})[\/-](\d{1,2})/);
                if (match) {
                    const y = parseInt(match[1], 10);
                    const m = parseInt(match[2], 10);
                    const d = parseInt(match[3], 10);
                    const dt = new Date(y, m - 1, d);
                    if (dt.getFullYear() === y && dt.getMonth() === m - 1 && dt.getDate() === d) {
                        return `${y}-${String(m).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    }
                }
                const dt = new Date(raw);
                if (isNaN(dt.getTime())) return '';
                return `${dt.getFullYear()}-${String(dt.getMonth() + 1).padStart(2, '0')}-${String(dt.getDate()).padStart(2, '0')}`;
            };

            const handleRequestClose = (e) => {
                if (e) e.stopPropagation();
                onClose();
            };

            const toMonthStr = (dateStr) => {
                if (!dateStr) return '';
                return dateStr.slice(0, 7);
            };
            
            const defaultEndDate = useMemo(() => {
                try {
                    const list = Object.values(events);
                    if (list.length === 0) {
                        const d = new Date();
                        d.setMonth(d.getMonth() + 1);
                        return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    }

                    const validDates = list
                        .map(e => e.date)
                        .map(normalizeDateString)
                        .filter(Boolean)
                        .sort();

                    if (validDates.length > 0) {
                        return validDates[validDates.length - 1];
                    }
                } catch (e) {
                    console.error("æ—¥æœŸè¨ˆç®—éŒ¯èª¤", e);
                }
                
                return getTodayDateStr();
            }, [events]);

            const monthOptions = useMemo(() => {
                const months = new Set();
                Object.values(events).forEach(e => {
                    const normalized = normalizeDateString(e.date);
                    if (normalized) months.add(toMonthStr(normalized));
                });
                return Array.from(months).sort((a, b) => b.localeCompare(a));
            }, [events]);

            const [exportMode, setExportMode] = useState('calendar');
            const [startDate, setStartDate] = useState(getTodayDateStr());
            const [endDate, setEndDate] = useState(defaultEndDate); 
            const [listingDate, setListingDate] = useState(getTodayDateStr()); 
            const [selectedTypes, setSelectedTypes] = useState([]);
            const [selectedMonth, setSelectedMonth] = useState(monthOptions[0] || getTodayDateStr().slice(0, 7));

            useEffect(() => {
                if (defaultEndDate) {
                    setEndDate(defaultEndDate);
                }
            }, [defaultEndDate]);

            useEffect(() => {
                if (monthOptions.length === 0) {
                    setSelectedMonth(getTodayDateStr().slice(0, 7));
                    return;
                }
                if (!monthOptions.includes(selectedMonth)) {
                    setSelectedMonth(monthOptions[0]);
                }
            }, [monthOptions, selectedMonth]);

            const uniqueEventNames = useMemo(() => {
                const names = new Set();
                Object.values(events).forEach(e => {
                    const normalized = normalizeDateString(e.date);
                    if (normalized && normalized >= startDate && normalized <= endDate) {
                        names.add(e.eventName);
                    }
                });
                return Array.from(names).sort();
            }, [events, startDate, endDate]);

            const handleToggleType = (name) => {
                if (selectedTypes.includes(name)) {
                    setSelectedTypes(selectedTypes.filter(t => t !== name));
                } else {
                    setSelectedTypes([...selectedTypes, name]);
                }
            };

            const selectAll = () => setSelectedTypes(uniqueEventNames);
            const clearAll = () => setSelectedTypes([]);

            const monthlyStats = useMemo(() => {
                const instructorMap = {};
                const validEvents = Object.values(events)
                    .filter(e => {
                        const normalized = normalizeDateString(e.date);
                        if (!normalized) return false;
                        const cfg = eventConfigs[e.key] || {};
                        return toMonthStr(normalized) === selectedMonth && !cfg.isCancelled;
                    })
                    .sort((a, b) => normalizeDateString(a.date).localeCompare(normalizeDateString(b.date)));

                validEvents.forEach(e => {
                    const cfg = eventConfigs[e.key] || {};
                    const names = (cfg.leadInstructors && cfg.leadInstructors.length > 0)
                        ? cfg.leadInstructors
                        : (e.instructor || 'æœªå®š')
                            .split(/[&,]/)
                            .map(s => s.trim())
                            .filter(Boolean);
                    const finalNames = names.length > 0 ? names : ['æœªå®š'];
                    finalNames.forEach(name => {
                        instructorMap[name] = (instructorMap[name] || 0) + 1;
                    });
                });

                const instructorRows = Object.entries(instructorMap)
                    .sort((a, b) => (b[1] - a[1]) || a[0].localeCompare(b[0]));

                return {
                    totalGroups: validEvents.length,
                    instructorRows
                };
            }, [events, eventConfigs, selectedMonth]);

            const handleExport = () => {
                if (exportMode === 'monthly') {
                    if (!selectedMonth) return alert("è«‹å…ˆé¸æ“‡æœˆä»½");
                    if (monthlyStats.totalGroups === 0) return alert("è©²æœˆä»½ç„¡å¯åŒ¯å‡ºè³‡æ–™ï¼ˆå¯èƒ½éƒ½è¢«æ¨™è¨˜ç‚ºæµåœ˜ï¼‰");

                    let csvContent = "\uFEFFæœˆä»½,ç¸½åœ˜æ•¸(å·²æ‰£é™¤æµåœ˜)\n";
                    csvContent += `${selectedMonth},${monthlyStats.totalGroups}\n\n`;
                    csvContent += "è¬›å¸«,å‡ºåœ˜é‡\n";
                    monthlyStats.instructorRows.forEach(([name, count]) => {
                        csvContent += `${toCSVField(name)},${count}\n`;
                    });

                    downloadCSV(csvContent, `å‡ºåœ˜çµ±è¨ˆ_${selectedMonth}.csv`);
                    onClose();
                    return;
                }

                const filteredEvents = Object.values(events).filter(e => {
                    const normalized = normalizeDateString(e.date);
                    if (!normalized) return false;
                    const inDate = normalized >= startDate && normalized <= endDate;
                    const inType = selectedTypes.length === 0 || selectedTypes.includes(e.eventName);
                    return inDate && inType;
                }).sort((a, b) => {
                    const da = normalizeDateString(a.date);
                    const db = normalizeDateString(b.date);
                    return da.localeCompare(db);
                });

                if (filteredEvents.length === 0) return alert("ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™");

                let csvContent = "\uFEFFè¬›å¸«,æ—¥æœŸ,,,,æ´»å‹•åç¨±,,,,,,,,,,,ä¸Šæ¶æ™‚é–“,ä¸€èˆ¬ç¥¨åƒ¹æ ¼\n";

                filteredEvents.forEach(e => {
                    const cfg = eventConfigs[e.key] || {};
                    const colA = toCSVField(e.instructor || 'æœªå®š');
                    
                    // æ—¥æœŸæ ¼å¼åŒ– M/D
                    let colB = '';
                    try {
                        const normalized = normalizeDateString(e.date);
                        if (!normalized) throw new Error('invalid date');
                        const [, m, d] = normalized.split('-');
                        colB = `${parseInt(m, 10)}/${parseInt(d, 10)}`;
                    } catch(err) { colB = e.date; }

                    const colF = toCSVField(e.eventName);
                    
                    // ä¸Šæ¶æ—¥æœŸæ ¼å¼åŒ– M/D
                    const colQ = (() => {
                        const normalized = normalizeDateString(listingDate);
                        if (!normalized) return listingDate;
                        const [, m, d] = normalized.split('-');
                        return `${parseInt(m, 10)}/${parseInt(d, 10)}`;
                    })();
                    
                    let price = cfg.price || 0;
                    if (!price && e.customers && e.customers.length > 0) {
                        const validP = e.customers.find(c => c.price > 0);
                        if (validP) price = validP.price;
                    }
                    const colR = price;

                    const row = `${colA},${colB},,,,${colF},,,,,,,,,,,${colQ},${colR}`;
                    csvContent += row + "\n";
                });

                downloadCSV(csvContent, `æœˆæ›†åŒ¯å‡º_${startDate}_${endDate}.csv`);
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-[90] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
                    <div className="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                <Icon name="download" className="text-blue-600"/> åŒ¯å‡ºæœˆæ›†è³‡æ–™
                            </h3>
                            <button onClick={handleRequestClose}><Icon name="x" className="text-slate-400 hover:text-slate-600"/></button>
                        </div>

                        <div className="space-y-4">
                            <div className="bg-slate-50 border border-slate-200 rounded-lg p-1 grid grid-cols-2 gap-1">
                                <button onClick={() => setExportMode('calendar')} className={`py-2 rounded-md text-xs font-bold ${exportMode === 'calendar' ? 'bg-white text-blue-600 shadow' : 'text-slate-500'}`}>æœˆæ›†æ˜ç´°åŒ¯å‡º</button>
                                <button onClick={() => setExportMode('monthly')} className={`py-2 rounded-md text-xs font-bold ${exportMode === 'monthly' ? 'bg-white text-blue-600 shadow' : 'text-slate-500'}`}>æ¯æœˆå‡ºåœ˜çµ±è¨ˆ</button>
                            </div>

                            {exportMode === 'calendar' && (
                                <>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="text-xs font-bold text-slate-500 mb-1 block">é–‹å§‹æ—¥æœŸ</label><input type="date" className="w-full p-2 border rounded-lg" value={startDate} onChange={e=>setStartDate(e.target.value)}/></div>
                                        <div><label className="text-xs font-bold text-slate-500 mb-1 block">çµæŸæ—¥æœŸ (æœ€å¾Œä¸€åœ˜)</label><input type="date" className="w-full p-2 border rounded-lg font-bold text-blue-600 bg-blue-50" value={endDate} onChange={e=>setEndDate(e.target.value)}/></div>
                                    </div>

                                    <div>
                                        <label className="text-xs font-bold text-slate-500 mb-1 block">Qæ¬„: ä¸Šæ¶æ™‚é–“ (é¡¯ç¤ºæ–¼å ±è¡¨)</label>
                                        <input type="date" className="w-full p-2 border rounded-lg bg-slate-50 border-slate-200" value={listingDate} onChange={e=>setListingDate(e.target.value)}/>
                                    </div>

                                    <div className="border-t pt-4">
                                        <div className="flex justify-between items-center mb-2">
                                            <label className="text-xs font-bold text-slate-500">é¸æ“‡æ´»å‹• (æœªé¸å‰‡åŒ¯å‡ºå…¨éƒ¨)</label>
                                            <div className="flex gap-2">
                                                <button onClick={selectAll} className="text-[10px] bg-slate-100 px-2 py-1 rounded hover:bg-slate-200">å…¨é¸</button>
                                                <button onClick={clearAll} className="text-[10px] bg-slate-100 px-2 py-1 rounded hover:bg-slate-200">æ¸…ç©º</button>
                                            </div>
                                        </div>
                                        <div className="max-h-40 overflow-y-auto border rounded-lg p-2 bg-slate-50 grid grid-cols-2 gap-2">
                                            {uniqueEventNames.length === 0 && <div className="col-span-2 text-center text-slate-400 py-4">æ­¤æ—¥æœŸç¯„åœç„¡æ´»å‹•</div>}
                                            {uniqueEventNames.map(name => (
                                                <div key={name} onClick={() => handleToggleType(name)} 
                                                    className={`text-xs p-2 rounded cursor-pointer border flex items-center gap-2 ${selectedTypes.includes(name) ? 'bg-blue-100 border-blue-300 text-blue-700' : 'bg-white border-slate-200 text-slate-600'}`}>
                                                    <div className={`w-3 h-3 rounded-full border ${selectedTypes.includes(name) ? 'bg-blue-500 border-blue-500' : 'bg-white border-slate-300'}`}></div>
                                                    {name}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </>
                            )}

                            {exportMode === 'monthly' && (
                                <>
                                    <div>
                                        <label className="text-xs font-bold text-slate-500 mb-1 block">é¸æ“‡æœˆä»½</label>
                                        <select className="w-full p-2 border rounded-lg bg-white" value={selectedMonth} onChange={e=>setSelectedMonth(e.target.value)}>
                                            {monthOptions.length === 0 && <option value="">ç„¡æ´»å‹•æœˆä»½</option>}
                                            {monthOptions.map(m => <option key={m} value={m}>{m}</option>)}
                                        </select>
                                        <p className="text-[10px] text-slate-400 mt-1">çµ±è¨ˆæœƒè‡ªå‹•æ‰£é™¤å·²æ¨™è¨˜ã€Œæµåœ˜ã€çš„å ´æ¬¡ã€‚</p>
                                    </div>
                                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-3 space-y-2">
                                        <div className="text-xs text-slate-500">æœ¬æœˆæœ‰æ•ˆç¸½åœ˜æ•¸</div>
                                        <div className="text-2xl font-bold text-slate-800">{monthlyStats.totalGroups}</div>
                                        <div className="border-t pt-2">
                                            <div className="text-xs font-bold text-slate-600 mb-1">æ¯ä½ä¸»è¬›å‡ºåœ˜é‡</div>
                                            <div className="max-h-32 overflow-y-auto space-y-1">
                                                {monthlyStats.instructorRows.length === 0 && <div className="text-xs text-slate-400">æ­¤æœˆä»½ç„¡æœ‰æ•ˆè³‡æ–™</div>}
                                                {monthlyStats.instructorRows.map(([name, count]) => (
                                                    <div key={name} className="text-xs flex justify-between bg-white px-2 py-1 rounded border border-slate-100">
                                                        <span className="text-slate-600">{name}</span>
                                                        <span className="font-bold text-blue-600">{count}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                        </div>

                        <div className="mt-6 flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-bold">å–æ¶ˆ</button>
                            <button onClick={handleExport} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md flex items-center gap-2 text-sm font-bold">
                                <Icon name="file-text" size={16}/> {exportMode === 'monthly' ? 'åŒ¯å‡ºæœˆçµ±è¨ˆ (CSV)' : 'åŒ¯å‡º Excel (CSV)'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };
        const CreateEventModal = ({ onClose, onSave, customTemplates, onSaveTemplate, onDeleteTemplate, availableInstructors, instructorSchedule, tagDefinitions, onAddTag, initialDate }) => {
            const [mode, setMode] = useState('template'); 
            const [isCreatingTemplate, setIsCreatingTemplate] = useState(false); 
            const [calendarMonth, setCalendarMonth] = useState(initialDate ? new Date(initialDate) : new Date()); 
            
            // åŠ å…¥ statusRules èˆ‡ price åˆå§‹åŒ–
            const [formData, setFormData] = useState({ 
                dates: initialDate ? [initialDate] : [], 
                eventName: '', 
                instructors: [], 
                time: '', 
                link: '', 
                displayName: '', 
                activityCategory: '', 
                capacity: 12, 
                price: '', // æ–°å¢åƒ¹æ ¼
                tags: { levels: '', types: '', locations: '' }, 
                backendColor: '#eff6ff', 
                statusRules: [] 
            }); 
            
            const [tempInstructor, setTempInstructor] = useState(''); 
            
            // æ¨¡æ¿è³‡æ–™åˆå§‹åŒ–
            const [newTemplateData, setNewTemplateData] = useState({ 
                id: null, 
                name: '', 
                eventName: '', 
                instructor: '', 
                time: '', 
                link: '', 
                displayName: '', 
                activityCategory: '', 
                capacity: 12, 
                price: '', // æ–°å¢åƒ¹æ ¼
                tags: { levels: '', types: '', locations: '' }, 
                backendColor: '#eff6ff', 
                statusRules: [] 
            });
            
            // è¦å‰‡ç·¨è¼¯ç”¨çš„æš«å­˜ State
            const [newRule, setNewRule] = useState({ min: 0, max: 10, label: '', color: 'blue' });

            const unavailableInstructors = useMemo(() => { const unavailable = new Set(); formData.dates.forEach(date => { const resting = instructorSchedule[date] || []; resting.forEach(name => unavailable.add(name)); }); return unavailable; }, [formData.dates, instructorSchedule]);
            
            // ç·¨è¼¯æ¨¡æ¿æ™‚åŠ å…¥è¦å‰‡çš„å‡½å¼
            const addTemplateRule = () => { 
                if (!newRule.label) return alert("è«‹è¼¸å…¥é¡¯ç¤ºæ–‡å­—"); 
                const currentRules = newTemplateData.statusRules || [];
                const updated = [...currentRules, newRule].sort((a,b) => parseInt(a.min) - parseInt(b.min)); 
                setNewTemplateData({...newTemplateData, statusRules: updated}); 
                setNewRule({ min: parseInt(newRule.max) + 1, max: parseInt(newRule.max) + 10, label: '', color: 'blue' }); 
            };
            const removeTemplateRule = (idx) => { 
    const currentRules = newTemplateData.statusRules || [];
    setNewTemplateData({...newTemplateData, statusRules: currentRules.filter((_, i) => i !== idx)}); 
};

// --- æ–°å¢ï¼šè™•ç†å¿«é€Ÿé–‹åœ˜è¡¨å–®çš„è¦å‰‡é‚è¼¯ ---
const addFormRule = () => { 
    if (!newRule.label) return alert("è«‹è¼¸å…¥é¡¯ç¤ºæ–‡å­—"); 
    const currentRules = formData.statusRules || [];
    const updated = [...currentRules, newRule].sort((a,b) => parseInt(a.min) - parseInt(b.min)); 
    setFormData({...formData, statusRules: updated}); 
    setNewRule({ min: parseInt(newRule.max) + 1, max: parseInt(newRule.max) + 10, label: '', color: 'blue' }); 
};
const removeFormRule = (idx) => { 
    const currentRules = formData.statusRules || [];
    setFormData({...formData, statusRules: currentRules.filter((_, i) => i !== idx)}); 
};
// -------------------------------------

            const handleTemplateSelect = (tpl) => { 
                let tplInstructors = []; 
                if (tpl.instructor) tplInstructors = tpl.instructor.split(/[&,]/).map(s => s.trim()); 
                setFormData({ 
                    ...formData, 
                    eventName: tpl.eventName, 
                    instructors: tplInstructors, 
                    time: tpl.time || '', 
                    link: tpl.link || '', 
                    displayName: tpl.displayName || '',
                    activityCategory: tpl.activityCategory || '',
                    capacity: tpl.capacity || 12, 
                    price: tpl.price || '', // è¼‰å…¥åƒ¹æ ¼
                    tags: tpl.tags || { levels: '', types: '', locations: '' },
                    backendColor: tpl.backendColor || '#eff6ff',
                    statusRules: tpl.statusRules || [] // è¼‰å…¥è¦å‰‡
                }); 
            };
            
            const handleEditTemplate = (e, tpl) => { 
                e.stopPropagation(); 
                setNewTemplateData({ 
                    id: tpl.id, 
                    name: tpl.name, 
                    eventName: tpl.eventName, 
                    instructor: tpl.instructor, 
                    time: tpl.time || '', 
                    link: tpl.link || '', 
                    displayName: tpl.displayName || '',
                    activityCategory: tpl.activityCategory || '',
                    capacity: tpl.capacity || 12, 
                    price: tpl.price || '', // è¼‰å…¥åƒ¹æ ¼
                    tags: tpl.tags || { levels: '', types: '', locations: '' },
                    backendColor: tpl.backendColor || '#eff6ff',
                    statusRules: tpl.statusRules || [] // è¼‰å…¥è¦å‰‡
                }); 
                setIsCreatingTemplate(true); 
            };
            
            const toggleDate = (dateStr) => { let newDates = formData.dates.includes(dateStr) ? formData.dates.filter(d => d !== dateStr) : [...formData.dates, dateStr].sort(); setFormData({ ...formData, dates: newDates }); };
            
            const addInstructor = (name) => { const clean = name.trim(); const isResting = formData.dates.some(d => instructorSchedule[d] && instructorSchedule[d].includes(clean)); if (isResting) { if(!confirm(`${clean} åœ¨éƒ¨åˆ†é¸å®šçš„æ—¥æœŸå·²æ’ä¼‘ï¼Œç¢ºå®šè¦æ’å…¥å—ï¼Ÿ`)) return; } if (clean && !formData.instructors.includes(clean)) setFormData({ ...formData, instructors: [...formData.instructors, clean] }); setTempInstructor(''); };
            const removeInstructor = (name) => { setFormData({ ...formData, instructors: formData.instructors.filter(i => i !== name) }); };
            const handleSubmitEvent = () => { if (formData.dates.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ—¥æœŸ"); return; } onSave(formData); };
            
            const handleSaveNewTemplate = () => { 
                if (!newTemplateData.name) { alert("è«‹è¼¸å…¥æ¨¡æ¿åç¨±"); return; } 
                onSaveTemplate(newTemplateData); 
                setIsCreatingTemplate(false); 
                setNewTemplateData({ id: null, name: '', eventName: '', instructor: '', time: '', link: '', displayName: '', activityCategory: '', capacity: 12, price: '', tags: { levels: '', types: '', locations: '' }, backendColor: '#eff6ff', statusRules: [] }); 
            };
            
            const renderCalendar = () => { const year = calendarMonth.getFullYear(); const month = calendarMonth.getMonth(); const daysInMonth = getDaysInMonth(year, month); const firstDay = getFirstDayOfMonth(year, month); const days = Array(firstDay).fill(null).concat([...Array(daysInMonth).keys()].map(i => i + 1)); return ( <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 relative"> <div className="flex justify-between items-center mb-4"> <button onClick={() => setCalendarMonth(new Date(year, month - 1))}><Icon name="chevron-left" size={20}/></button> <span className="font-bold text-slate-700">{year}å¹´ {month + 1}æœˆ</span> <button onClick={() => setCalendarMonth(new Date(year, month + 1))}><Icon name="chevron-right" size={20}/></button> </div> <div className="grid grid-cols-7 text-center mb-2 text-xs font-bold text-slate-400">{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><div key={d}>{d}</div>)}</div> <div className="grid grid-cols-7 gap-1"> {days.map((day, i) => {
                const dateStr = day ? `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}` : '';
                return ( <div key={i} className="aspect-square flex items-center justify-center"> {day && (<button onClick={() => toggleDate(dateStr)} className={`w-8 h-8 rounded-full text-sm transition-all ${formData.dates.includes(dateStr) ? 'bg-blue-600 text-white shadow-md' : 'hover:bg-blue-100 text-slate-600'}`}>{day}</button>)} </div> ); 
            })} </div> </div> ); };
            
            return ( <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 fade-in backdrop-blur-sm"> 
                <div className="bg-white rounded-2xl w-full max-w-lg flex flex-col max-h-[90vh] shadow-2xl m-auto relative"> 
                    
                    <div className="p-6 border-b border-slate-100 flex justify-between items-center"><h3 className="text-xl font-bold flex items-center gap-2"><Icon name="zap" className="text-yellow-500"/> å¿«é€Ÿé–‹åœ˜</h3><button onClick={onClose}><Icon name="x" className="text-slate-400"/></button></div> 
                    <div className="p-6 overflow-y-auto space-y-6 custom-scrollbar"> 
                        {!isCreatingTemplate ? ( 
                        <> 
                            <div className="flex bg-slate-100 p-1 rounded-lg"><button onClick={()=>setMode('template')} className={`flex-1 py-1.5 text-sm rounded-md transition-all ${mode==='template'?'bg-white shadow text-blue-600':'text-slate-500'}`}>ä½¿ç”¨æ¨¡æ¿</button><button onClick={()=>setMode('custom')} className={`flex-1 py-1.5 text-sm rounded-md transition-all ${mode==='custom'?'bg-white shadow text-blue-600':'text-slate-500'}`}>å®Œå…¨è‡ªè¨‚</button></div> 
                            {mode === 'template' && ( 
                                <div className="grid grid-cols-3 sm:grid-cols-4 gap-2"> 
                                    {customTemplates.length === 0 && <div className="col-span-full text-center text-slate-400 text-xs py-2">ç„¡æ¨¡æ¿</div>} 
                                    {[...customTemplates].map((tpl, i) => ( 
                                        <div key={i} onClick={()=>handleTemplateSelect(tpl)} className={`relative border rounded-lg p-1.5 cursor-pointer text-center hover:shadow-sm transition-all ${formData.eventName===tpl.eventName?'border-blue-500 ring-2 ring-blue-100 bg-blue-50':'border-slate-200 bg-white'}`} style={formData.eventName===tpl.eventName ? {borderColor: tpl.backendColor} : {}}> 
                                            <div className="font-bold text-slate-700 text-[11px] truncate mb-0.5">{tpl.name}</div>
                                            <div className="text-[9px] text-slate-400 truncate">{tpl.instructor}</div>
                                            <button onClick={(e)=>{e.stopPropagation(); handleEditTemplate(e, tpl)}} className="absolute -top-1 -right-1 p-0.5 bg-slate-100 rounded-full text-slate-400 hover:text-blue-500 border border-white"><Icon name="edit-2" size={8}/></button> 
                                        </div> 
                                    ))} 
                                    <button onClick={()=>setIsCreatingTemplate(true)} className="border border-dashed border-slate-300 rounded-lg p-1.5 flex flex-col items-center justify-center text-slate-400 hover:border-blue-400 hover:bg-blue-50 transition-all">
                                        <Icon name="plus" size={12}/><span className="text-[10px]">æ–°å¢æ¨¡æ¿</span>
                                    </button> 
                                </div> 
                            )}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 pt-3 border-t border-slate-100"> 
                                <div><label className="block text-sm font-medium text-slate-700 mb-2">1. é¸æ“‡æ—¥æœŸ</label>{renderCalendar()}</div> 
                                <div className="space-y-4"> 
                                    <div><label className="block text-sm font-medium text-slate-700 mb-1">2. æ´»å‹•åç¨±</label><input type="text" className="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" value={formData.eventName} onChange={e=>setFormData({...formData, eventName: e.target.value})} placeholder="è¼¸å…¥åç¨±..."/></div> 
                                    <div> <label className="block text-sm font-medium text-slate-700 mb-1">3. ä¸»è¬›</label> <div className="flex flex-wrap gap-2 mb-2 min-h-[38px] p-2 bg-white border border-slate-200 rounded-lg">{formData.instructors.map(ins=><div key={ins} className="flex items-center bg-blue-50 text-blue-700 px-2 py-1 rounded text-sm"><span className="mr-1">{ins}</span><button onClick={()=>setFormData({...formData, instructors: formData.instructors.filter(i=>i!==ins)})}><Icon name="x" size={14}/></button></div>)}</div> <div className="flex gap-2"><input type="text" className="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500" value={tempInstructor} onChange={e=>setTempInstructor(e.target.value)} onKeyDown={e=>e.key==='Enter'&&addInstructor(tempInstructor)} placeholder="è¼¸å…¥åå­—..."/><button onClick={()=>addInstructor(tempInstructor)} className="px-3 bg-slate-100 rounded-lg hover:bg-slate-200"><Icon name="plus" size={18}/></button></div> <div className="flex flex-wrap gap-2 mt-2">{availableInstructors.slice(0,6).map(i=><button key={i} onClick={()=>addInstructor(i)} className={`text-xs px-2 py-1 border rounded-full transition ${unavailableInstructors.has(i)?'bg-slate-100 text-slate-400 border-slate-200':'bg-slate-50 hover:bg-blue-50 text-slate-600'}`}>+ {i}</button>)}</div> </div> 
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="block text-sm font-medium text-slate-700 mb-1">4. æ´»å‹•æ™‚é–“</label><input type="time" className="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" value={formData.time} onChange={e=>setFormData({...formData, time: e.target.value})}/></div> 
                                        <div><label className="block text-sm font-medium text-slate-700 mb-1">äººæ•¸ä¸Šé™</label><input type="number" className="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" value={formData.capacity} onChange={e=>setFormData({...formData, capacity: e.target.value})}/></div> 
                                    </div>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div><label className="block text-sm font-medium text-slate-700 mb-1">5. é è¨­åƒ¹æ ¼</label><input type="number" className="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="0" value={formData.price} onChange={e=>setFormData({...formData, price: e.target.value})}/></div>
                                        <div><label className="block text-sm font-medium text-slate-700 mb-1">å¾Œå°é¡è‰²</label><input type="color" className="w-full h-[40px] p-1 border border-slate-300 rounded-lg cursor-pointer" value={formData.backendColor} onChange={e=>setFormData({...formData, backendColor: e.target.value})} title="æ­¤é¡è‰²åƒ…åœ¨å¾Œå°å¯è¦‹"/></div>
                                    </div>
                                    <div><label className="block text-sm font-medium text-slate-700 mb-1">6. æ´»å‹•ç¶²å€</label><input type="text" className="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://..." value={formData.link} onChange={e=>setFormData({...formData, link: e.target.value})}/></div> 
                                    <div><label className="block text-sm font-medium text-slate-700 mb-1">7. å‰å°é¡¯ç¤ºåç¨± (é¸å¡«)</label><input type="text" className="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾‹å¦‚: å†¬å­£å¤œè¨ªè›™é¡" value={formData.displayName} onChange={e=>setFormData({...formData, displayName: e.target.value})}/></div>
                                    <div><label className="block text-sm font-medium text-indigo-600 mb-1">8. æ´»å‹•æ€§è³ªåç¨± (é¸å¡«)</label><input type="text" className="w-full px-3 py-2 border border-indigo-200 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500 bg-indigo-50/20" placeholder="ä¾‹å¦‚: è±¡å±±å¤œé–“å°è¦½" value={formData.activityCategory} onChange={e=>setFormData({...formData, activityCategory: e.target.value})}/></div>
                                    
                                    <div className="bg-slate-50 p-2 rounded-lg border border-slate-200">
    <label className="text-xs font-bold text-slate-500 mb-2 block">9. é è¨­æ´»å‹•æ¨™ç±¤</label>
    <TagSelector definitions={tagDefinitions} value={formData.tags} onChange={(type, val) => setFormData({...formData, tags: {...formData.tags, [type]: val}})} onAddTag={onAddTag} />
</div>

{/* --- æ–°å¢ï¼šå¿«é€Ÿé–‹åœ˜ä»‹é¢é¡¯ç¤ºç‹€æ…‹è¦å‰‡ (UI) --- */}
<div className="bg-white border border-slate-200 rounded-lg p-3">
    <label className="text-xs font-bold text-slate-500 mb-2 block flex justify-between">
        <span>10. è‡ªå®šç¾©ç‹€æ…‹è¦å‰‡ (ä¾ç…§äººæ•¸é¡¯ç¤º)</span>
        <span className="text-[10px] bg-slate-100 px-1 rounded font-normal">å¾ä¸Šåˆ°ä¸‹åŒ¹é…</span>
    </label>
    <div className="space-y-2 mb-3">
        {(formData.statusRules || []).map((rule, idx) => (
            <div key={idx} className="flex items-center gap-2 text-xs">
                <span className="w-12 text-center bg-slate-100 rounded py-1">{rule.min}-{rule.max}äºº</span>
                <span className={`flex-1 px-2 py-1 rounded border text-center ${COLOR_OPTIONS.find(c=>c.value===rule.color)?.bg} ${COLOR_OPTIONS.find(c=>c.value===rule.color)?.text}`}>{rule.label}</span>
                <button onClick={()=>removeFormRule(idx)} className="text-slate-400 hover:text-red-500"><Icon name="trash-2" size={14}/></button>
            </div>
        ))}
    </div>
    <div className="grid grid-cols-4 gap-2 items-end bg-slate-50 p-2 rounded border border-slate-100">
        <div><span className="text-[10px] text-slate-400">Min</span><input type="number" className="w-full p-1 text-xs border rounded" value={newRule.min} onChange={e=>setNewRule({...newRule, min: e.target.value})}/></div>
        <div><span className="text-[10px] text-slate-400">Max</span><input type="number" className="w-full p-1 text-xs border rounded" value={newRule.max} onChange={e=>setNewRule({...newRule, max: e.target.value})}/></div>
        <div className="col-span-2"><span className="text-[10px] text-slate-400">é¡¯ç¤ºæ–‡å­—</span><input type="text" className="w-full p-1 text-xs border rounded" placeholder="å¦‚: å ±åä¸­" value={newRule.label} onChange={e=>setNewRule({...newRule, label: e.target.value})}/></div>
        <div className="col-span-2"><span className="text-[10px] text-slate-400">é¡è‰²</span><select className="w-full p-1 text-xs border rounded" value={newRule.color} onChange={e=>setNewRule({...newRule, color: e.target.value})}>{COLOR_OPTIONS.map(c=><option key={c.value} value={c.value}>{c.label}</option>)}</select></div>
        <div className="col-span-2"><button onClick={addFormRule} className="w-full py-1 bg-slate-800 text-white text-xs rounded hover:bg-slate-700">æ–°å¢è¦å‰‡</button></div>
    </div>
</div>
{/* ------------------------------------------- */}
                                </div> 
                            </div> 
                        </> 
                        ) : ( 
                        <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-3"> 
                            <div className="flex justify-between"><h4 className="font-bold">{newTemplateData.id ? 'ç·¨è¼¯æ¨¡æ¿' : 'å»ºç«‹æ–°æ¨¡æ¿'}</h4><button onClick={()=>{setIsCreatingTemplate(false);setNewTemplateData({id:null,name:'',eventName:'',instructor:'',time:'',link:'',displayName:'', activityCategory: '', capacity: 12, price: '', tags: { levels: '', types: '', locations: '' }, backendColor: '#eff6ff', statusRules: []})}} className="text-sm text-slate-500">å–æ¶ˆ</button></div> 
                            <input type="text" className="w-full px-3 py-2 text-sm border rounded-lg" placeholder="æ¨¡æ¿åç¨± (å¦‚: è±ªè¯åœ˜)" value={newTemplateData.name} onChange={e=>setNewTemplateData({...newTemplateData, name: e.target.value})}/> 
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3"> 
                                <input type="text" className="w-full px-3 py-2 text-sm border rounded-lg" placeholder="é è¨­æ´»å‹•åç¨±" value={newTemplateData.eventName} onChange={e=>setNewTemplateData({...newTemplateData, eventName: e.target.value})}/> 
                                <input type="text" className="w-full px-3 py-2 text-sm border rounded-lg" placeholder="é è¨­è¬›å¸«" value={newTemplateData.instructor} onChange={e=>setNewTemplateData({...newTemplateData, instructor: e.target.value})}/> 
                            </div> 
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">é è¨­æ™‚é–“</label><input type="time" className="w-full px-3 py-2 text-sm border rounded-lg" value={newTemplateData.time} onChange={e=>setNewTemplateData({...newTemplateData, time: e.target.value})}/></div>
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">é è¨­äººæ•¸</label><input type="number" className="w-full px-3 py-2 text-sm border rounded-lg" value={newTemplateData.capacity} onChange={e=>setNewTemplateData({...newTemplateData, capacity: e.target.value})}/></div>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">é è¨­åƒ¹æ ¼ (Ræ¬„)</label><input type="number" className="w-full px-3 py-2 text-sm border rounded-lg" placeholder="900" value={newTemplateData.price} onChange={e=>setNewTemplateData({...newTemplateData, price: e.target.value})}/></div>
                                <div><label className="block text-xs font-bold text-slate-500 mb-1">å¾Œå°é¡è‰²</label><input type="color" className="w-full h-[36px] p-1 border rounded-lg cursor-pointer" value={newTemplateData.backendColor} onChange={e=>setNewTemplateData({...newTemplateData, backendColor: e.target.value})}/></div>
                            </div>
                            <div><label className="block text-xs font-bold text-slate-500 mb-1">é è¨­ç¶²å€</label><input type="text" className="w-full px-3 py-2 text-sm border rounded-lg" placeholder="https://..." value={newTemplateData.link} onChange={e=>setNewTemplateData({...newTemplateData, link: e.target.value})}/></div>
                            <div><label className="block text-xs font-bold text-slate-500 mb-1">é è¨­å‰å°åç¨±</label><input type="text" className="w-full px-3 py-2 text-sm border rounded-lg" placeholder="ä¾‹å¦‚: å†¬å­£å¤œè¨ªè›™é¡" value={newTemplateData.displayName} onChange={e=>setNewTemplateData({...newTemplateData, displayName: e.target.value})}/></div>
                            <div><label className="block text-xs font-bold text-indigo-600 mb-1">é è¨­æ€§è³ªåç¨±</label><input type="text" className="w-full px-3 py-2 text-sm border rounded-lg border-indigo-200 bg-indigo-50/20" placeholder="ä¾‹å¦‚: è±¡å±±å¤œé–“å°è¦½" value={newTemplateData.activityCategory} onChange={e=>setNewTemplateData({...newTemplateData, activityCategory: e.target.value})}/></div>
                            
                            <div className="bg-white p-2 rounded-lg border border-slate-200">
                                <label className="text-xs font-bold text-slate-500 mb-2 block">é è¨­æ´»å‹•æ¨™ç±¤</label>
                                <TagSelector definitions={tagDefinitions} value={newTemplateData.tags} onChange={(type, val) => setNewTemplateData({...newTemplateData, tags: {...newTemplateData.tags, [type]: val}})} onAddTag={onAddTag} />
                            </div>

                            {/* --- æ–°å¢ï¼šè‡ªå®šç¾©ç‹€æ…‹è¦å‰‡ --- */}
                            <div className="bg-white border border-slate-200 rounded-lg p-3">
                                <label className="text-xs font-bold text-slate-500 mb-2 block flex justify-between">
                                    <span>é è¨­ç‹€æ…‹è¦å‰‡ (ä¾ç…§äººæ•¸é¡¯ç¤º)</span>
                                    <span className="text-[10px] bg-slate-100 px-1 rounded font-normal">å¾ä¸Šåˆ°ä¸‹åŒ¹é…</span>
                                </label>
                                <div className="space-y-2 mb-3">
                                    {(newTemplateData.statusRules || []).map((rule, idx) => (
                                        <div key={idx} className="flex items-center gap-2 text-xs">
                                            <span className="w-12 text-center bg-slate-100 rounded py-1">{rule.min}-{rule.max}äºº</span>
                                            <span className={`flex-1 px-2 py-1 rounded border text-center ${COLOR_OPTIONS.find(c=>c.value===rule.color)?.bg} ${COLOR_OPTIONS.find(c=>c.value===rule.color)?.text}`}>{rule.label}</span>
                                            <button onClick={()=>removeTemplateRule(idx)} className="text-slate-400 hover:text-red-500"><Icon name="trash-2" size={14}/></button>
                                        </div>
                                    ))}
                                </div>
                                <div className="grid grid-cols-4 gap-2 items-end bg-slate-50 p-2 rounded border border-slate-100">
                                    <div><span className="text-[10px] text-slate-400">Min</span><input type="number" className="w-full p-1 text-xs border rounded" value={newRule.min} onChange={e=>setNewRule({...newRule, min: e.target.value})}/></div>
                                    <div><span className="text-[10px] text-slate-400">Max</span><input type="number" className="w-full p-1 text-xs border rounded" value={newRule.max} onChange={e=>setNewRule({...newRule, max: e.target.value})}/></div>
                                    <div className="col-span-2"><span className="text-[10px] text-slate-400">é¡¯ç¤ºæ–‡å­—</span><input type="text" className="w-full p-1 text-xs border rounded" placeholder="å¦‚: å ±åä¸­" value={newRule.label} onChange={e=>setNewRule({...newRule, label: e.target.value})}/></div>
                                    <div className="col-span-2"><span className="text-[10px] text-slate-400">é¡è‰²</span><select className="w-full p-1 text-xs border rounded" value={newRule.color} onChange={e=>setNewRule({...newRule, color: e.target.value})}>{COLOR_OPTIONS.map(c=><option key={c.value} value={c.value}>{c.label}</option>)}</select></div>
                                    <div className="col-span-2"><button onClick={addTemplateRule} className="w-full py-1 bg-slate-800 text-white text-xs rounded hover:bg-slate-700">æ–°å¢è¦å‰‡</button></div>
                                </div>
                            </div>
                            {/* ---------------------------- */}

                            <div className="flex gap-2">{newTemplateData.id && <button onClick={()=>{if(confirm("ç¢ºå®šåˆªé™¤?")){onDeleteTemplate(newTemplateData.id);setIsCreatingTemplate(false);setNewTemplateData({id:null,name:'',eventName:'',instructor:'',time:'',link:'',displayName:'', activityCategory: '', capacity: 12, price: '', tags: { levels: '', types: '', locations: '' }, backendColor: '#eff6ff', statusRules: []})}}} className="flex-1 py-2 bg-red-100 text-red-600 rounded-lg text-sm">åˆªé™¤</button>}<button onClick={handleSaveNewTemplate} className="flex-[2] py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">å„²å­˜æ¨¡æ¿</button></div> 
                        </div> 
                        )} 
                    </div> 
                    {!isCreatingTemplate && <div className="p-4 border-t border-slate-100 flex justify-end items-center gap-4 bg-slate-50/50 rounded-b-2xl"><span className="text-xs text-slate-500">å°‡å»ºç«‹ {formData.dates.length} å ´æ´»å‹•</span><button onClick={()=>{ if(formData.dates.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ—¥æœŸï¼"); return; } onSave(formData); }} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md">æ‰¹é‡å»ºç«‹</button></div>} 
                </div> 
            </div> );
        };
        const TaskDetailModal = ({ task, eventData, onClose }) => { return <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-lg flex flex-col max-h-[90vh] shadow-2xl"><div className="p-6 border-b flex justify-between items-center"><div><div className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded inline-block mb-1">{eventData.date}</div><h3 className="text-xl font-bold">{task.name}</h3></div><button onClick={onClose}><Icon name="x"/></button></div><div className="p-6 overflow-y-auto"><div className="text-center text-slate-500 py-8">ä»»å‹™è©³ç´°å…§å®¹åŠŸèƒ½å€ (å¯åœ¨æ­¤æ“´å……)</div></div></div></div>; };
        const MonthlyReport = ({ month, data }) => { const [expanded, setExpanded] = useState(false); const stats = useMemo(() => { const rev = data.reduce((a,c)=>a+c.price,0); const pax = data.length; const sources = {}; const activities = {}; data.forEach(c => { 
            const rawSrc = c.source || 'æœªçŸ¥';
            const srcParts = rawSrc.split(/\s+/).filter(s => s.trim().length > 0);
            if (srcParts.length === 0) srcParts.push('æœªçŸ¥');
            srcParts.forEach(s => {
                sources[s] = (sources[s] || 0) + 1;
            });
            
            if (!activities[c.eventName]) { activities[c.eventName] = { count: 0, revenue: 0, dates: new Set() }; } activities[c.eventName].count += 1; activities[c.eventName].revenue += c.price; if (c.date) activities[c.eventName].dates.add(c.date + c.instructor); }); return { rev, pax, sources, activities }; }, [data]); return ( <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-4 transition-all"> <div className="p-4 flex justify-between items-center cursor-pointer hover:bg-slate-50" onClick={()=>setExpanded(!expanded)}> <div className="flex items-center gap-4"> <div className="text-lg font-bold text-slate-700">{month}</div> <div className="text-sm text-slate-500 bg-slate-100 px-2 py-0.5 rounded">ç¸½æ”¶ ${stats.rev.toLocaleString()}</div> <div className="text-sm text-slate-500">({stats.pax} äºº)</div> </div> <Icon name={expanded ? 'chevron-up' : 'chevron-down'} className="text-slate-400"/> </div> {expanded && ( <div className="p-4 border-t border-slate-100 bg-slate-50/50 animate-in fade-in space-y-6"> <div> <h5 className="text-xs font-bold text-slate-500 mb-3 uppercase flex items-center"><Icon name="activity" size={14} className="mr-1"/> å„é …æ´»å‹•è¡¨ç¾</h5> <div className="bg-white border border-slate-200 rounded-xl overflow-hidden"> <table className="w-full text-left text-sm"> <thead className="bg-slate-50 border-b border-slate-100 text-slate-500"><tr><th className="px-4 py-2">æ´»å‹•åç¨±</th><th className="px-4 py-2">å ´æ¬¡</th><th className="px-4 py-2">äººæ•¸</th><th className="px-4 py-2">å¹³å‡äººæ•¸</th><th className="px-4 py-2 text-right">ç‡Ÿæ”¶</th></tr></thead> <tbody className="divide-y divide-slate-100"> {Object.entries(stats.activities).map(([name, s], i) => { const sessionCount = s.dates.size || 1; return (<tr key={i} className="hover:bg-slate-50"><td className="px-4 py-2 font-medium text-slate-700">{name}</td><td className="px-4 py-2 text-slate-500">{sessionCount}</td><td className="px-4 py-2 text-slate-500">{s.count}</td><td className="px-4 py-2 text-slate-500">{(s.count / sessionCount).toFixed(1)}</td><td className="px-4 py-2 text-right font-mono text-slate-600">${s.revenue.toLocaleString()}</td></tr>); })} </tbody> </table> </div> </div> <div> <h5 className="text-xs font-bold text-slate-500 mb-2 uppercase flex items-center"><Icon name="share-2" size={14} className="mr-1"/> å ±åç®¡é“åˆ†æ</h5> <div className="flex flex-wrap gap-2">{Object.entries(stats.sources).map(([src, count]) => (<div key={src} className="text-xs px-3 py-1.5 bg-white border rounded-lg shadow-sm flex gap-2"><span className="text-slate-600">{src}</span><span className="font-bold text-blue-600">{count}</span><span className="text-slate-400">({Math.round(count/stats.pax*100)}%)</span></div>))}</div> </div> <div className="flex justify-end pt-2"><button onClick={(e)=>{e.stopPropagation(); downloadCSV(data.map(d=>Object.values(d).join(',')).join('\n'), `${month}_report.csv`)}} className="text-xs text-blue-600 hover:underline flex items-center bg-blue-50 px-3 py-1.5 rounded border border-blue-100"><Icon name="download" size={12} className="mr-1"/> ä¸‹è¼‰æ­¤æœˆè©³ç´°å ±è¡¨</button></div> </div> )} </div> ); };
        
        const TimeAnalysisModal = ({ title, data, onClose }) => {
            const [selectedYear, setSelectedYear] = useState(null);
            const [selectedMonth, setSelectedMonth] = useState(null); 

            const handleYearClick = (year) => {
                if (selectedYear === year) {
                    setSelectedYear(null); 
                    setSelectedMonth(null); 
                } else {
                    setSelectedYear(year);
                    setSelectedMonth(null); 
                }
            };

            const handleMonthClick = (idx) => {
                if (selectedMonth === idx) {
                    setSelectedMonth(null);
                } else {
                    setSelectedMonth(idx);
                }
            };

            const resetFilters = () => {
                setSelectedYear(null);
                setSelectedMonth(null);
            };

            const yearStats = useMemo(() => {
                const stats = {};
                let max = 0;
                data.forEach(row => {
                    if (!row.date || row.customerName === 'é–‹æ”¾å ±åä¸­') return;
                    const d = new Date(row.date);
                    if (isNaN(d.getTime())) return;
                    const y = d.getFullYear();
                    const price = Number(row.price) || 0;

                    if (!stats[y]) stats[y] = { count: 0, revenue: 0 };
                    stats[y].count += 1;
                    stats[y].revenue += price;
                    if (stats[y].revenue > max) max = stats[y].revenue;
                });
                return { data: stats, max };
            }, [data]);

            const monthStats = useMemo(() => {
                const stats = Array(12).fill(0).map(() => ({ count: 0, revenue: 0 }));
                let max = 0;
                
                data.forEach(row => {
                    if (!row.date || row.customerName === 'é–‹æ”¾å ±åä¸­') return;
                    const d = new Date(row.date);
                    if (isNaN(d.getTime())) return;
                    
                    if (selectedYear !== null && d.getFullYear() !== selectedYear) return;

                    const m = d.getMonth();
                    const price = Number(row.price) || 0;
                    
                    stats[m].count += 1;
                    stats[m].revenue += price;
                    if (stats[m].revenue > max) max = stats[m].revenue;
                });
                return { data: stats, max };
            }, [data, selectedYear]);

            const weekStats = useMemo(() => {
                const stats = Array(7).fill(0).map(() => ({ count: 0, revenue: 0 }));
                let max = 0;

                data.forEach(row => {
                    if (!row.date || row.customerName === 'é–‹æ”¾å ±åä¸­') return;
                    const d = new Date(row.date);
                    if (isNaN(d.getTime())) return;

                    if (selectedYear !== null && d.getFullYear() !== selectedYear) return;
                    if (selectedMonth !== null && d.getMonth() !== selectedMonth) return;

                    const w = d.getDay();
                    const price = Number(row.price) || 0;

                    stats[w].count += 1;
                    stats[w].revenue += price;
                    if (stats[w].revenue > max) max = stats[w].revenue;
                });
                return { data: stats, max };
            }, [data, selectedYear, selectedMonth]);

            const weekdayNames = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];

            const renderBar = (label, value, count, max, baseColorClass, isSelected, onClick) => {
                const percent = max > 0 ? (value / max) * 100 : 0;
                const activeColor = isSelected ? baseColorClass.replace('500', '700') : baseColorClass;
                const containerClass = isSelected 
                    ? "bg-slate-100 ring-1 ring-slate-300" 
                    : "hover:bg-slate-50"; 

                return (
                    <div 
                        onClick={onClick}
                        className={`flex items-center gap-4 py-2 px-2 rounded-lg cursor-pointer transition-all ${containerClass}`}
                    >
                        <div className={`w-14 text-sm font-bold text-right shrink-0 ${isSelected ? 'text-slate-900 underline' : 'text-slate-600'}`}>{label}</div>
                        <div className="flex-1">
                            <div className="flex justify-between text-xs mb-1">
                                <span className={`font-bold ${isSelected ? 'text-slate-900' : 'text-slate-700'}`}>${value.toLocaleString()}</span>
                                <span className="text-slate-400">{count} äºº</span>
                            </div>
                            <div className="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                                <div className={`h-full rounded-full transition-all duration-500 ${activeColor}`} style={{ width: `${percent}%` }}></div>
                            </div>
                        </div>
                        {isSelected && <Icon name="check-circle" size={14} className="text-slate-400 shrink-0"/>}
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-[90] flex items-center justify-center p-4 fade-in backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white rounded-2xl w-full max-w-5xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-6 pb-4 border-b">
                            <div>
                                <h3 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                    <Icon name="bar-chart-2" className="text-blue-600"/> æ™‚é–“ç¶­åº¦éŠ·å”®åˆ†æ
                                </h3>
                                <div className="flex items-center gap-2 mt-1 text-sm text-slate-500">
                                    <span>ç›®å‰æª¢è¦–ï¼š</span>
                                    <span className={`px-2 py-0.5 rounded font-bold ${selectedYear ? 'bg-blue-100 text-blue-700' : 'bg-slate-100'}`}>
                                        {selectedYear ? `${selectedYear}å¹´` : 'æ‰€æœ‰å¹´ä»½'}
                                    </span>
                                    <Icon name="chevron-right" size={12}/>
                                    <span className={`px-2 py-0.5 rounded font-bold ${selectedMonth !== null ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100'}`}>
                                        {selectedMonth !== null ? `${selectedMonth + 1}æœˆ` : 'å…¨å¹´'}
                                    </span>
                                    {(selectedYear !== null || selectedMonth !== null) && (
                                        <button onClick={resetFilters} className="ml-2 text-xs text-red-500 hover:underline flex items-center gap-1">
                                            <Icon name="x-circle" size={12}/> é‡ç½®
                                        </button>
                                    )}
                                </div>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full"><Icon name="x" className="text-slate-400"/></button>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col h-full">
                                <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2 pb-2 border-b border-slate-100">
                                    <div className="bg-blue-100 p-1.5 rounded text-blue-600"><Icon name="calendar" size={16}/></div> 
                                    å¹´ä»½è¡¨ç¾ (é»æ“Šç¯©é¸)
                                </h4>
                                <div className="space-y-1 overflow-y-auto flex-1 custom-scrollbar max-h-[400px]">
                                    {Object.keys(yearStats.data).sort().map(year => {
                                        const y = parseInt(year);
                                        return (
                                            <div key={y}>
                                                {renderBar(
                                                    y, 
                                                    yearStats.data[y].revenue, 
                                                    yearStats.data[y].count, 
                                                    yearStats.max, 
                                                    'bg-blue-500', 
                                                    selectedYear === y,
                                                    () => handleYearClick(y)
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col h-full">
                                <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2 pb-2 border-b border-slate-100">
                                    <div className="bg-emerald-100 p-1.5 rounded text-emerald-600"><Icon name="moon" size={16}/></div> 
                                    æœˆä»½æ·¡æ—ºå­£ (é»æ“Šç¯©é¸)
                                </h4>
                                <div className="space-y-1 overflow-y-auto flex-1 custom-scrollbar max-h-[400px]">
                                    {monthStats.data.map((d, idx) => (
                                        <div key={idx}>
                                            {renderBar(
                                                `${idx + 1}æœˆ`, 
                                                d.revenue, 
                                                d.count, 
                                                monthStats.max, 
                                                'bg-emerald-500', 
                                                selectedMonth === idx,
                                                () => handleMonthClick(idx)
                                            )}
                                        </div>
                                    ))}
                                    {monthStats.max === 0 && <div className="text-center text-slate-400 py-10">è©²å¹´ä»½ç„¡æ•¸æ“š</div>}
                                </div>
                            </div>

                            <div className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col h-full">
                                <h4 className="font-bold text-slate-700 mb-4 flex items-center gap-2 pb-2 border-b border-slate-100">
                                    <div className="bg-purple-100 p-1.5 rounded text-purple-600"><Icon name="sun" size={16}/></div> 
                                    æ˜ŸæœŸåˆ†ä½ˆ (çµæœ)
                                </h4>
                                <div className="space-y-1 overflow-y-auto flex-1 custom-scrollbar max-h-[400px]">
                                    {weekStats.data.map((d, idx) => (
                                        <div key={idx}>
                                            {renderBar(
                                                weekdayNames[idx], 
                                                d.revenue, 
                                                d.count, 
                                                weekStats.max, 
                                                'bg-purple-500',
                                                false, 
                                                null
                                            )}
                                        </div>
                                    ))}
                                    {weekStats.max === 0 && <div className="text-center text-slate-400 py-10">ç„¡ç¬¦åˆæ•¸æ“š</div>}
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        };
        const ActivityPerformance = ({ parsedData, eventConfigs }) => {
            const [dimension, setDimension] = useState('category');
            const [analysisData, setAnalysisData] = useState(null); 

    const loyaltyMetrics = useMemo(() => {
        if (!parsedData || parsedData.length === 0) return { rate: "0.0", heavyRate: "0.0", total: 0 };
        const counts = {};
        parsedData.forEach((r) => {
            const name = r.customerName || r['å§“å'];
            if(name && name !== 'é–‹æ”¾å ±åä¸­') {
                counts[name] = (counts[name] || 0) + 1;
            }
        });
        const total = Object.keys(counts).length;
        const repeat = Object.values(counts).filter((c) => c > 1).length;
        const heavy = Object.values(counts).filter((c) => c >= 3).length;
        
        return {
            rate: total > 0 ? ((repeat / total) * 100).toFixed(1) : "0.0",
            heavyRate: total > 0 ? ((heavy / total) * 100).toFixed(1) : "0.0",
            total: total
        };
    }, [parsedData]);

            const activityStats = useMemo(() => {
                const stats = {};
                parsedData.forEach(row => {
                    if (row.customerName === 'é–‹æ”¾å ±åä¸­') return;
                    
                    const sortedInstr = row.instructor ? row.instructor.split(/[&,]/).map(s=>s.trim()).sort().join(' & ') : '';
                    const rowKey = `${row.date}_${row.eventName}_${sortedInstr}`.replace(/[\/\\#\?]/g, '-');
                    const config = eventConfigs[rowKey] || {};
                    const tags = config.tags || {};
                    
                    let groupName = 'æœªåˆ†é¡';

                    if (dimension === 'category') {
                        groupName = config.activityCategory || row.eventName || 'æœªåˆ†é¡';
                    } else if (dimension === 'name') {
                        groupName = row.eventName || 'æœªå‘½åæ´»å‹•';
                    } else if (dimension === 'type') {
                        groupName = tags.types || 'æœªåˆ†é¡';
                    } else if (dimension === 'level') {
                        groupName = tags.levels || 'æœªåˆ†é¡';
                    } else if (dimension === 'location') {
                        groupName = tags.locations || 'æœªåˆ†é¡';
                    }

                    if (!stats[groupName]) stats[groupName] = { revenue: 0, pax: 0, sessions: new Set(), rawRows: [] };
                    stats[groupName].revenue += (row.price || 0);
                    stats[groupName].pax += 1;
                    stats[groupName].sessions.add(row.date + row.instructor);
                    stats[groupName].rawRows.push(row); 
                });

                return Object.entries(stats).map(([name, data]) => ({
                    name,
                    revenue: data.revenue,
                    pax: data.pax,
                    sessions: data.sessions.size,
                    avgRev: data.sessions.size > 0 ? Math.round(data.revenue / data.sessions.size) : 0,
                    avgPax: data.sessions.size > 0 ? (data.pax / data.sessions.size).toFixed(1) : 0,
                    arpu: data.pax > 0 ? Math.round(data.revenue / data.pax) : 0,
                    rawRows: data.rawRows
                })).sort((a, b) => b.revenue - a.revenue);
            }, [parsedData, eventConfigs, dimension]);

            const dimensionLabels = {
                category: 'ä¾æ´»å‹•æ€§è³ª (åˆä½µåˆ†æ)',
                name: 'ä¾å¾Œå°åç¨± (åŸå§‹åç¨±)',
                type: 'ä¾æ´»å‹•ç¨®é¡ (æ¨™ç±¤)',
                level: 'ä¾æ´»å‹•ç­‰ç´š (æ¨™ç±¤)',
                location: 'ä¾æ´»å‹•åœ°é» (æ¨™ç±¤)'
            };

            const handleGlobalAnalysis = () => {
                const validRows = parsedData.filter(row => row.customerName !== 'é–‹æ”¾å ±åä¸­');
                setAnalysisData({
                    title: 'æ‰€æœ‰æ´»å‹•ç¸½é«”åˆ†æ',
                    data: validRows
                });
            };

            const handleItemAnalysis = (item) => {
                setAnalysisData({
                    title: `åˆ†æé …ç›®: ${item.name}`,
                    data: item.rawRows
                });
            };

            return (
                <div className="fade-in max-w-6xl mx-auto space-y-8 pb-20">
                    <header className="mb-6 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800">æ´»å‹•æˆæ•ˆåˆ†æ</h2>
                            <p className="text-sm text-slate-500">æ·±å…¥äº†è§£å„é …æ´»å‹•çš„å¸‚å ´è¡¨ç¾èˆ‡è½‰æ›ç‡</p>
                        </div>
                        <div className="flex flex-wrap items-center gap-2">
                             <button onClick={handleGlobalAnalysis} className="bg-slate-800 text-white px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-2 hover:bg-slate-700 shadow-sm"><Icon name="pie-chart" size={14}/> ç¸½é«”æ™‚é–“åˆ†æ</button>
                             <div className="flex items-center gap-2 bg-white p-1 rounded-lg border border-slate-200 shadow-sm">
                                <span className="text-xs font-bold text-slate-500 px-2">åˆ†æç¶­åº¦:</span>
                                <select className="text-sm bg-slate-50 border-none rounded-md py-1.5 pl-2 pr-8 focus:ring-2 focus:ring-blue-500 outline-none font-bold text-slate-700 cursor-pointer" value={dimension} onChange={e => setDimension(e.target.value)}>
                                    <option value="category">ä¾æ´»å‹•æ€§è³ª (æ¨è–¦)</option>
                                    <option value="name">ä¾å¾Œå°åç¨±</option>
                                    <option value="type">ä¾ç¨®é¡æ¨™ç±¤ (å¦‚: è›‡é¡ã€å¤œé–“)</option>
                                    <option value="level">ä¾ç­‰ç´šæ¨™ç±¤ (å¦‚: åŒ…åœ˜ã€è¦ªå­)</option>
                                    <option value="location">ä¾åœ°é»æ¨™ç±¤</option>
                                </select>
                            </div>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
                        <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                            <div className="text-xs text-slate-400 font-bold uppercase mb-1">æœ€é«˜ç¸½ç‡Ÿæ”¶é …ç›®</div>
                            <div className="text-lg font-bold text-blue-600 truncate" title={activityStats[0]?.name}>{activityStats[0]?.name || '-'}</div>
                            <div className="text-xs text-slate-500 mt-1">${activityStats[0]?.revenue.toLocaleString() || 0}</div>
                        </div>
                        <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                            <div className="text-xs text-slate-400 font-bold uppercase mb-1">å¹³å‡æ¯å ´ç‡Ÿæ”¶</div>
                            <div className="text-2xl font-bold text-slate-800">${Math.round(activityStats.reduce((a,c)=>a+c.avgRev,0)/Math.max(1, activityStats.length)).toLocaleString()}</div>
                        </div>
                        <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                            <div className="text-xs text-slate-400 font-bold uppercase mb-1">å¹³å‡æ¯å ´äººæ•¸</div>
                            <div className="text-2xl font-bold text-slate-800">{(activityStats.reduce((a,c)=>a+parseFloat(c.avgPax),0)/Math.max(1, activityStats.length)).toFixed(1)} <span className="text-sm font-normal text-slate-400">äºº</span></div>
                        </div>
                        <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                            <div className="text-xs text-slate-400 font-bold uppercase mb-1">å¹³å‡å®¢å–®åƒ¹ (ARPU)</div>
                            <div className="text-2xl font-bold text-emerald-600">${Math.round(activityStats.reduce((a,c)=>a+c.arpu,0)/Math.max(1, activityStats.length)).toLocaleString()}</div>
                        </div>
                        <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow border-l-4 border-l-purple-500 relative group">
                            <div className="text-xs text-slate-400 font-bold uppercase mb-1 flex justify-between items-center">
                                <span>å®¢æˆ¶é»è‘—åº¦</span>
                                <span className="text-[10px] bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full font-medium" title="æ¶ˆè²»3æ¬¡ä»¥ä¸Šçš„é«˜é »å®¢æ¯”ä¾‹">éµç²‰: {loyaltyMetrics.heavyRate}%</span>
                            </div>
                            <div className="flex items-baseline gap-2 mt-1">
                                <div className="text-2xl font-bold text-purple-600">{loyaltyMetrics.rate}%</div>
                                <div className="text-xs text-slate-400 font-medium">(åŸºæ•¸: {loyaltyMetrics.total}äºº)</div>
                            </div>
                        </div>
                    </div> 

                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden table-container">
                         <div className="p-4 bg-slate-50/50 border-b border-slate-100 flex justify-between items-center">
                            <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">{dimensionLabels[dimension]}</span>
                            <span className="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full font-bold">{activityStats.length} é …</span>
                        </div>
                        <table className="w-full text-left text-sm">
                            <thead className="bg-slate-50 border-b border-slate-100 text-slate-500">
                                <tr>
                                    <th className="px-6 py-4 font-bold">é …ç›®åç¨±</th>
                                    <th className="px-6 py-4 font-bold text-right">èˆ‰è¾¦å ´æ¬¡</th>
                                    <th className="px-6 py-4 font-bold text-right">ç¸½äººæ•¸</th>
                                    <th className="px-6 py-4 font-bold text-right">å¹³å‡äººæ•¸</th>
                                    <th className="px-6 py-4 font-bold text-right">ç¸½ç‡Ÿæ”¶</th>
                                    <th className="px-6 py-4 font-bold text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {activityStats.map((stat, idx) => (
                                    <tr key={idx} className="hover:bg-slate-50 transition-colors group">
                                        <td className="px-6 py-4 font-bold text-slate-700 flex items-center gap-2"><span className="w-6 h-6 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center text-xs shrink-0">{idx + 1}</span>{stat.name}</td>
                                        <td className="px-6 py-4 text-right text-slate-600">{stat.sessions}</td>
                                        <td className="px-6 py-4 text-right text-slate-600">{stat.pax}</td>
                                        <td className="px-6 py-4 text-right"><span className={`px-2 py-1 rounded text-xs font-bold ${stat.avgPax >= 15 ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-600'}`}>{stat.avgPax}</span></td>
                                        <td className="px-6 py-4 text-right font-mono font-bold text-blue-600 bg-blue-50/30 group-hover:bg-blue-50/50">${stat.revenue.toLocaleString()}</td>
                                        <td className="px-6 py-4 text-right">
                                            <button onClick={() => handleItemAnalysis(stat)} className="text-xs bg-white border border-slate-200 text-slate-600 hover:text-blue-600 hover:border-blue-300 px-3 py-1 rounded-lg shadow-sm transition-all flex items-center gap-1 ml-auto">
                                                <Icon name="bar-chart-2" size={14}/> æ™‚é–“åˆ†æ
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                                {activityStats.length === 0 && (<tr><td colSpan="7" className="p-8 text-center text-slate-400">ç›®å‰ç„¡æ•¸æ“š</td></tr>)}
                            </tbody>
                        </table>
                    </div>

                    {analysisData && (
                        <TimeAnalysisModal 
                            title={analysisData.title}
                            data={analysisData.data}
                            onClose={() => setAnalysisData(null)}
                        />
                    )}
                </div>
            );
        };
        const EnrollmentMonitor = ({ stats, eventConfigs, tagDefinitions }) => {
            const [filters, setFilters] = useState({ level: '', type: '', location: '' });
            const [sortBy, setSortBy] = useState('date');

            const processedEvents = useMemo(() => {
                const today = new Date().toISOString().split('T')[0];
                
                return Object.values(stats.events)
                    .map(e => {
                        const cfg = eventConfigs[e.key] || {};
                        const capacity = parseInt(cfg.capacity) || 12;
                        const rate = Math.min((e.count / capacity) * 100, 100);
                        const tags = cfg.tags || { levels: '', types: '', locations: '' };
                        const isFull = e.count >= capacity;
                        
                        return { ...e, capacity, rate, tags, isFull, cfg };
                    })
                    .filter(e => {
                        if (e.date < today) return false;
                        if (filters.level && e.tags.levels !== filters.level) return false;
                        if (filters.type && e.tags.types !== filters.type) return false;
                        if (filters.location && e.tags.locations !== filters.location) return false;
                        return true;
                    })
                    .sort((a, b) => {
                        if (sortBy === 'rate') return b.rate - a.rate;
                        return new Date(a.date) - new Date(b.date);
                    });
            }, [stats, eventConfigs, filters, sortBy]);

            const getProgressColor = (rate, isFull) => {
                if (isFull || rate >= 100) return 'bg-red-500';
                if (rate >= 80) return 'bg-orange-500';
                if (rate >= 50) return 'bg-blue-500';
                return 'bg-emerald-500';
            };

            return (
                <div className="fade-in max-w-6xl mx-auto space-y-6 pb-20">
                    <header className="flex flex-col md:flex-row justify-between items-center gap-4">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800">å ±åç›£æ§ä¸­å¿ƒ</h2>
                            <p className="text-sm text-slate-500">å³æ™‚æŒæ¡å„å ´æ¬¡å ±åç‡èˆ‡å‰©é¤˜åé¡</p>
                        </div>
                        <div className="flex bg-slate-100 p-1 rounded-lg">
                            <button onClick={() => setSortBy('date')} className={`px-4 py-1.5 rounded-md text-sm font-bold transition-all ${sortBy === 'date' ? 'bg-white shadow text-slate-800' : 'text-slate-500'}`}>ä¾æ—¥æœŸæ’åº</button>
                            <button onClick={() => setSortBy('rate')} className={`px-4 py-1.5 rounded-md text-sm font-bold transition-all ${sortBy === 'rate' ? 'bg-white shadow text-slate-800' : 'text-slate-500'}`}>ä¾ç†±é–€åº¦æ’åº</button>
                        </div>
                    </header>

                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                        <div className="flex items-center gap-2 mb-3">
                            <Icon name="filter" size={18} className="text-blue-600"/>
                            <span className="font-bold text-slate-700">æ¨™ç±¤ç¯©é¸</span>
                            {(filters.level || filters.type || filters.location) && (
                                <button onClick={() => setFilters({ level: '', type: '', location: '' })} className="text-xs text-red-500 hover:bg-red-50 px-2 py-1 rounded ml-auto flex items-center gap-1">
                                    <Icon name="x" size={12}/> æ¸…é™¤ç¯©é¸
                                </button>
                            )}
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label className="text-xs font-bold text-slate-400 mb-1 block">æ´»å‹•ç­‰ç´š</label>
                                <select className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium outline-none focus:ring-2 focus:ring-blue-500" value={filters.level} onChange={e => setFilters({...filters, level: e.target.value})}>
                                    <option value="">å…¨éƒ¨ç­‰ç´š</option>
                                    {(tagDefinitions.levels || []).map(t => <option key={t} value={t}>{t}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-400 mb-1 block">æ´»å‹•ç¨®é¡</label>
                                <select className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium outline-none focus:ring-2 focus:ring-emerald-500" value={filters.type} onChange={e => setFilters({...filters, type: e.target.value})}>
                                    <option value="">å…¨éƒ¨ç¨®é¡</option>
                                    {(tagDefinitions.types || []).map(t => <option key={t} value={t}>{t}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-400 mb-1 block">æ´»å‹•åœ°é»</label>
                                <select className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium outline-none focus:ring-2 focus:ring-purple-500" value={filters.location} onChange={e => setFilters({...filters, location: e.target.value})}>
                                    <option value="">å…¨éƒ¨åœ°é»</option>
                                    {(tagDefinitions.locations || []).map(t => <option key={t} value={t}>{t}</option>)}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        {processedEvents.map((e, idx) => (
                            <div key={idx} className="bg-white rounded-xl border border-slate-200 shadow-sm hover:shadow-md transition-all p-4 relative overflow-hidden group">
                                <div className="flex justify-between items-start mb-2">
                                    <span className="text-xs font-mono font-bold text-slate-500 bg-slate-100 px-2 py-0.5 rounded">{e.date}</span>
                                    <div className="flex gap-1">
                                        {e.isFull && <span className="text-[10px] font-bold bg-red-100 text-red-600 px-1.5 py-0.5 rounded">é¡æ»¿</span>}
                                        {e.tags.locations && <span className="text-[10px] font-bold bg-purple-50 text-purple-600 px-1.5 py-0.5 rounded border border-purple-100">{e.tags.locations}</span>}
                                    </div>
                                </div>

                                <h3 className="font-bold text-slate-800 mb-1 truncate" title={e.eventName}>{e.cfg.displayName || e.eventName}</h3>
                                <div className="text-xs text-slate-500 mb-4 flex items-center gap-1">
                                    <Icon name="user" size={12}/> {e.instructor || 'æœªå®š'}
                                </div>

                                <div className="mb-2">
                                    <div className="flex justify-between text-xs mb-1">
                                        <span className={`font-bold ${e.isFull ? 'text-red-600' : 'text-slate-700'}`}>
                                            {e.count} <span className="text-slate-400 font-normal">/ {e.capacity}</span>
                                        </span>
                                        <span className="font-bold text-slate-600">{Math.round(e.rate)}%</span>
                                    </div>
                                    <div className="w-full h-2.5 bg-slate-100 rounded-full overflow-hidden">
                                        <div 
                                            className={`h-full rounded-full transition-all duration-500 ${getProgressColor(e.rate, e.isFull)}`} 
                                            style={{ width: `${e.rate}%` }}
                                        ></div>
                                    </div>
                                </div>

                                <div className="flex flex-wrap gap-1 mt-3 pt-3 border-t border-slate-50">
                                    {e.tags.levels && <span className="text-[10px] text-blue-600 bg-blue-50 px-2 py-0.5 rounded">{e.tags.levels}</span>}
                                    {e.tags.types && <span className="text-[10px] text-emerald-600 bg-emerald-50 px-2 py-0.5 rounded">{e.tags.types}</span>}
                                    {!e.tags.levels && !e.tags.types && <span className="text-[10px] text-slate-300 italic">ç„¡æ¨™ç±¤</span>}
                                </div>
                            </div>
                        ))}
                    </div>

                    {processedEvents.length === 0 && (
                        <div className="text-center py-12 bg-white rounded-2xl border border-dashed border-slate-200">
                            <div className="text-4xl mb-2">ğŸ”</div>
                            <p className="text-slate-500">æ²’æœ‰ç¬¦åˆç¯©é¸æ¢ä»¶çš„æœªä¾†æ´»å‹•</p>
                        </div>
                    )}
                </div>
            );
        };
        const EditRowModal = ({ rowData, onClose, onSave, onDelete, existingTransports }) => { 
            const [form, setForm] = useState({ ...rowData }); 
            const toggleTransport = () => {
                setForm(prev => ({ ...prev, transport: prev.transport === 'å…±ä¹˜' ? 'è‡ªè¡Œå‰å¾€' : 'å…±ä¹˜' }));
            };
            return (
                <div className="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
                    <div className="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold">ç·¨è¼¯å ±åè³‡æ–™</h3><button onClick={onClose}><Icon name="x"/></button></div>
                        <div className="space-y-4 max-h-[70vh] overflow-y-auto p-1"> 
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3"><div><label className="text-xs font-bold">æ—¥æœŸ</label><input type="date" className="w-full p-2 border rounded" value={form.date} onChange={e=>setForm({...form, date:e.target.value})}/></div><div><label className="text-xs font-bold">æ´»å‹•åç¨±</label><input type="text" className="w-full p-2 border rounded" value={form.eventName} onChange={e=>setForm({...form, eventName:e.target.value})}/></div></div> 
                            <div><label className="text-xs font-bold">å®¢æˆ¶å§“å</label><input type="text" className="w-full p-2 border rounded" value={form.customerName} onChange={e=>setForm({...form, customerName:e.target.value})}/></div> 
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3"><div><label className="text-xs font-bold">é‡‘é¡</label><input type="number" className="w-full p-2 border rounded" value={form.price} onChange={e=>setForm({...form, price:e.target.value})}/></div><div><label className="text-xs font-bold mb-1.5 block">äº¤é€š</label><div onClick={toggleTransport} className={`w-full p-2 border rounded cursor-pointer flex items-center gap-2 select-none transition-all ${form.transport === 'å…±ä¹˜' ? 'bg-orange-50 border-orange-300 shadow-sm' : 'bg-white border-slate-300 hover:bg-slate-50'}`}><div className={`w-5 h-5 rounded border flex items-center justify-center transition-all flex-shrink-0 ${form.transport === 'å…±ä¹˜' ? 'bg-orange-500 border-orange-500 text-white' : 'bg-white border-slate-300'}`}>{form.transport === 'å…±ä¹˜' && <Icon name="check" size={14} />}</div><span className={`text-sm ${form.transport === 'å…±ä¹˜' ? 'text-orange-700 font-bold' : 'text-slate-500'}`}>{form.transport === 'å…±ä¹˜' ? 'å…±ä¹˜' : 'è‡ªè¡Œå‰å¾€'}</span></div></div></div> 
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3"><div><label className="text-xs font-bold">Email</label><input type="email" className="w-full p-2 border rounded" value={form.email||''} onChange={e=>setForm({...form, email:e.target.value})}/></div><div><label className="text-xs font-bold">æ‰‹æ©Ÿ</label><input type="text" className="w-full p-2 border rounded" value={form.phone||''} onChange={e=>setForm({...form, phone:e.target.value})}/></div></div> 
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3"><div><label className="text-xs font-bold">è¨‚è³¼æ—¥</label><input type="date" className="w-full p-2 border rounded" value={form.orderDate||''} onChange={e=>setForm({...form, orderDate:e.target.value})}/></div><div><label className="text-xs font-bold">èº«åˆ†è­‰</label><input type="text" className="w-full p-2 border rounded" value={form.idNo||''} onChange={e=>setForm({...form, idNo:e.target.value})}/></div></div> 
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3"><div><label className="text-xs font-bold">ç”Ÿæ—¥</label><input type="date" className="w-full p-2 border rounded" value={form.birthday||''} onChange={e=>setForm({...form, birthday:e.target.value})}/></div><div><label className="text-xs font-bold">ç¤¾ç¾¤æš±ç¨±</label><input type="text" className="w-full p-2 border rounded" value={form.socialName||''} onChange={e=>setForm({...form, socialName:e.target.value})}/></div></div> 
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3"><div><label className="text-xs font-bold">å ±åç®¡é“</label><input type="text" className="w-full p-2 border rounded" value={form.source||''} onChange={e=>setForm({...form, source:e.target.value})}/></div><div><label className="text-xs font-bold">å‚™è¨»</label><input type="text" className="w-full p-2 border rounded" value={form.notes||''} onChange={e=>setForm({...form, notes:e.target.value})}/></div></div> 
                        </div>
                        <div className="flex justify-between mt-6 pt-4 border-t border-slate-100">
                            <button onClick={()=>onDelete(rowData.id)} className="px-4 py-2 text-red-500 hover:bg-red-50 rounded-lg flex items-center gap-1 font-bold text-xs"><Icon name="trash-2" size={14}/> åˆªé™¤è³‡æ–™</button>
                            <div className="flex gap-2"><button onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">å–æ¶ˆ</button><button onClick={()=>onSave(form)} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md">å„²å­˜è®Šæ›´</button></div>
                        </div>
                    </div>
                </div>
            ); 
        };
        const BulkImportModal = ({ onClose, onImport, existingData }) => { return <div className="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-2xl h-[85vh] flex flex-col shadow-2xl"><div className="p-6 border-b flex justify-between items-center"><h3 className="text-xl font-bold">æ‰¹é‡åŒ¯å…¥åŠŸèƒ½é–‹ç™¼ä¸­...</h3><button onClick={onClose}><Icon name="x"/></button></div><div className="p-8 text-center text-slate-500">æ­¤åŠŸèƒ½å³å°‡æ¨å‡ºï¼Œæ•¬è«‹æœŸå¾…</div></div></div>; };
        const DataRescueTab = ({ currentAppId, onSwitch }) => { const options = [ { id: 'crm-system-v1', label: 'v1 (æ‚¨çš„çœŸå¯¦è³‡æ–™)' }, { id: 'default-app-id', label: 'Default (èˆŠç‰ˆæ¸¬è©¦)' } ]; return ( <div className="bg-white p-6 rounded-2xl shadow-sm border border-orange-200"> <div className="flex items-start gap-4"> <div className="bg-orange-100 p-3 rounded-full text-orange-600"><Icon name="life-buoy" size={24}/></div> <div className="flex-1"> <h3 className="text-xl font-bold text-slate-800 mb-2">è³‡æ–™åº«æ•‘æ´æ§åˆ¶å°</h3> <p className="text-sm text-slate-500 mb-4">å¦‚æœæ‚¨ç™¼ç¾è³‡æ–™éºå¤±ï¼Œè«‹å˜—è©¦åˆ‡æ›ä¸‹æ–¹çš„è³‡æ–™ä¾†æºã€‚é€™é€šå¸¸ç™¼ç”Ÿåœ¨ç³»çµ±æ›´æ–°å¾Œã€‚</p> <div className="grid grid-cols-1 md:grid-cols-2 gap-4"> {options.map(opt => ( <div key={opt.id} onClick={() => onSwitch(opt.id)} className={`p-4 rounded-xl border cursor-pointer transition-all flex justify-between items-center ${currentAppId === opt.id ? 'bg-orange-50 border-orange-400 ring-1 ring-orange-400' : 'hover:bg-slate-50 border-slate-200'}`} > <div> <div className="font-bold text-slate-700">{opt.label}</div> <div className="text-xs text-slate-400 font-mono">{opt.id}</div> </div> {currentAppId === opt.id && <Icon name="check-circle" className="text-orange-500" size={20}/>} </div> ))} </div> </div> </div> </div> ); };

        const ProjectDetailModal = ({ project, onClose, onUpdate, onDelete }) => {
            const [editName, setEditName] = useState(project.name || '');
            const [editLink, setEditLink] = useState(project.cloudLink || '');
            const [editStatus, setEditStatus] = useState(project.status || 'To Do');
            const [editStakeholders, setEditStakeholders] = useState(project.stakeholders || '');
            const [metrics, setMetrics] = useState(project.metrics || []);
            const [newMetric, setNewMetric] = useState({ name: '', target: '', current: 0, unit: '' });
            const [showMetricForm, setShowMetricForm] = useState(false);
            const [phases, setPhases] = useState(() => {
                if (project.phases && project.phases.length > 0) return project.phases;
                if (project.subTasks && project.subTasks.length > 0) {
                    return [{ id: 'phase_default', name: 'ç¬¬ä¸€éšæ®µï¼šå•Ÿå‹•', tasks: project.subTasks }];
                }
                return [{ id: 'phase_1', name: 'ç¬¬ä¸€éšæ®µï¼šè¦åŠƒ', tasks: [] }];
            });
            const [newTask, setNewTask] = useState({ title: '', assignee: '', dueDate: '', kpiName: '', kpiTarget: '', kpiUnit: '' });
            const [addingToPhaseId, setAddingToPhaseId] = useState(null);
            const [editingTaskInfo, setEditingTaskInfo] = useState(null);
            
            const totalTasks = phases.reduce((acc, p) => acc + p.tasks.length, 0);
            const completedTasks = phases.reduce((acc, p) => acc + p.tasks.filter(t => t.completed).length, 0);
            const metricsProgress = metrics.length > 0 ? metrics.reduce((acc, m) => acc + Math.min((m.current / m.target), 1), 0) / metrics.length : 0;
            const taskProgress = totalTasks > 0 ? completedTasks / totalTasks : 0;
            const xp = Math.round((taskProgress * 0.6 + metricsProgress * 0.4) * 100);
            const level = Math.floor(xp / 20) + 1;

            const addMetric = () => { if (!newMetric.name || !newMetric.target) return alert("è«‹è¼¸å…¥ç›®æ¨™åç¨±èˆ‡æ•¸å€¼"); setMetrics([...metrics, { ...newMetric, id: Date.now(), target: Number(newMetric.target), current: 0 }]); setNewMetric({ name: '', target: '', current: 0, unit: '' }); setShowMetricForm(false); };
            const updateMetricCurrent = (id, val) => { setMetrics(metrics.map(m => m.id === id ? { ...m, current: Number(val) } : m)); };
            const deleteMetric = (id) => { if(confirm("åˆªé™¤æ­¤ç›®æ¨™ï¼Ÿ")) setMetrics(metrics.filter(m => m.id !== id)); };
            const addPhase = () => { const name = prompt("è¼¸å…¥æ–°éšæ®µåç¨± (ä¾‹å¦‚ï¼šåŸ·è¡ŒæœŸ):"); if (name) setPhases([...phases, { id: `phase_${Date.now()}`, name, tasks: [] }]); };
            const deletePhase = (pId) => { if(confirm("åˆªé™¤æ­¤éšæ®µåŠæ‰€æœ‰ä»»å‹™ï¼Ÿ")) setPhases(phases.filter(p => p.id !== pId)); };
            
            const addTaskToPhase = (phaseId) => { 
                if (!newTask.title) return; 
                const task = { 
                    id: Date.now(), 
                    title: newTask.title, 
                    assignee: newTask.assignee, 
                    dueDate: newTask.dueDate, 
                    completed: false,
                    kpi: { name: newTask.kpiName, target: newTask.kpiTarget, current: '', unit: newTask.kpiUnit },
                    notes: []
                }; 
                setPhases(phases.map(p => p.id === phaseId ? { ...p, tasks: [...p.tasks, task] } : p)); 
                setNewTask({ title: '', assignee: '', dueDate: '', kpiName: '', kpiTarget: '', kpiUnit: '' }); 
                setAddingToPhaseId(null); 
            };
            
            const toggleTask = (phaseId, taskId) => { setPhases(phases.map(p => p.id === phaseId ? { ...p, tasks: p.tasks.map(t => t.id === taskId ? { ...t, completed: !t.completed } : t) } : p)); };
            const deleteTask = (phaseId, taskId) => { if(confirm("åˆªé™¤ä»»å‹™ï¼Ÿ")) { setPhases(phases.map(p => p.id === phaseId ? { ...p, tasks: p.tasks.filter(t => t.id !== taskId) } : p)); } };
            const handleSave = () => { const flatTasks = phases.flatMap(p => p.tasks); onUpdate(project.id, { name: editName, cloudLink: editLink, status: editStatus, stakeholders: editStakeholders, metrics: metrics, phases: phases, subTasks: flatTasks }); onClose(); };

            return (
                <div className="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4 fade-in backdrop-blur-sm cursor-pointer" onClick={onClose}>
                    <div className="bg-white rounded-2xl w-full max-w-4xl p-0 shadow-2xl flex flex-col max-h-[90vh] cursor-auto overflow-hidden relative" onClick={e => e.stopPropagation()}>
                        <div className="bg-gradient-to-r from-slate-800 to-slate-900 p-6 text-white shrink-0 relative overflow-hidden">
                            <div className="absolute top-0 right-0 p-4 opacity-10 pointer-events-none"><Icon name="gamepad-2" size={150}/></div>
                            <div className="flex justify-between items-start relative z-10">
                                <div>
                                    <div className="flex items-center gap-3 mb-2"><h3 className="text-2xl font-bold">{editName || 'æœªå‘½åå°ˆæ¡ˆ'}</h3><span className={`text-xs px-2 py-0.5 rounded font-bold ${editStatus==='Done'?'bg-green-500':editStatus==='Stuck'?'bg-red-500':'bg-blue-500'}`}>{editStatus}</span></div>
                                    <div className="flex items-center gap-4 text-slate-300 text-sm">{editLink ? (<a href={editLink} target="_blank" className="bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-all text-xs font-bold border border-white/20 shadow-sm group"><Icon name="external-link" size={14} className="group-hover:scale-110 transition-transform"/> é–‹å•Ÿé›²ç«¯è³‡æ–™å¤¾</a>) : (<span className="opacity-50 text-xs bg-black/20 px-3 py-1.5 rounded-lg flex items-center gap-2"><Icon name="link-2-off" size={12}/> ç„¡é›²ç«¯é€£çµ</span>)}</div>
                                </div>
                                <div className="flex flex-col items-end">
                                    <div className="text-sm font-bold text-yellow-400 flex items-center gap-1 mb-1"><Icon name="crown" size={16}/> LEVEL {level}</div>
                                    <div className="w-32 h-3 bg-slate-700 rounded-full overflow-hidden border border-slate-600 relative"><div className="h-full bg-gradient-to-r from-yellow-400 to-orange-500 xp-bar-fill" style={{width: `${xp}%`}}></div></div>
                                    <div className="text-[10px] text-slate-400 mt-1">XP: {xp} / 100</div>
                                </div>
                            </div>
                        </div>
                        <div className="flex flex-col md:flex-row flex-1 overflow-hidden bg-slate-50">
                            <div className="w-full md:w-1/3 p-4 border-r border-slate-200 overflow-y-auto bg-white custom-scrollbar">
                                <div className="flex justify-between items-center mb-4"><h4 className="font-bold text-slate-700 flex items-center gap-2"><Icon name="target" size={18} className="text-red-500"/> é æœŸæˆæœ (KPI)</h4><button onClick={()=>setShowMetricForm(true)} className="text-xs bg-slate-100 hover:bg-slate-200 text-slate-600 px-2 py-1 rounded transition"><Icon name="plus" size={14}/></button></div>
                                {showMetricForm && (<div className="mb-4 p-3 bg-slate-50 border border-slate-200 rounded-xl animate-in fade-in slide-in-from-top-2"><input type="text" className="w-full mb-2 p-1.5 text-xs border rounded" placeholder="ç›®æ¨™åç¨± (å¦‚: ç‡Ÿæ”¶)" value={newMetric.name} onChange={e=>setNewMetric({...newMetric, name: e.target.value})} /><div className="flex gap-2 mb-2"><input type="number" className="w-2/3 p-1.5 text-xs border rounded" placeholder="ç›®æ¨™æ•¸å€¼" value={newMetric.target} onChange={e=>setNewMetric({...newMetric, target: e.target.value})} /><input type="text" className="w-1/3 p-1.5 text-xs border rounded" placeholder="å–®ä½" value={newMetric.unit} onChange={e=>setNewMetric({...newMetric, unit: e.target.value})} /></div><div className="flex gap-2"><button onClick={()=>setShowMetricForm(false)} className="flex-1 py-1 text-xs text-slate-500 hover:bg-slate-200 rounded">å–æ¶ˆ</button><button onClick={addMetric} className="flex-1 py-1 text-xs bg-blue-600 text-white rounded shadow-sm hover:bg-blue-700">æ–°å¢</button></div></div>)}
                                <div className="space-y-3">{metrics.map(m => (<div key={m.id} className="p-3 border border-slate-100 rounded-xl shadow-sm bg-white relative group"><button onClick={()=>deleteMetric(m.id)} className="absolute top-1 right-1 text-slate-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition p-1"><Icon name="x" size={12}/></button><div className="flex items-center justify-between"><div className="flex items-center gap-3"><CircularProgress value={m.current} max={m.target} size={40} strokeWidth={4} color={m.current >= m.target ? 'text-green-500' : 'text-blue-500'} /><div><div className="text-xs font-bold text-slate-700">{m.name}</div><div className="text-[10px] text-slate-400">ç›®æ¨™: {Number(m.target).toLocaleString()} {m.unit}</div></div></div></div><div className="mt-2 flex items-center gap-2"><span className="text-[10px] text-slate-400">ç›®å‰:</span><input type="number" className="flex-1 py-0.5 px-2 text-xs border border-slate-200 rounded text-right font-bold text-slate-700 focus:ring-1 focus:ring-blue-500 outline-none" value={m.current} onChange={(e)=>updateMetricCurrent(m.id, e.target.value)} /><span className="text-[10px] text-slate-400">{m.unit}</span></div></div>))}{metrics.length === 0 && <div className="text-center py-6 text-slate-400 text-xs border-2 border-dashed border-slate-200 rounded-xl">å°šæœªè¨­å®š KPI</div>}</div>
                                <div className="mt-6 pt-4 border-t border-slate-100"><div className="space-y-3"><div><label className="text-xs font-bold text-slate-500 mb-1 block">å°ˆæ¡ˆåç¨±</label><input type="text" className="w-full p-2 border rounded-lg text-sm" value={editName} onChange={e=>setEditName(e.target.value)} /></div><div><label className="text-xs font-bold text-slate-500 mb-1 block">é›²ç«¯é€£çµ</label><input type="text" className="w-full p-2 border rounded-lg text-sm" value={editLink} onChange={e=>setEditLink(e.target.value)} placeholder="https://..." /></div><div><label className="text-xs font-bold text-slate-500 mb-1 block">ç‹€æ…‹</label><select className="w-full p-2 border rounded-lg text-sm" value={editStatus} onChange={e=>setEditStatus(e.target.value)}><option value="To Do">To Do</option><option value="In Progress">In Progress</option><option value="Stuck">Stuck</option><option value="Done">Done</option></select></div><div><label className="text-xs font-bold text-slate-500 mb-1 block">åˆ©å®³é—œä¿‚äºº</label><input type="text" className="w-full p-2 border rounded-lg text-sm" value={editStakeholders} onChange={e=>setEditStakeholders(e.target.value)} placeholder="å¦‚: æ¥­å‹™éƒ¨, å¤–éƒ¨å» å•†..." /></div></div></div>
                            </div>
                            <div className="w-full md:w-2/3 p-4 overflow-y-auto bg-slate-50/50 relative">
                                <div className="flex justify-between items-center mb-6 sticky top-0 bg-slate-50/95 backdrop-blur z-20 py-2 border-b border-slate-200"><h4 className="font-bold text-slate-700 flex items-center gap-2"><Icon name="map" size={18} className="text-blue-600"/> ä»»å‹™åœ°åœ– (Quest Map)</h4><button onClick={addPhase} className="text-xs bg-slate-800 text-white px-3 py-1.5 rounded-lg shadow hover:bg-slate-700 flex items-center gap-1"><Icon name="plus-circle" size={14}/> æ–°å¢éšæ®µ</button></div>
                                <div className="space-y-0 pl-2 relative pb-20"><div className="absolute left-[21px] top-4 bottom-0 w-0.5 bg-slate-200 z-0"></div>{phases.map((phase, pIndex) => (<div key={phase.id} className="relative z-10 mb-8 animate-in slide-in-from-bottom-4 duration-500" style={{animationDelay: `${pIndex * 100}ms`}}><div className="flex items-center gap-4 mb-4"><div className={`w-10 h-10 rounded-full flex items-center justify-center border-4 border-slate-50 shadow-md z-10 ${phase.tasks.every(t=>t.completed) && phase.tasks.length>0 ? 'bg-green-500 text-white' : 'bg-blue-600 text-white'}`}>{phase.tasks.every(t=>t.completed) && phase.tasks.length>0 ? <Icon name="check" size={20}/> : <span className="font-bold">{pIndex + 1}</span>}</div><div className="flex-1 bg-white p-2 px-4 rounded-xl border border-slate-200 shadow-sm flex justify-between items-center group"><h5 className="font-bold text-slate-800">{phase.name}</h5><button onClick={()=>deletePhase(phase.id)} className="text-slate-300 hover:text-red-400 opacity-0 group-hover:opacity-100 transition"><Icon name="trash-2" size={14}/></button></div></div><div className="ml-14 grid grid-cols-1 sm:grid-cols-2 gap-3">{phase.tasks.map(t => (<div key={t.id} onClick={() => setEditingTaskInfo({ phaseId: phase.id, task: t })} className={`quest-card bg-white p-3 rounded-xl border-2 cursor-pointer transition-all group relative ${t.completed ? 'border-green-200 bg-green-50/30' : 'border-slate-100 hover:border-blue-200 shadow-sm'}`}><div className="flex items-start gap-3"><div onClick={(e)=>{e.stopPropagation(); toggleTask(phase.id, t.id)}} className={`mt-1 w-5 h-5 rounded border flex items-center justify-center transition-colors ${t.completed ? 'bg-green-500 border-green-500 text-white' : 'border-slate-300 bg-slate-50'}`}>{t.completed && <Icon name="check" size={12}/>}</div><div className="flex-1"><div className={`text-sm font-bold mb-1 ${t.completed ? 'text-slate-400 line-through' : 'text-slate-700'}`}>{t.title}</div><div className="flex flex-wrap gap-2 text-[10px] text-slate-400">{t.assignee && <span className="flex items-center gap-1 bg-slate-100 px-1.5 py-0.5 rounded"><Icon name="user" size={10}/> {t.assignee}</span>}{t.dueDate && <span className={`flex items-center gap-1 bg-slate-100 px-1.5 py-0.5 rounded ${new Date(t.dueDate) < new Date() && !t.completed ? 'text-red-500 font-bold' : ''}`}><Icon name="clock" size={10}/> {t.dueDate}</span>}</div>
                                {t.kpi?.target && (<div className="mt-2 text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100 flex items-center gap-1"><Icon name="target" size={10}/> {t.kpi.name || 'KPI'}: {t.kpi.current || '0'} / {t.kpi.target} {t.kpi.unit}</div>)}
                                </div><button onClick={(e)=>{e.stopPropagation();deleteTask(phase.id, t.id)}} className="absolute top-2 right-2 text-slate-300 hover:text-red-400 opacity-0 group-hover:opacity-100 p-1"><Icon name="trash-2" size={14}/></button></div></div>))}{addingToPhaseId === phase.id ? (<div className="bg-blue-50 border-2 border-blue-200 border-dashed p-3 rounded-xl animate-in zoom-in-95"><input type="text" className="w-full text-xs p-1.5 border rounded mb-2" placeholder="ä»»å‹™åç¨±..." value={newTask.title} onChange={e=>setNewTask({...newTask, title: e.target.value})} autoFocus onKeyDown={e=>e.key==='Enter'&&addTaskToPhase(phase.id)}/><div className="flex gap-2 mb-2"><input type="text" className="w-1/2 text-xs p-1.5 border rounded" placeholder="è² è²¬äºº" value={newTask.assignee} onChange={e=>setNewTask({...newTask, assignee: e.target.value})}/><input type="date" className="w-1/2 text-xs p-1.5 border rounded" value={newTask.dueDate} onChange={e=>setNewTask({...newTask, dueDate: e.target.value})}/></div>
                                <div className="grid grid-cols-3 gap-2 mb-2">
                                    <input type="text" className="text-xs p-1.5 border rounded" placeholder="KPI åç¨±" value={newTask.kpiName} onChange={e=>setNewTask({...newTask, kpiName: e.target.value})} />
                                    <input type="number" className="text-xs p-1.5 border rounded" placeholder="ç›®æ¨™å€¼" value={newTask.kpiTarget} onChange={e=>setNewTask({...newTask, kpiTarget: e.target.value})} />
                                    <input type="text" className="text-xs p-1.5 border rounded" placeholder="å–®ä½" value={newTask.kpiUnit} onChange={e=>setNewTask({...newTask, kpiUnit: e.target.value})} />
                                </div>
                                <div className="flex gap-2"><button onClick={()=>setAddingToPhaseId(null)} className="flex-1 py-1 text-xs text-slate-500 hover:bg-slate-200 rounded">å–æ¶ˆ</button><button onClick={()=>addTaskToPhase(phase.id)} className="flex-1 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700">ç¢ºå®š</button></div></div>) : (<button onClick={()=>setAddingToPhaseId(phase.id)} className="border-2 border-dashed border-slate-200 rounded-xl p-3 flex flex-col items-center justify-center text-slate-400 hover:border-blue-300 hover:text-blue-500 hover:bg-blue-50 transition-all min-h-[80px]"><Icon name="plus" size={20} className="mb-1"/><span className="text-xs">æ–°å¢ä¸¦è¡Œä»»å‹™</span></button>)}</div></div>))}<div className="ml-4 mt-4 relative z-10"><button onClick={addPhase} className="w-10 h-10 rounded-full bg-slate-200 hover:bg-blue-500 hover:text-white text-slate-500 flex items-center justify-center transition-colors shadow-sm mx-auto md:mx-0"><Icon name="plus" size={20}/></button></div></div></div>
                        </div>
                        <div className="flex justify-between items-center p-4 border-t border-slate-100 bg-white z-30">
                            <button onClick={async () => { if(confirm('ç¢ºå®šåˆªé™¤æ­¤å°ˆæ¡ˆï¼Ÿ')) { await onDelete(project.id); onClose(); } }} className="text-red-500 hover:bg-red-50 px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-1"><Icon name="trash-2" size={16}/> åˆªé™¤å°ˆæ¡ˆ</button>
                            <div className="flex gap-2"><button onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">å–æ¶ˆ</button><button onClick={handleSave} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md font-bold tracking-wide">å„²å­˜é€²åº¦</button></div>
                        </div>
                        {editingTaskInfo && (
                            <ProjectTaskEditModal 
                                task={editingTaskInfo.task} 
                                phaseId={editingTaskInfo.phaseId} 
                                onClose={() => setEditingTaskInfo(null)}
                                onSave={(phaseId, taskId, updatedTask) => {
                                    setPhases(prev => prev.map(p => p.id === phaseId ? {
                                        ...p,
                                        tasks: p.tasks.map(t => t.id === taskId ? updatedTask : t)
                                    } : p));
                                    setEditingTaskInfo(null);
                                }}
                            />
                        )}
                    </div>
                </div>
            );
        };
	
        const useVisitorTracker = (db, dbSource, viewMode) => {
            useEffect(() => {
                if (viewMode === 'admin' || !db) return;

                const sessionId = `sess_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                const todayStr = getLocalDateStr();
                const startTime = Date.now();
                let lastClickText = 'é€²å…¥ç¶²ç«™';

                const initSession = async () => {
                    const batch = writeBatch(db);
                    const basePath = `artifacts/${dbSource}/analytics`;
                    const sessionRef = doc(db, basePath, 'traffic', 'sessions', sessionId);
                    if (!sessionRef) return;

                    batch.set(sessionRef, {
                        startTime: new Date().toISOString(),
                        date: todayStr,
                        userAgent: navigator.userAgent,
                        device: /Mobi|Android/i.test(navigator.userAgent) ? 'Mobile' : 'Desktop',
                        lastActive: new Date().toISOString(),
                        durationSeconds: 0,
                        lastAction: 'é€²å…¥ç¶²ç«™',
                        page: 'é¦–é '
                    });

                    // å¯«å…¥ç¸½è¨ˆèˆ‡æ—¥è¨ˆ
                    const totalRef = doc(db, basePath, 'stats', 'overview', 'total');
                    batch.set(totalRef, { count: firebase.firestore.FieldValue.increment(1) }, { merge: true });
                    const dailyRef = doc(db, basePath, 'stats', 'daily', todayStr);
                    batch.set(dailyRef, { count: firebase.firestore.FieldValue.increment(1) }, { merge: true });

                    try { await batch.commit(); } catch (e) { console.warn(e); }
                };

                initSession();

                let lastUpdate = Date.now();
                
                const handleInteraction = (e) => {
                    const now = Date.now();
                    
                    if (e.type === 'click' && e.target) {
                        const eventTarget = e.target.closest('[data-analytics-event]');
                        if (eventTarget) {
                            lastClickText = `æŸ¥çœ‹: ${eventTarget.getAttribute('data-analytics-event')}`;
                        } else {
                            const text = e.target.innerText || e.target.tagName;
                            lastClickText = text.substring(0, 20);
                        }
                    }

                    if (now - lastUpdate > 5000) {
                        const duration = Math.floor((now - startTime) / 1000);
                        const sessionRef = doc(db, `artifacts/${dbSource}/analytics`, 'traffic', 'sessions', sessionId);
                        if (sessionRef) {
                            updateDoc(sessionRef, {
                                lastActive: new Date().toISOString(),
                                durationSeconds: duration,
                                lastAction: lastClickText
                            }).catch(() => {});
                        }
                        lastUpdate = now;
                    }
                };

                window.addEventListener('click', handleInteraction);
                window.addEventListener('scroll', handleInteraction);
                return () => {
                    window.removeEventListener('click', handleInteraction);
                    window.removeEventListener('scroll', handleInteraction);
                };
            }, [db, dbSource, viewMode]);
        };

        const AnalyticsDashboard = ({ db, dbSource }) => {
            const [stats, setStats] = useState({ total: 0, today: 0 });
            const [sessions, setSessions] = useState([]);
            const [loading, setLoading] = useState(true);
            const [trendMode, setTrendMode] = useState('daily');
            
            // å®‰å…¨è¼‰å…¥ Recharts
            const [isChartLibReady, setIsChartLibReady] = useState(!!(window.Recharts && window.Recharts.BarChart));
            const [chartLoadError, setChartLoadError] = useState(false);

            useEffect(() => {
                if (isChartLibReady) return;
                
                const checkInterval = setInterval(() => {
                    if (window.Recharts && window.Recharts.BarChart) {
                        setIsChartLibReady(true);
                        clearInterval(checkInterval);
                    }
                }, 500);

                const timeout = setTimeout(() => {
                    clearInterval(checkInterval);
                    if (!window.Recharts) {
                        setChartLoadError(true);
                    }
                }, 5000);

                return () => {
                    clearInterval(checkInterval);
                    clearTimeout(timeout);
                };
            }, [isChartLibReady]);

            // åœ¨çµ„ä»¶å…§éƒ¨å®‰å…¨è§£æ§‹
            const Recharts = window.Recharts || {};
            const { 
                BarChart, Bar, LineChart, Line, XAxis, YAxis, 
                CartesianGrid, Tooltip: RechartsTooltip, ResponsiveContainer 
            } = Recharts;

            useEffect(() => {
                if (!db) { setLoading(false); return; }
                const basePath = `artifacts/${dbSource}/analytics`;
                const todayStr = getLocalDateStr();

                const unsubTotal = onSnapshot(doc(db, basePath, 'stats', 'overview', 'total'), s => {
                    setStats(prev => ({ ...prev, total: (s && s.exists()) ? s.data().count : 0 }));
                });
                const unsubDaily = onSnapshot(doc(db, basePath, 'stats', 'daily', todayStr), s => {
                    setStats(prev => ({ ...prev, today: (s && s.exists()) ? s.data().count : 0 }));
                });

                const q = collection(db, basePath, 'traffic', 'sessions');
                const unsubSessions = onSnapshot(q, (snapshot) => {
                    const list = [];
                    if (snapshot) snapshot.forEach(doc => list.push({ id: doc.id, ...doc.data() }));
                    list.sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
                    setSessions(list);
                    setLoading(false);
                });

                return () => { if(unsubTotal) unsubTotal(); if(unsubDaily) unsubDaily(); if(unsubSessions) unsubSessions(); };
            }, [db, dbSource]);

            const processHourlyData = useMemo(() => {
                const hours = Array(24).fill(0).map((_, i) => ({ hour: `${i}æ™‚`, count: 0 }));
                sessions.forEach(s => {
                    if (!s.startTime) return;
                    const h = new Date(s.startTime).getHours();
                    if (hours[h]) hours[h].count++;
                });
                return hours;
            }, [sessions]);

            const processTrendData = useMemo(() => {
                const map = {};
                sessions.forEach(s => {
                    if (!s.startTime) return;
                    const d = new Date(s.startTime);
                    let key = '';
                    
                    if (trendMode === 'daily') {
                        key = s.date || d.toISOString().split('T')[0];
                    } else if (trendMode === 'weekly') {
                        const startOfYear = new Date(d.getFullYear(), 0, 1);
                        const days = Math.floor((d - startOfYear) / (24 * 60 * 60 * 1000));
                        const week = Math.ceil((days + 1) / 7);
                        key = `${d.getFullYear()} W${week}`;
                    } else if (trendMode === 'monthly') {
                        key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                    }
                    map[key] = (map[key] || 0) + 1;
                });

                return Object.entries(map)
                    .map(([date, count]) => ({ date, count }))
                    .sort((a, b) => a.date.localeCompare(b.date))
                    .slice(-30);
            }, [sessions, trendMode]);

            if (!db) return <div className="p-8 text-center text-red-400">è³‡æ–™åº«æœªé€£ç·š</div>;
            
            if (!isChartLibReady) {
                if (chartLoadError) {
                    return (
                        <div className="p-12 text-center border-2 border-dashed border-red-200 rounded-xl m-4 bg-red-50">
                            <Icon name="alert-triangle" className="mb-2 mx-auto text-red-500" size={32}/>
                            <h3 className="font-bold text-red-600">åœ–è¡¨å¼•æ“è¼‰å…¥å¤±æ•—</h3>
                            <p className="text-xs text-red-400 mt-2 mb-4">å¯èƒ½æ˜¯ç¶²è·¯é€£ç·šå•é¡Œæˆ– CDN é˜»æ“‹</p>
                            <button onClick={() => window.location.reload()} className="bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600 transition">é‡æ–°æ•´ç†é é¢</button>
                        </div>
                    );
                }

                return (
                    <div className="p-12 text-center border-2 border-dashed border-slate-200 rounded-xl m-4 bg-slate-50">
                        <Icon name="loader-2" className="animate-spin mb-2 mx-auto text-blue-500" size={32}/>
                        <h3 className="font-bold text-slate-600">æ­£åœ¨å•Ÿå‹•åœ–è¡¨å¼•æ“...</h3>
                        <p className="text-xs text-slate-400 mt-2">é¦–æ¬¡è¼‰å…¥å¯èƒ½éœ€è¦å¹¾ç§’é˜</p>
                    </div>
                );
            }

            if (loading) return <div className="p-8 text-center text-slate-400"><Icon name="loader-2" className="animate-spin inline mr-2"/>è®€å–æ•¸æ“šä¸­...</div>;

            const avgDuration = sessions.length > 0 ? Math.round(sessions.reduce((a, b) => a + (b.durationSeconds || 0), 0) / sessions.length) : 0;

            // ç¢ºä¿å…ƒä»¶å­˜åœ¨
            if (!BarChart || !LineChart) return <div>Chart components missing</div>;

            return (
                <div className="fade-in max-w-6xl mx-auto pb-20 space-y-6">
                    <header className="flex justify-between items-end">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800">æµé‡æ•¸æ“šä¸­å¿ƒ</h2>
                            <p className="text-sm text-slate-500">æŒæ¡è¨ªå®¢å‹•å‘èˆ‡æ™‚æ®µåˆ†æ</p>
                        </div>
                        <div className="text-xs text-slate-400">çµ±è¨ˆæ¨£æœ¬: æœ€è¿‘ {sessions.length} ç­†</div>
                    </header>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-blue-100">
                            <div className="text-sm font-bold text-blue-500 mb-1">ç¸½ç´¯ç©è¨ªå®¢æ•¸</div>
                            <div className="text-4xl font-bold text-slate-800">{(stats.total || 0).toLocaleString()}</div>
                        </div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-emerald-100">
                            <div className="text-sm font-bold text-emerald-500 mb-1">ä»Šæ—¥è¨ªå®¢</div>
                            <div className="text-4xl font-bold text-slate-800">{(stats.today || 0).toLocaleString()}</div>
                        </div>
                        <div className="bg-white p-6 rounded-2xl shadow-sm border border-orange-100">
                            <div className="text-sm font-bold text-orange-500 mb-1">å¹³å‡åœç•™æ™‚é–“</div>
                            <div className="text-4xl font-bold text-slate-800">{avgDuration} <span className="text-base text-slate-400 font-normal">ç§’</span></div>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold text-slate-700 flex items-center gap-2"><Icon name="trending-up" size={18}/> æµé‡è¶¨å‹¢</h3>
                                <div className="flex bg-slate-100 rounded-lg p-1">
                                    {['daily','weekly','monthly'].map(m => (
                                        <button key={m} onClick={()=>setTrendMode(m)} className={`px-3 py-1 text-xs rounded-md transition-all ${trendMode===m ? 'bg-white shadow text-blue-600 font-bold' : 'text-slate-500'}`}>
                                            {m==='daily'?'æ—¥':m==='weekly'?'é€±':'æœˆ'}
                                        </button>
                                    ))}
                                </div>
                            </div>
                            <div className="h-[250px] w-full">
                                <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={processTrendData}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0"/>
                                        <XAxis dataKey="date" tick={{fontSize:10}} stroke="#94a3b8"/>
                                        <YAxis tick={{fontSize:10}} stroke="#94a3b8"/>
                                        <RechartsTooltip contentStyle={{borderRadius:'8px', border:'none', boxShadow:'0 4px 6px -1px rgb(0 0 0 / 0.1)'}}/>
                                        <Line type="monotone" dataKey="count" stroke="#3b82f6" strokeWidth={3} dot={{r:3}} activeDot={{r:6}} name="è¨ªå®¢æ•¸"/>
                                    </LineChart>
                                </ResponsiveContainer>
                            </div>
                        </div>

                        <div className="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold text-slate-700 flex items-center gap-2"><Icon name="clock" size={18}/> å–®æ—¥ç†±é–€æ™‚æ®µ (0-23æ™‚)</h3>
                            </div>
                            <div className="h-[250px] w-full">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={processHourlyData}>
                                        <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0"/>
                                        <XAxis dataKey="hour" tick={{fontSize:10}} stroke="#94a3b8"/>
                                        <YAxis tick={{fontSize:10}} stroke="#94a3b8"/>
                                        <RechartsTooltip cursor={{fill: '#f1f5f9'}} contentStyle={{borderRadius:'8px', border:'none', boxShadow:'0 4px 6px -1px rgb(0 0 0 / 0.1)'}}/>
                                        <Bar dataKey="count" fill="#8b5cf6" radius={[4, 4, 0, 0]} name="æ´»èºæ¬¡æ•¸"/>
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="p-4 border-b border-slate-100 font-bold text-slate-700 bg-slate-50/50">ğŸ•µï¸ æœ€è¿‘è¨ªå®¢ç´€éŒ„ (æœ€è¿‘ 50 ç­†)</div>
                        <div className="overflow-x-auto">
                            <table className="w-full text-left text-sm">
                                <thead className="bg-slate-50 text-slate-500"><tr><th className="p-4">æ™‚é–“</th><th className="p-4">è£ç½®</th><th className="p-4">åœç•™</th><th className="p-4">æœ€å¾Œäº’å‹• (æ´»å‹•è¿½è¹¤)</th></tr></thead>
                                <tbody className="divide-y divide-slate-100">
                                    {sessions.slice(0, 50).map(s => (
                                        <tr key={s.id} className="hover:bg-slate-50 transition-colors">
                                            <td className="p-4 text-slate-600"><div className="font-bold">{s.date}</div><div className="text-xs text-slate-400">{s.startTime ? new Date(s.startTime).toLocaleTimeString() : '-'}</div></td>
                                            <td className="p-4"><span className={`px-2 py-1 rounded text-xs font-bold ${s.device === 'Mobile' ? 'bg-purple-100 text-purple-700' : 'bg-slate-100 text-slate-600'}`}>{s.device || 'Desktop'}</span></td>
                                            <td className="p-4 font-mono font-bold text-blue-600">{(s.durationSeconds||0)<60 ? `${s.durationSeconds||0}s` : `${Math.floor((s.durationSeconds||0)/60)}m`}</td>
                                            <td className="p-4">
                                                <div className="max-w-[240px] truncate text-slate-700 font-medium" title={s.lastAction}>{s.lastAction || '-'}</div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        };
        
        const ProjectConsoleTab = ({ user, db, dbSource, sourceProjects }) => {
            const [allProjects, setAllProjects] = useState([]);
            const [activeProjectId, setActiveProjectId] = useState(null);
            const [expandedWPs, setExpandedWPs] = useState([]);
            const [viewMode, setViewMode] = useState('table');
            const [workspaceMode, setWorkspaceMode] = useState('active');
            const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
            const [newProjectName, setNewProjectName] = useState("");
            const [isSaving, setIsSaving] = useState(false);

            useEffect(() => {
                const mapped = (sourceProjects || []).map((p, idx) => normalizeConsoleProject(p, `proj_${idx}`));
                setAllProjects(mapped);
            }, [sourceProjects]);

            useEffect(() => {
                const list = allProjects.filter(p => p.status === workspaceMode);
                if (!activeProjectId && list.length > 0) setActiveProjectId(list[0].id);
                if (activeProjectId && !list.some(p => p.id === activeProjectId)) {
                    setActiveProjectId(list[0]?.id || null);
                }
            }, [allProjects, workspaceMode, activeProjectId]);

            const currentProject = useMemo(() => allProjects.find(p => p.id === activeProjectId) || null, [allProjects, activeProjectId]);

            useEffect(() => {
                if (!user || !db || !currentProject) return;
                const timer = setTimeout(async () => {
                    setIsSaving(true);
                    try {
                        await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'projects', currentProject.id), currentProject, { merge: true });
                    } catch (e) {
                        console.error("Project autosave error:", e);
                    } finally {
                        setIsSaving(false);
                    }
                }, 1000);
                return () => clearTimeout(timer);
            }, [currentProject, user, db, dbSource]);

            const setProjectData = (field, value) => {
                setAllProjects(prev => prev.map(p => {
                    if (p.id !== activeProjectId) return p;
                    if (field === 'status' && (value === 'active' || value === 'archived')) {
                        return { ...p, status: value, workspaceStatus: value };
                    }
                    return { ...p, [field]: value };
                }));
            };

            const updateTask = (wpId, taskId, field, subfield, value) => {
                setAllProjects(prev => prev.map(p => {
                    if (p.id !== activeProjectId) return p;
                    return {
                        ...p,
                        workPackages: p.workPackages.map(wp => {
                            if (wp.id !== wpId) return wp;
                            if (!taskId) return { ...wp, [field]: value };
                            return {
                                ...wp,
                                tasks: wp.tasks.map(t => {
                                    if (t.id !== taskId) return t;
                                    if (subfield) return { ...t, [field]: { ...t[field], [subfield]: value } };
                                    return { ...t, [field]: value };
                                })
                            };
                        })
                    };
                }));
            };

            const addWP = () => {
                if (!currentProject) return;
                const newId = `WP${(currentProject.workPackages.length + 1)}`;
                setProjectData('workPackages', [...currentProject.workPackages, { id: newId, name: "æ–°å·¥ä½œåŒ…", tasks: [] }]);
                setExpandedWPs(prev => [...new Set([...prev, newId])]);
            };

            const deleteWP = (wpId) => {
                if (!confirm("ç¢ºå®šåˆªé™¤æ­¤å·¥ä½œåŒ…ï¼Ÿ")) return;
                setProjectData('workPackages', currentProject.workPackages.filter(wp => wp.id !== wpId));
            };

            const addTask = (wpId) => {
                if (!currentProject) return;
                const today = new Date().toISOString().split('T')[0];
                const next = currentProject.workPackages.map(wp => {
                    if (wp.id !== wpId) return wp;
                    return {
                        ...wp,
                        tasks: [...wp.tasks, {
                            id: `${wp.id.replace('WP', '')}.${wp.tasks.length + 1}`,
                            name: "æ–°ä»»å‹™",
                            owner: "æœªæŒ‡æ´¾",
                            plan: { start: today, end: today, cost: 0 },
                            actual: { start: today, end: today, cost: 0 },
                            progress: 0
                        }]
                    };
                });
                setProjectData('workPackages', next);
            };

            const deleteTask = (wpId, taskId) => {
                if (!confirm("ç¢ºå®šåˆªé™¤æ­¤ä»»å‹™ï¼Ÿ")) return;
                const next = currentProject.workPackages.map(wp => wp.id === wpId ? { ...wp, tasks: wp.tasks.filter(t => t.id !== taskId) } : wp);
                setProjectData('workPackages', next);
            };

            const handleCreateProject = async () => {
                if (!newProjectName.trim() || !db) return;
                const newProj = createProjectConsoleTemplate(newProjectName.trim());
                await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'projects', newProj.id), newProj);
                setNewProjectName("");
                setIsCreateModalOpen(false);
                setWorkspaceMode('active');
                setActiveProjectId(newProj.id);
            };

            const archiveProject = () => {
                if (!currentProject) return;
                setAllProjects(prev => prev.map(p => p.id === currentProject.id ? { ...p, status: 'archived', workspaceStatus: 'archived' } : p));
            };
            const restartProject = () => {
                if (!currentProject) return;
                setAllProjects(prev => prev.map(p => p.id === currentProject.id ? { ...p, status: 'active', workspaceStatus: 'active' } : p));
            };
            const deleteProject = async (id) => {
                if (!confirm("ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤æ­¤å°ˆæ¡ˆå—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚")) return;
                await deleteDoc(doc(db, `artifacts/${dbSource}/public/data`, 'projects', id));
                if (activeProjectId === id) setActiveProjectId(null);
            };

            const workspaceProjects = allProjects.filter(p => (p.workspaceStatus || p.status) === workspaceMode);
            const evmStats = useMemo(() => {
                if (!currentProject) return { totalPV: 0, totalAC: 0, totalEV: 0, cpi: "0.00", spi: "0.00", cv: 0 };
                let totalPV = 0, totalAC = 0, totalEV = 0;
                currentProject.workPackages.forEach(wp => {
                    wp.tasks.forEach(task => {
                        totalPV += Number(task.plan?.cost || 0);
                        totalAC += Number(task.actual?.cost || 0);
                        totalEV += Number(task.plan?.cost || 0) * (Number(task.progress || 0) / 100);
                    });
                });
                return {
                    totalPV,
                    totalAC,
                    totalEV,
                    cpi: totalAC > 0 ? (totalEV / totalAC).toFixed(2) : "0.00",
                    spi: totalPV > 0 ? (totalEV / totalPV).toFixed(2) : "0.00",
                    cv: totalEV - totalAC
                };
            }, [currentProject]);

            const getPosition = (dateStr) => (getDayOfYear(dateStr) / 365) * 100;

            return (
                <div className="min-h-[80vh] bg-slate-50 text-slate-900 rounded-2xl overflow-hidden border border-slate-200 flex flex-col md:flex-row">
                    <div className="w-full md:w-72 bg-slate-900 text-white flex flex-col shrink-0 border-r border-slate-800">
                        <div className="p-6 flex items-center gap-3 border-b border-slate-800">
                            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center font-black">P</div>
                            <span className="font-black tracking-tighter text-lg">Project Console</span>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-6">
                            <div className="space-y-1">
                                <button onClick={() => setWorkspaceMode('active')} className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-sm font-bold ${workspaceMode === 'active' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:bg-slate-800'}`}><Icon name="briefcase" size={18}/> åŸ·è¡Œä¸­å°ˆæ¡ˆ</button>
                                <button onClick={() => setWorkspaceMode('archived')} className={`w-full flex items-center gap-3 px-4 py-2.5 rounded-xl text-sm font-bold ${workspaceMode === 'archived' ? 'bg-amber-600 text-white' : 'text-slate-400 hover:bg-slate-800'}`}><Icon name="history" size={18}/> å·²çµæ¡ˆå­˜æª”</button>
                            </div>
                            <div>
                                <p className="text-[10px] font-black text-slate-500 uppercase tracking-widest px-4 mb-3">Project List</p>
                                <div className="space-y-1">
                                    {workspaceProjects.map(p => (
                                        <div key={p.id} className="group relative">
                                            <button onClick={() => setActiveProjectId(p.id)} className={`w-full text-left px-4 py-3 rounded-xl text-sm font-medium truncate pr-10 ${activeProjectId === p.id ? 'bg-slate-800 text-blue-400 ring-1 ring-slate-700' : 'text-slate-400 hover:bg-slate-800/50'}`}>{p.name}</button>
                                            {workspaceMode === 'archived' && <button onClick={() => deleteProject(p.id)} className="absolute right-2 top-1/2 -translate-y-1/2 text-slate-600 hover:text-rose-500 opacity-0 group-hover:opacity-100"><Icon name="trash-2" size={14}/></button>}
                                        </div>
                                    ))}
                                    {workspaceProjects.length === 0 && <div className="px-4 py-8 text-center border-2 border-dashed border-slate-800 rounded-2xl"><p className="text-xs text-slate-600 font-bold">å°šç„¡é …ç›®</p></div>}
                                </div>
                            </div>
                        </div>
                        <div className="p-4 border-t border-slate-800">
                            <button onClick={() => setIsCreateModalOpen(true)} className="w-full py-3 bg-slate-800 hover:bg-slate-700 text-white rounded-xl text-sm font-black flex items-center justify-center gap-2 border border-slate-700"><Icon name="folder-plus" size={18}/> æ–°å¢å°ˆæ¡ˆ</button>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col overflow-hidden">
                        {!currentProject ? (
                            <div className="flex-1 flex flex-col items-center justify-center text-slate-300 p-12"><Icon name="layout-grid" size={64} className="mb-4 opacity-20"/><p className="text-xl font-black">è«‹é¸æ“‡æˆ–å»ºç«‹ä¸€å€‹å°ˆæ¡ˆ</p></div>
                        ) : (
                            <>
                                <div className="bg-white border-b border-slate-200 p-6 shadow-sm">
                                    <div className="max-w-[1400px] mx-auto flex flex-col lg:flex-row justify-between items-start lg:items-end gap-6">
                                        <div className="flex-1 w-full">
                                            <div className="flex items-center gap-2 mb-2">
                                                <span className={`text-[10px] font-black px-2 py-0.5 rounded uppercase ${currentProject.status === 'active' ? 'bg-blue-600 text-white' : 'bg-amber-600 text-white'}`}>{currentProject.status === 'active' ? 'Active Project' : 'Archived'}</span>
                                                {isSaving && <span className="text-[10px] text-blue-500 animate-pulse font-bold flex items-center gap-1"><Icon name="cloud-upload" size={12}/> å„²å­˜ä¸­</span>}
                                            </div>
                                            <input className="text-3xl font-black text-slate-800 bg-transparent border-none focus:ring-2 focus:ring-blue-50 rounded-lg w-full px-2 py-1 -ml-2" value={currentProject.name} onChange={e => setProjectData('name', e.target.value)} disabled={currentProject.status === 'archived'} />
                                            <div className="flex flex-wrap gap-x-6 gap-y-3 mt-4 text-xs text-slate-500 font-bold">
                                                <span>PM: <input className="bg-transparent border-none p-0 font-black text-slate-700 w-24 focus:ring-0" value={currentProject.pm} onChange={e => setProjectData('pm', e.target.value)} disabled={currentProject.status === 'archived'} /></span>
                                                <span>Dept: <input className="bg-transparent border-none p-0 font-black text-slate-700 w-24 focus:ring-0" value={currentProject.department} onChange={e => setProjectData('department', e.target.value)} disabled={currentProject.status === 'archived'} /></span>
                                                <span>Budget: NT$<input type="number" className="bg-transparent border-none p-0 font-black text-slate-700 w-24 focus:ring-0" value={currentProject.totalBudget} onChange={e => setProjectData('totalBudget', Number(e.target.value) || 0)} disabled={currentProject.status === 'archived'} /></span>
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-3 shrink-0">
                                            <div className="flex bg-slate-100 rounded-xl p-1 border border-slate-200">
                                                <button onClick={() => setViewMode('table')} className={`px-4 py-2 text-xs font-bold rounded-lg ${viewMode === 'table' ? 'bg-white text-slate-800 shadow-sm' : 'text-gray-500'}`}>æ•¸æ“šè¡¨</button>
                                                <button onClick={() => setViewMode('gantt')} className={`px-4 py-2 text-xs font-bold rounded-lg ${viewMode === 'gantt' ? 'bg-white text-slate-800 shadow-sm' : 'text-gray-500'}`}>ç”˜ç‰¹åœ–</button>
                                            </div>
                                            {currentProject.status === 'active'
                                                ? <button onClick={archiveProject} className="flex items-center gap-2 px-5 py-2.5 bg-amber-500 text-white text-xs font-black rounded-xl"><Icon name="archive" size={16}/> çµæ¡ˆå­˜æª”</button>
                                                : <button onClick={restartProject} className="flex items-center gap-2 px-5 py-2.5 bg-blue-600 text-white text-xs font-black rounded-xl"><Icon name="briefcase" size={16}/> é‡å•Ÿå°ˆæ¡ˆ</button>}
                                        </div>
                                    </div>
                                </div>

                                <div className="p-8 max-w-[1400px] mx-auto w-full overflow-y-auto space-y-8 flex-1">
                                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                        {[{ label: 'CPI (æˆæœ¬ç¸¾æ•ˆ)', val: evmStats.cpi, color: Number(evmStats.cpi) >= 1 ? 'text-emerald-600' : 'text-rose-600' }, { label: 'SPI (é€²åº¦ç¸¾æ•ˆ)', val: evmStats.spi, color: Number(evmStats.spi) >= 1 ? 'text-emerald-600' : 'text-rose-600' }, { label: 'å¯¦ç²åƒ¹å€¼ (EV)', val: `NT$${Math.round(evmStats.totalEV).toLocaleString()}`, color: 'text-slate-800' }, { label: 'æˆæœ¬åå·® (CV)', val: `${evmStats.cv >= 0 ? '+' : ''}${Math.round(evmStats.cv).toLocaleString()}`, color: evmStats.cv >= 0 ? 'text-emerald-600' : 'text-rose-600' }].map((kpi, idx) => (
                                            <div key={idx} className="bg-white p-6 border border-slate-200 rounded-2xl shadow-sm"><p className="text-[10px] text-gray-400 font-black uppercase mb-1">{kpi.label}</p><div className={`text-2xl font-black ${kpi.color}`}>{kpi.val}</div></div>
                                        ))}
                                    </div>

                                    <div className="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden min-h-[400px]">
                                        {viewMode === 'table' ? (
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-left border-collapse min-w-[920px]">
                                                    <thead className="bg-slate-800 text-white text-[11px] uppercase tracking-wider font-bold">
                                                        <tr><th className="px-5 py-4 w-[42%]">WBS éšå±¤èˆ‡å·¥ä½œå…§å®¹</th><th className="px-3 py-4 text-center w-24">é€²åº¦ %</th><th className="px-4 py-4 w-56">æˆæœ¬ (P vs A)</th><th className="px-4 py-4 w-72">èµ·è¨–é€±æœŸ</th><th className="px-3 py-4 text-center w-14"></th></tr>
                                                    </thead>
                                                    <tbody className="text-sm">
                                                        {currentProject.workPackages.map(wp => (
                                                            <React.Fragment key={wp.id}>
                                                                <tr className="bg-slate-50 border-b border-slate-100">
                                                                    <td className="px-5 py-3 flex items-center gap-3">
                                                                        <button onClick={() => setExpandedWPs(prev => prev.includes(wp.id) ? prev.filter(i => i !== wp.id) : [...prev, wp.id])}>{expandedWPs.includes(wp.id) ? <Icon name="chevron-down" size={18}/> : <Icon name="chevron-right" size={18}/>}</button>
                                                                        <input className="bg-transparent border-none font-black text-slate-800 focus:ring-0 p-0 max-w-[240px]" value={wp.name} onChange={e => updateTask(wp.id, null, 'name', null, e.target.value)} disabled={currentProject.status === 'archived'} />
                                                                        <button onClick={() => addTask(wp.id)} className="ml-4 text-[10px] font-black text-blue-600 uppercase hover:underline" disabled={currentProject.status === 'archived'}>+ Add Task</button>
                                                                    </td>
                                                                    <td colSpan="3"></td>
                                                                    <td className="px-3 py-3 text-center text-slate-300 hover:text-rose-500 cursor-pointer" onClick={() => deleteWP(wp.id)}><Icon name="trash-2" size={16}/></td>
                                                                </tr>
                                                                {expandedWPs.includes(wp.id) && wp.tasks.map(task => (
                                                                    <tr key={task.id} className="border-b border-slate-50 hover:bg-slate-50/50">
                                                                        <td className="px-8 py-4">
                                                                            <input className="block w-full max-w-[260px] font-bold text-slate-700 bg-transparent border-none p-0 mb-1 focus:ring-0" value={task.name} onChange={e => updateTask(wp.id, task.id, 'name', null, e.target.value)} disabled={currentProject.status === 'archived'} />
                                                                            <div className="flex items-center gap-2 text-[10px] mt-1">
                                                                                <span className="text-slate-400 shrink-0">Owner</span>
                                                                                <input
                                                                                    className="w-full max-w-[180px] bg-white border border-slate-200 rounded px-2 py-1 text-slate-600 focus:ring-1 focus:ring-blue-500 outline-none"
                                                                                    value={task.owner || ''}
                                                                                    onChange={e => updateTask(wp.id, task.id, 'owner', null, e.target.value)}
                                                                                    placeholder="è¼¸å…¥è² è²¬äºº"
                                                                                    disabled={currentProject.status === 'archived'}
                                                                                />
                                                                            </div>
                                                                        </td>
                                                                        <td className="px-3 py-4 text-center"><input type="number" className="w-14 text-center font-black text-blue-600 bg-blue-50 border-none rounded py-1" value={task.progress} onChange={e => updateTask(wp.id, task.id, 'progress', null, Number(e.target.value) || 0)} disabled={currentProject.status === 'archived'} /></td>
                                                                        <td className="px-4 py-4 text-[11px] space-y-2">
                                                                            <div className="flex items-center justify-between gap-2 text-slate-500">
                                                                                <span className="font-bold">P:</span>
                                                                                <input type="number" className="w-24 bg-white border border-slate-200 rounded px-2 py-1 text-right font-bold focus:ring-1 focus:ring-blue-500 outline-none" value={task.plan.cost} onChange={e => updateTask(wp.id, task.id, 'plan', 'cost', Number(e.target.value) || 0)} disabled={currentProject.status === 'archived'} />
                                                                            </div>
                                                                            <div className="flex items-center justify-between gap-2 text-slate-700">
                                                                                <span className="font-bold">A:</span>
                                                                                <input type="number" className="w-24 bg-white border border-slate-200 rounded px-2 py-1 text-right font-bold focus:ring-1 focus:ring-blue-500 outline-none" value={task.actual.cost} onChange={e => updateTask(wp.id, task.id, 'actual', 'cost', Number(e.target.value) || 0)} disabled={currentProject.status === 'archived'} />
                                                                            </div>
                                                                        </td>
                                                                        <td className="px-4 py-4 text-[10px] space-y-2">
                                                                            <div className="flex items-center gap-2">
                                                                                <span className="text-slate-400 w-9">Plan</span>
                                                                                <input type="date" className="text-[10px] bg-white border border-slate-200 rounded px-1.5 py-1 focus:ring-1 focus:ring-blue-500 outline-none" value={task.plan.start} onChange={e => updateTask(wp.id, task.id, 'plan', 'start', e.target.value)} disabled={currentProject.status === 'archived'} />
                                                                                <span className="text-slate-300">~</span>
                                                                                <input type="date" className="text-[10px] bg-white border border-slate-200 rounded px-1.5 py-1 focus:ring-1 focus:ring-blue-500 outline-none" value={task.plan.end} onChange={e => updateTask(wp.id, task.id, 'plan', 'end', e.target.value)} disabled={currentProject.status === 'archived'} />
                                                                            </div>
                                                                            <div className="flex items-center gap-2">
                                                                                <span className="text-blue-600 font-bold w-9">Act</span>
                                                                                <input type="date" className="text-[10px] bg-white border border-blue-100 rounded px-1.5 py-1 focus:ring-1 focus:ring-blue-500 outline-none" value={task.actual.start} onChange={e => updateTask(wp.id, task.id, 'actual', 'start', e.target.value)} disabled={currentProject.status === 'archived'} />
                                                                                <span className="text-slate-300">~</span>
                                                                                <input type="date" className="text-[10px] bg-white border border-blue-100 rounded px-1.5 py-1 focus:ring-1 focus:ring-blue-500 outline-none" value={task.actual.end} onChange={e => updateTask(wp.id, task.id, 'actual', 'end', e.target.value)} disabled={currentProject.status === 'archived'} />
                                                                            </div>
                                                                        </td>
                                                                        <td className="px-3 py-4 text-center text-slate-200 hover:text-rose-500 cursor-pointer" onClick={() => deleteTask(wp.id, task.id)}><Icon name="trash-2" size={16}/></td>
                                                                    </tr>
                                                                ))}
                                                            </React.Fragment>
                                                        ))}
                                                        {currentProject.status === 'active' && <tr><td colSpan="5" className="p-6 text-center"><button onClick={addWP} className="text-sm font-black text-blue-600 border-2 border-dashed border-blue-100 px-6 py-3 rounded-2xl hover:bg-blue-50 flex items-center gap-2 mx-auto"><Icon name="plus" size={18}/> æ–°å¢å·¥ä½œåŒ… (WBS Group)</button></td></tr>}
                                                    </tbody>
                                                </table>
                                            </div>
                                        ) : (
                                            <div className="p-8">
                                                <div className="flex border-b border-slate-100 mb-8 pb-4 font-black text-[10px] text-slate-400"><div className="w-64 shrink-0 uppercase tracking-widest">WBS Tasks Timeline</div><div className="flex-1 flex justify-between px-4">{MONTH_LABELS.map(m => <div key={m} className="flex-1 pl-3 border-l border-slate-50">{m}</div>)}</div></div>
                                                <div className="space-y-8">
                                                    {currentProject.workPackages.map(wp => (
                                                        <div key={wp.id} className="space-y-5">
                                                            <div className="flex items-center gap-4 text-xs font-black text-slate-800 uppercase tracking-tight"><div className="w-1.5 h-1.5 rounded-full bg-blue-600" /> {wp.name}</div>
                                                            {wp.tasks.map(task => {
                                                                const planS = getPosition(task.plan.start), planE = getPosition(task.plan.end);
                                                                const actS = getPosition(task.actual.start), actE = getPosition(task.actual.end);
                                                                return (
                                                                    <div key={task.id} className="flex items-center group">
                                                                        <div className="w-64 shrink-0 pr-8 text-[11px] font-bold text-slate-600 truncate">{task.name}</div>
                                                                        <div className="flex-1 relative h-10 bg-slate-50 rounded-lg border-x border-slate-100 overflow-hidden">
                                                                            <div className="absolute h-1.5 bg-slate-200 rounded-full top-2 opacity-50" style={{ left: `${planS}%`, width: `${Math.max(1, planE - planS)}%` }} />
                                                                            <div className={`absolute h-4 rounded shadow-sm top-4 ${Number(task.progress) === 100 ? 'bg-emerald-500' : 'bg-blue-600'}`} style={{ left: `${actS}%`, width: `${Math.max(1, actE - actS)}%` }}><div className="absolute inset-y-0 left-0 bg-white/25" style={{ width: `${task.progress}%` }} /></div>
                                                                        </div>
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </>
                        )}
                    </div>

                    {isCreateModalOpen && (
                        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-[120] p-4">
                            <div className="bg-white rounded-3xl shadow-2xl w-full max-w-md overflow-hidden">
                                <div className="p-8 border-b border-slate-100 flex justify-between items-center"><h3 className="text-xl font-black text-slate-800">å»ºç«‹æ–°å°ˆæ¡ˆ</h3><button onClick={() => setIsCreateModalOpen(false)} className="text-slate-300 hover:text-slate-600"><Icon name="x" size={24}/></button></div>
                                <div className="p-8 space-y-6">
                                    <div><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">Project Name</label><input autoFocus className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl px-5 py-4 font-bold focus:ring-4 focus:ring-blue-100 focus:border-blue-500 outline-none" placeholder="ä¾‹å¦‚ï¼š2026 å¹´åº¦è¡ŒéŠ·è¨ˆç•«" value={newProjectName} onChange={e => setNewProjectName(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleCreateProject()} /></div>
                                    <button onClick={handleCreateProject} disabled={!newProjectName.trim()} className="w-full py-4 bg-blue-600 disabled:bg-slate-200 text-white rounded-2xl font-black hover:bg-blue-700">ç¢ºèªå»ºç«‹å°ˆæ¡ˆ</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ProjectOwnerTimelineTab = ({ sourceProjects }) => {
            const normalizedProjects = useMemo(
                () => (sourceProjects || []).map((p, idx) => normalizeConsoleProject(p, `proj_${idx}`)),
                [sourceProjects]
            );

            const ownerOptions = useMemo(() => {
                const ownerSet = new Set();
                normalizedProjects.forEach(project => {
                    (project.workPackages || []).forEach(wp => {
                        (wp.tasks || []).forEach(task => {
                            const owner = (task.owner || '').trim();
                            if (owner) ownerSet.add(owner);
                        });
                    });
                });
                return Array.from(ownerSet).sort((a, b) => a.localeCompare(b, 'zh-Hant'));
            }, [normalizedProjects]);

            const [selectedOwner, setSelectedOwner] = useState('');

            useEffect(() => {
                if (ownerOptions.length === 0) {
                    setSelectedOwner('');
                    return;
                }
                if (!selectedOwner || !ownerOptions.includes(selectedOwner)) {
                    setSelectedOwner(ownerOptions[0]);
                }
            }, [ownerOptions, selectedOwner]);

            const ownerProjects = useMemo(() => {
                if (!selectedOwner) return [];
                return normalizedProjects.map(project => {
                    const tasks = [];
                    (project.workPackages || []).forEach(wp => {
                        (wp.tasks || []).forEach(task => {
                            if ((task.owner || '').trim() !== selectedOwner) return;
                            const start = task.actual?.start || task.plan?.start || '';
                            const end = task.actual?.end || task.plan?.end || start;
                            if (!start) return;
                            tasks.push({
                                id: `${project.id}_${wp.id}_${task.id}`,
                                projectId: project.id,
                                projectName: project.name || 'æœªå‘½åå°ˆæ¡ˆ',
                                wpName: wp.name || 'æœªå‘½åå·¥ä½œåŒ…',
                                taskName: task.name || 'æœªå‘½åä»»å‹™',
                                start,
                                end: end || start,
                                progress: Number(task.progress || 0)
                            });
                        });
                    });
                    return { projectId: project.id, projectName: project.name || 'æœªå‘½åå°ˆæ¡ˆ', tasks };
                }).filter(p => p.tasks.length > 0);
            }, [normalizedProjects, selectedOwner]);

            const allOwnerTasks = useMemo(() => ownerProjects.flatMap(p => p.tasks), [ownerProjects]);

            const timelineBounds = useMemo(() => {
                if (allOwnerTasks.length === 0) return null;
                const parseDate = (dateStr) => {
                    const d = new Date(`${dateStr}T00:00:00`);
                    return Number.isNaN(d.getTime()) ? null : d;
                };
                const starts = allOwnerTasks.map(t => parseDate(t.start)).filter(Boolean);
                const ends = allOwnerTasks.map(t => parseDate(t.end || t.start)).filter(Boolean);
                if (!starts.length || !ends.length) return null;
                const minTime = Math.min(...starts.map(d => d.getTime()));
                const maxTime = Math.max(...ends.map(d => d.getTime()));
                const minDate = new Date(minTime);
                const maxDate = new Date(maxTime);
                const totalDays = Math.max(1, Math.round((maxDate.getTime() - minDate.getTime()) / 86400000) + 1);
                return { minDate, maxDate, totalDays };
            }, [allOwnerTasks]);

            const getDateRatio = (dateStr) => {
                if (!timelineBounds) return 0;
                const date = new Date(`${dateStr}T00:00:00`);
                if (Number.isNaN(date.getTime())) return 0;
                const diff = Math.round((date.getTime() - timelineBounds.minDate.getTime()) / 86400000);
                return Math.max(0, Math.min(1, diff / timelineBounds.totalDays));
            };

            const dateTicks = useMemo(() => {
                if (!timelineBounds) return [];
                const ticks = [];
                const d = new Date(timelineBounds.minDate.getTime());
                while (d <= timelineBounds.maxDate) {
                    ticks.push(new Date(d.getTime()));
                    d.setDate(d.getDate() + 7);
                }
                if (ticks.length === 0 || ticks[ticks.length - 1].getTime() !== timelineBounds.maxDate.getTime()) {
                    ticks.push(new Date(timelineBounds.maxDate.getTime()));
                }
                return ticks;
            }, [timelineBounds]);

            const formatDateLabel = (dateObj) => `${dateObj.getMonth() + 1}/${dateObj.getDate()}`;

            return (
                <div className="max-w-7xl mx-auto fade-in pb-20 space-y-6">
                    <header className="flex flex-col lg:flex-row lg:items-end justify-between gap-4">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800">Owner æ™‚ç¨‹ç¸½è¦½</h2>
                            <p className="text-slate-500 text-sm">ä¾è² è²¬äººæª¢è¦–æ¶‰å…¥ä»»å‹™ï¼Œæ©«è»¸æ—¥æœŸã€ç¸±è»¸å°ˆæ¡ˆ</p>
                        </div>
                        <div className="bg-white border border-slate-200 rounded-2xl p-3 flex items-center gap-3">
                            <label className="text-xs font-bold text-slate-500">é¸æ“‡ Owner</label>
                            <select
                                className="px-3 py-2 rounded-xl border border-slate-200 text-sm min-w-[180px] bg-white"
                                value={selectedOwner}
                                onChange={e => setSelectedOwner(e.target.value)}
                            >
                                {ownerOptions.length === 0 && <option value="">å°šç„¡ owner</option>}
                                {ownerOptions.map(owner => <option key={owner} value={owner}>{owner}</option>)}
                            </select>
                        </div>
                    </header>

                    {ownerOptions.length === 0 ? (
                        <div className="bg-white rounded-2xl border border-slate-200 p-12 text-center text-slate-400">
                            å°šæœªè¨­å®šä»»å‹™ ownerï¼Œè«‹å…ˆåˆ°ã€Œå°ˆæ¡ˆé€²åº¦ã€ç‚ºä»»å‹™å¡«å¯« ownerã€‚
                        </div>
                    ) : ownerProjects.length === 0 ? (
                        <div className="bg-white rounded-2xl border border-slate-200 p-12 text-center text-slate-400">
                            æ­¤ owner ç›®å‰æ²’æœ‰ä»»å‹™ã€‚
                        </div>
                    ) : (
                        <>
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="bg-white border border-slate-200 rounded-2xl p-4">
                                    <div className="text-xs text-slate-400 font-bold">æ¶‰åŠå°ˆæ¡ˆæ•¸</div>
                                    <div className="text-2xl font-black text-slate-800 mt-1">{ownerProjects.length}</div>
                                </div>
                                <div className="bg-white border border-slate-200 rounded-2xl p-4">
                                    <div className="text-xs text-slate-400 font-bold">ä»»å‹™ç¸½æ•¸</div>
                                    <div className="text-2xl font-black text-slate-800 mt-1">{allOwnerTasks.length}</div>
                                </div>
                                <div className="bg-white border border-slate-200 rounded-2xl p-4">
                                    <div className="text-xs text-slate-400 font-bold">æ—¥æœŸç¯„åœ</div>
                                    <div className="text-sm font-bold text-slate-700 mt-2">
                                        {timelineBounds ? `${timelineBounds.minDate.toISOString().split('T')[0]} ~ ${timelineBounds.maxDate.toISOString().split('T')[0]}` : '-'}
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white border border-slate-200 rounded-2xl overflow-hidden">
                                <div className="p-4 border-b border-slate-100 font-bold text-slate-700">å°ˆæ¡ˆ x æ—¥æœŸæ™‚ç¨‹åœ–</div>
                                <div className="overflow-x-auto">
                                    <div className="min-w-[1000px]">
                                        <div className="flex border-b border-slate-100 bg-slate-50">
                                            <div className="w-64 shrink-0 px-4 py-3 text-[11px] font-black text-slate-500 uppercase tracking-wider">å°ˆæ¡ˆ</div>
                                            <div className="flex-1 relative h-12">
                                                {dateTicks.map((tick, idx) => {
                                                    const left = `${getDateRatio(tick.toISOString().split('T')[0]) * 100}%`;
                                                    return (
                                                        <div key={`${tick.getTime()}_${idx}`} className="absolute top-0 h-full" style={{ left }}>
                                                            <div className="h-full border-l border-slate-200" />
                                                            <div className="absolute top-1 left-1 text-[10px] text-slate-400">{formatDateLabel(tick)}</div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>

                                        {ownerProjects.map(project => {
                                            const rowHeight = Math.max(44, project.tasks.length * 26 + 12);
                                            return (
                                                <div key={project.projectId} className="flex border-b border-slate-100 last:border-b-0">
                                                    <div className="w-64 shrink-0 px-4 py-3 border-r border-slate-100 bg-slate-50/50">
                                                        <div className="font-bold text-slate-700 text-sm truncate">{project.projectName}</div>
                                                        <div className="text-[10px] text-slate-400 mt-1">{project.tasks.length} é …ä»»å‹™</div>
                                                    </div>
                                                    <div className="flex-1 relative" style={{ height: `${rowHeight}px` }}>
                                                        {project.tasks.map((task, idx) => {
                                                            const startRatio = getDateRatio(task.start);
                                                            const endRatio = getDateRatio(task.end || task.start);
                                                            const widthRatio = Math.max(0.01, endRatio - startRatio + (1 / Math.max(1, timelineBounds?.totalDays || 1)));
                                                            const barColor = task.progress >= 100 ? 'bg-emerald-500' : task.progress >= 50 ? 'bg-blue-500' : 'bg-amber-500';
                                                            return (
                                                                <div
                                                                    key={task.id}
                                                                    className={`absolute h-5 rounded-md ${barColor} text-white text-[10px] leading-5 px-2 truncate shadow-sm`}
                                                                    style={{
                                                                        top: `${6 + idx * 24}px`,
                                                                        left: `${startRatio * 100}%`,
                                                                        width: `${Math.min(100, widthRatio * 100)}%`
                                                                    }}
                                                                    title={`${task.taskName} (${task.start} ~ ${task.end})`}
                                                                >
                                                                    {task.taskName}
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white border border-slate-200 rounded-2xl overflow-hidden">
                                <div className="p-4 border-b border-slate-100 font-bold text-slate-700">ä»»å‹™æ˜ç´°</div>
                                <div className="table-container max-h-[360px] overflow-y-auto">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-50 text-slate-500 sticky top-0">
                                            <tr>
                                                <th className="px-4 py-2">å°ˆæ¡ˆ</th>
                                                <th className="px-4 py-2">å·¥ä½œåŒ…</th>
                                                <th className="px-4 py-2">ä»»å‹™</th>
                                                <th className="px-4 py-2">èµ·æ—¥</th>
                                                <th className="px-4 py-2">è¿„æ—¥</th>
                                                <th className="px-4 py-2 text-right">é€²åº¦%</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {allOwnerTasks.map(task => (
                                                <tr key={task.id} className="hover:bg-slate-50">
                                                    <td className="px-4 py-2 font-medium text-slate-700">{task.projectName}</td>
                                                    <td className="px-4 py-2 text-slate-500">{task.wpName}</td>
                                                    <td className="px-4 py-2 text-slate-600">{task.taskName}</td>
                                                    <td className="px-4 py-2 text-slate-500 font-mono">{task.start}</td>
                                                    <td className="px-4 py-2 text-slate-500 font-mono">{task.end}</td>
                                                    <td className="px-4 py-2 text-right font-bold text-blue-600">{task.progress}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        const MainApp = () => {
const [showExportModal, setShowExportModal] = useState(false); // æ–°å¢é€™è¡Œ
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('events'); 
            const [loading, setLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [showDebug, setShowDebug] = useState(false);
            const [showCreateEvent, setShowCreateEvent] = useState(false);
            const [showAddPromise, setShowAddPromise] = useState(false); 
            const [showBulkImport, setShowBulkImport] = useState(false); 
            const [showScheduleModal, setShowScheduleModal] = useState(false); 
            const [scheduleDate, setScheduleDate] = useState(''); 
            const [editingEvent, setEditingEvent] = useState(null); 
            const [editingRow, setEditingRow] = useState(null); 
            const [eventsViewMode, setEventsViewMode] = useState('calendar');
            const [importSearch, setImportSearch] = useState(''); 
            const [promiseSearch, setPromiseSearch] = useState(''); 
            const [publicSearchTerm, setPublicSearchTerm] = useState(''); 
            const [globalRules, setGlobalRules] = useState(null); 
            const [showGlobalRules, setShowGlobalRules] = useState(false); 
            const [selectedPublicDate, setSelectedPublicDate] = useState(new Date().toISOString().split('T')[0]);
            const [editingProject, setEditingProject] = useState(null);
            const [tagDefinitions, setTagDefinitions] = useState(DEFAULT_TAG_DEFS);
            const [showTagSettings, setShowTagSettings] = useState(false);
            const [publicFilters, setPublicFilters] = useState({ level: [], type: [], location: [] });
            const [dbSource, setDbSource] = useState(() => localStorage.getItem('crm_db_source') || defaultAppId);
            const [isEditingCSV, setIsEditingCSV] = useState(false);
            const isEditingRef = useRef(false);
            const [csvInput, setCsvInput] = useState('');
            const [parsedData, setParsedData] = useState([]);
            const [eventConfigs, setEventConfigs] = useState({});
            const [customTemplates, setCustomTemplates] = useState([]);
            const [projects, setProjects] = useState([]); 
            const [promises, setPromises] = useState([]);
            const [instructorSchedule, setInstructorSchedule] = useState({}); 
            const [companyRestDates, setCompanyRestDates] = useState([]);
            const [newPasswordInput, setNewPasswordInput] = useState('');
            const [passwordSaveStatus, setPasswordSaveStatus] = useState('idle'); 
            const [addRegStatus, setAddRegStatus] = useState('idle'); 
            const [csvSaveStatus, setCsvSaveStatus] = useState('idle');
            const [viewMode, setViewMode] = useState('public');
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [adminPassword, setAdminPassword] = useState('');
            const [activeTaskDetail, setActiveTaskDetail] = useState(null);
            const [selectedCustomer, setSelectedCustomer] = useState('');
            const [currentDate, setCurrentDate] = useState(new Date());
            const [crmSearchTerm, setCrmSearchTerm] = useState('');
            const [showCrmDropdown, setShowCrmDropdown] = useState(false);
            const [newReg, setNewReg] = useState({ date: new Date().toISOString().split('T')[0], eventName: '', instructor: '', customerName: '', price: '', transport: '', idNo: '', birthday: '', email: '', source: '', orderDate: new Date().toISOString().split('T')[0], phone: '' });
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            
            // è·‘é¦¬ç‡ˆèˆ‡å‰ç¥¥ç‰© State
            const [latestNews, setLatestNews] = useState(''); 
            const [marqueeIconHistory, setMarqueeIconHistory] = useState([]);
            const [marqueeBgColor, setMarqueeBgColor] = useState('#0f172a'); 
            const [marqueeTextColor, setMarqueeTextColor] = useState('#ffffff'); 
            const [marqueeIconSize, setMarqueeIconSize] = useState(24);
            const [marqueeSpeed, setMarqueeSpeed] = useState(20); 
            const [marqueeIcon, setMarqueeIcon] = useState('');   
            const [dailyStats, setDailyStats] = useState({}); 
            const [mascotConfig, setMascotConfig] = useState([]); 
            const [showMascotSettings, setShowMascotSettings] = useState(false); 
            const [outingPosterConfig, setOutingPosterConfig] = useState(DEFAULT_OUTING_POSTER_CONFIG);
            const [showOutingPosterSettings, setShowOutingPosterSettings] = useState(false);
            const [outingDays, setOutingDays] = useState({});
            const [publicTheme, setPublicTheme] = useState(DEFAULT_PUBLIC_THEME);
            const [publicSideDecor, setPublicSideDecor] = useState(DEFAULT_PUBLIC_SIDE_DECOR);
            const [selectedOutingPosterRandom, setSelectedOutingPosterRandom] = useState(null);
            const [publicDateEntryNonce, setPublicDateEntryNonce] = useState(0);

            useVisitorTracker(db, dbSource, viewMode);

            const handleDbSourceChange = (newSource) => { setDbSource(newSource); localStorage.setItem('crm_db_source', newSource); };
            const uniqueTransports = useMemo(() => { const defaults = ['å…±ä¹˜', 'è‡ªè¡Œå‰å¾€']; const existing = new Set(parsedData.map(r => r.transport).filter(Boolean)); return Array.from(new Set([...defaults, ...existing])); }, [parsedData]);

            useEffect(() => { if (auth) { signInAnonymously(auth).catch(console.error); return onAuthStateChanged(auth, u => setUser(u)); } else { setUser({ isAnonymous: true, uid: 'demo' }); } }, []);
            
            useEffect(() => {
                if (!user) return;
                setLoading(true);
                const basePath = `artifacts/${dbSource}/public/data`;
                if (db) {
                    const settingsRef = doc(db, basePath, 'settings', 'auth');
                    if (settingsRef) { onSnapshot(settingsRef, s => { if (s && s.exists()) { setAdminPassword(s.data().password || '8888'); } else { setAdminPassword('8888'); } }); }
                    
                    const updateParsedData = (raw) => { 
                        try { 
                            const lines = raw.trim().split('\n'); 
                            const data = lines.slice(1).map((line, i) => { 
                                const v = line.split(','); 
                                if(v.length < 5) return null; 
                                return { 
                                    id: i, 
                                    date: v[0]?.trim(), 
                                    eventName: v[1]?.trim(), 
                                    instructor: v[2]?.trim(), 
                                    customerName: v[3]?.trim(), 
                                    price: parseInt(v[4])||0, 
                                    transport: v[5]?.trim(), 
                                    idNo: v[6]?.trim(), 
                                    birthday: v[7]?.trim(), 
                                    email: v[8]?.trim(), 
                                    source: v[9]?.trim(), 
                                    socialName: v[10]?.trim(), 
                                    notes: v[11]?.trim(), 
                                    orderDate: v[12]?.trim(), 
                                    phone: v[13]?.trim(), 
                                    isCheckedIn: v[14]?.trim() === '1' 
                                }; 
                            }).filter(row => row && row.date);
                            setParsedData(data); 
                        } catch(e) { console.error(e); } 
                    };

                    const mainRef = doc(db, basePath, 'settings', 'main');
                    const unsub1 = onSnapshot(mainRef, s => { 
                        if(s && s.exists()) { 
                            const data = s.data(); 
                            const d = data.csvData || ''; 
                            if (data.globalRules) setGlobalRules(data.globalRules); 
                            if (data.tagDefinitions) setTagDefinitions(data.tagDefinitions); 
                            
                            if (data.latestNews) setLatestNews(data.latestNews);
                            
                            if (data.marqueeSpeed) setMarqueeSpeed(data.marqueeSpeed);
                            if (data.marqueeIcon) setMarqueeIcon(data.marqueeIcon); 
                            if (data.marqueeIconHistory) setMarqueeIconHistory(data.marqueeIconHistory);
                            if (data.marqueeBgColor) setMarqueeBgColor(data.marqueeBgColor);
                            if (data.marqueeTextColor) setMarqueeTextColor(data.marqueeTextColor);
                            if (data.marqueeIconSize) setMarqueeIconSize(data.marqueeIconSize);
                            if (data.mascotConfig) setMascotConfig(data.mascotConfig); 
                            if (Array.isArray(data.outingPosterConfig)) setOutingPosterConfig(data.outingPosterConfig);
                            if (data.publicTheme) setPublicTheme(normalizePublicTheme(data.publicTheme));
                            if (data.publicSideDecor) setPublicSideDecor(normalizePublicSideDecor(data.publicSideDecor));
                            if (!isEditingRef.current) { 
                                setCsvInput(d); 
                                updateParsedData(d); 
                            } 
                        } 
                        setLoading(false); 
                    });
                    const templatesRef = doc(db, basePath, 'settings', 'templates');
                    const unsub2 = onSnapshot(templatesRef, s => { if(s && s.exists()) setCustomTemplates(s.data()?.list || []) });
                    const configsRef = collection(db, basePath, 'event_configs');
                    const unsub3 = onSnapshot(configsRef, s => { const cfgs = {}; if(s) s.forEach(d => cfgs[d.id] = d.data()); setEventConfigs(cfgs); });
                    const projectsRef = collection(db, basePath, 'projects');
                    const unsub4 = onSnapshot(projectsRef, s => { const p = []; if(s) s.forEach(d => p.push({id: d.id, ...d.data()})); setProjects(p); });
                    const promisesRef = collection(db, basePath, 'promises');
                    const unsub5 = onSnapshot(promisesRef, s => { const p = []; if(s) s.forEach(d => p.push({id: d.id, ...d.data()})); setPromises(p.sort((a,b) => new Date(a.date+'T'+a.time) - new Date(b.date+'T'+b.time))); });
                    const scheduleRef = doc(db, basePath, 'settings', 'schedule');
                    const unsub6 = onSnapshot(scheduleRef, s => {
                        if (s && s.exists()) {
                            setInstructorSchedule(s.data().resting || {});
                            setCompanyRestDates(s.data().companyRest || []);
                            setOutingDays(s.data().outingDays || {});
                        } else {
                            setOutingDays({});
                        }
                    });
                    
                    const todayStr = getLocalDateStr();
                    const analyticsRef = doc(db, `artifacts/${dbSource}/analytics`, 'stats', 'daily', todayStr);
                    const unsub7 = onSnapshot(analyticsRef, s => { if(s && s.exists()) setDailyStats(s.data() || {}); });

                    return () => { if(unsub1) unsub1(); if(unsub2) unsub2(); if(unsub3) unsub3(); if(unsub4) unsub4(); if(unsub5) unsub5(); if(unsub6) unsub6(); if(unsub7) unsub7(); };
                } else { setLoading(false); console.warn("Running in offline/demo mode"); }
            }, [user, dbSource]);

            const handleVerifyLogin = (inputPwd, callback) => { if (inputPwd === adminPassword) { setViewMode('admin'); setShowLoginModal(false); callback(true); } else { callback(false); } };
            const handleUpdatePassword = async () => { if (!newPasswordInput) return; setPasswordSaveStatus('saving'); try { const ref = doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'auth'); if(ref) await setDoc(ref, { password: newPasswordInput }, { merge: true }); setNewPasswordInput(''); setPasswordSaveStatus('success'); setTimeout(() => setPasswordSaveStatus('idle'), 2000); } catch (e) { console.error("Password update failed", e); setPasswordSaveStatus('idle'); } };
            const handleToggleInstructorRest = async (date, name) => { if (!user || !db) return; const currentResting = instructorSchedule[date] || []; let newResting; if (currentResting.includes(name)) { newResting = currentResting.filter(n => n !== name); } else { newResting = [...currentResting, name]; } const newSchedule = { ...instructorSchedule }; if (newResting.length > 0) { newSchedule[date] = newResting; } else { newSchedule[date] = []; } await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'schedule'), { resting: newSchedule }, { merge: true }); };
            const handleToggleCompanyRest = async (date) => { if (!user || !db) return; const isResting = companyRestDates.includes(date); let newDates; if (isResting) { newDates = companyRestDates.filter(d => d !== date); } else { newDates = [...companyRestDates, date].sort(); } setCompanyRestDates(newDates); await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'schedule'), { companyRest: newDates }, { merge: true }); };
            const handleToggleOutingDay = async (date) => {
                if (!user || !db) return;
                const current = outingDays[date];
                const next = { ...outingDays };
                if (current && current.enabled) {
                    delete next[date];
                } else {
                    next[date] = { enabled: true, posterFilename: current?.posterFilename || '', people: current?.people || [] };
                }
                setOutingDays(next);
                await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'schedule'), { outingDays: next }, { merge: true });
            };
            const handleSetOutingPoster = async (date, posterFilename) => {
                if (!user || !db) return;
                const next = {
                    ...outingDays,
                    [date]: { enabled: true, posterFilename: posterFilename || '', people: outingDays[date]?.people || [] }
                };
                setOutingDays(next);
                await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'schedule'), { outingDays: next }, { merge: true });
            };
            const handleToggleOutingPerson = async (date, name) => {
                if (!user || !db) return;
                const current = outingDays[date] || { enabled: true, posterFilename: '', people: [] };
                const currentPeople = Array.isArray(current.people) ? current.people : [];
                const nextPeople = currentPeople.includes(name)
                    ? currentPeople.filter(n => n !== name)
                    : [...currentPeople, name];
                const next = {
                    ...outingDays,
                    [date]: { enabled: true, posterFilename: current.posterFilename || '', people: nextPeople }
                };
                setOutingDays(next);
                await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'schedule'), { outingDays: next }, { merge: true });
            };
            const handleApplyThemePreset = (presetId) => {
                const preset = PUBLIC_THEME_PRESETS.find(p => p.id === presetId);
                if (preset) setPublicTheme(normalizePublicTheme(preset.values));
            };
            const handleSavePublicTheme = async () => {
                if (!user || !db) return alert("è«‹å…ˆç™»å…¥");
                await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'main'), { publicTheme: normalizePublicTheme(publicTheme) }, { merge: true });
                alert("å‰å°ä¸»é¡Œå·²æ›´æ–°ï¼");
            };
            const handleSavePublicSideDecor = async () => {
                if (!user || !db) return alert("è«‹å…ˆç™»å…¥");
                await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'main'), { publicSideDecor: normalizePublicSideDecor(publicSideDecor) }, { merge: true });
                alert("æ´»å‹•å ´æ¬¡è¡¨å·¦å³è£é£¾åœ–å·²æ›´æ–°ï¼");
            };
            const normalizeInstructor = (instructor) => (instructor || '').split(/[&,]/).map(s => s.trim()).filter(Boolean).sort().join(' & ');
            const buildEventKey = (date, eventName, instructor) => `${date || ''}_${eventName || ''}_${normalizeInstructor(instructor)}`.replace(/[\/\\#\?]/g, '-');
            const buildEventBaseKey = (date, eventName) => `${date || ''}__${eventName || ''}`;

            const mergeEventConfigData = (preferred, fallback) => {
                const p = preferred || {};
                const f = fallback || {};
                const merged = { ...f, ...p };
                const toList = (v) => Array.isArray(v) ? v.filter(Boolean) : [];
                const mergedLead = Array.from(new Set([...toList(f.leadInstructors), ...toList(p.leadInstructors)]));
                const mergedSupport = Array.from(new Set([...toList(f.supportInstructors), ...toList(p.supportInstructors)]));
                if (mergedLead.length > 0) merged.leadInstructors = mergedLead;
                if (mergedSupport.length > 0) merged.supportInstructors = mergedSupport;
                if (!Array.isArray(p.tasks) && Array.isArray(f.tasks)) merged.tasks = f.tasks;
                if (!Array.isArray(p.statusRules) && Array.isArray(f.statusRules)) merged.statusRules = f.statusRules;
                merged.tags = { ...(f.tags || {}), ...(p.tags || {}) };
                return merged;
            };

            const parseCsvRowsForSync = (rawCsv) => {
                const txt = String(rawCsv || '').trim();
                if (!txt) return [];
                const lines = txt.split('\n');
                return lines.slice(1).map(line => {
                    const v = line.split(',');
                    if (v.length < 2) return null;
                    return {
                        date: v[0]?.trim() || '',
                        eventName: v[1]?.trim() || '',
                        instructor: v[2]?.trim() || ''
                    };
                }).filter(r => r && r.date && r.eventName);
            };

            const syncEventConfigsByRows = async (oldRows, newRows) => {
                if (!db) return;
                const oldBaseMap = {};
                oldRows.forEach(r => {
                    const base = buildEventBaseKey(r.date, r.eventName);
                    const key = buildEventKey(r.date, r.eventName, r.instructor);
                    if (!oldBaseMap[base]) oldBaseMap[base] = new Set();
                    oldBaseMap[base].add(key);
                });
                const newBaseMap = {};
                newRows.forEach(r => {
                    const base = buildEventBaseKey(r.date, r.eventName);
                    const key = buildEventKey(r.date, r.eventName, r.instructor);
                    if (!newBaseMap[base]) newBaseMap[base] = new Set();
                    newBaseMap[base].add(key);
                });

                const writeJobs = [];
                Object.entries(newBaseMap).forEach(([base, keySet]) => {
                    const candidateOldKeys = Array.from(oldBaseMap[base] || []);
                    Array.from(keySet).forEach(newKey => {
                        const currentCfg = eventConfigs[newKey] || null;
                        let mergedCfg = currentCfg ? { ...currentCfg } : null;
                        candidateOldKeys.forEach(oldKey => {
                            const oldCfg = eventConfigs[oldKey];
                            if (!oldCfg) return;
                            mergedCfg = mergedCfg ? mergeEventConfigData(mergedCfg, oldCfg) : { ...oldCfg };
                        });
                        if (mergedCfg) {
                            writeJobs.push(setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'event_configs', newKey), mergedCfg, { merge: true }));
                        }
                    });
                });
                if (writeJobs.length > 0) await Promise.all(writeJobs);
            };

            const handleSaveCSV = async (newData) => {
                if(!user || !db) return;
                setCsvSaveStatus('saving');
                setIsSaving(true);
                try {
                    const oldRows = parsedData.map(r => ({ date: r.date, eventName: r.eventName, instructor: r.instructor }));
                    const newRowsForSync = parseCsvRowsForSync(newData);
                    isEditingRef.current = false;
                    await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'main'), { csvData: newData }, { merge: true });
                    await syncEventConfigsByRows(oldRows, newRowsForSync);
                    setCsvInput(newData);
                    setCsvSaveStatus('success');
                    setTimeout(() => setCsvSaveStatus('idle'), 3000);
                } catch(e) {
                    console.error(e);
                    setCsvSaveStatus('error');
                } finally {
                    setIsSaving(false);
                }
            };
            const arrayToCSV = (dataArray) => { let csv = CSV_HEADER + '\n'; dataArray.forEach(row => { const check = row.isCheckedIn ? '1' : '0'; const line = `${row.date||''},${row.eventName||''},${row.instructor||''},${row.customerName||''},${row.price||0},${row.transport||''},${row.idNo||''},${row.birthday||''},${row.email||''},${row.source||''},${row.socialName||''},${toCSVField(row.notes)},${row.orderDate||''},${row.phone||''},${check}`; csv += line + '\n'; }); return csv; };
            const handleUpdateRow = async (newRowData) => { 
                const newData = parsedData.map(row => row.id === newRowData.id ? newRowData : row); 
                await handleSaveCSV(arrayToCSV(newData)); 
                setEditingRow(null); 
            };
            const handleDeleteRow = async (id) => { if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ")) return; const newData = parsedData.filter(row => row.id !== id); await handleSaveCSV(arrayToCSV(newData)); };
            const handleBulkImport = async (newRows) => { const currentRows = [...parsedData]; const formattedNewRows = newRows.map(r => ({ date: r.date || '', eventName: r.eventName || '', instructor: r.instructor || '', customerName: r.customerName || '', price: r.price || 0, transport: '', idNo: r.idNo || '', birthday: r.birthday || '', email: r.email || '', source: r.source || '', socialName: r.socialName || '', notes: r.notes || '', orderDate: new Date().toISOString().split('T')[0], phone: r.phone || '' })); const finalData = [...currentRows, ...formattedNewRows]; await handleSaveCSV(arrayToCSV(finalData)); };
            const handleAddManualReg = async () => { if(!newReg.date || !newReg.eventName || !newReg.customerName) { return; } setAddRegStatus('saving'); let currentData = csvInput.trim(); if (!currentData || !currentData.startsWith("æ—¥æœŸ")) { currentData = CSV_HEADER + "\n" + currentData; } const newRow = `\n${newReg.date},${newReg.eventName},${newReg.instructor},${newReg.customerName},${newReg.price},${newReg.transport},${newReg.idNo},${newReg.birthday},${newReg.email},${newReg.source},,${newReg.orderDate},${newReg.phone},0`; const updatedCSV = currentData + newRow; await handleSaveCSV(updatedCSV); setNewReg({ date: '', eventName: '', instructor: '', customerName: '', price: '', transport: '', idNo: '', birthday: '', email: '', source: '', orderDate: new Date().toISOString().split('T')[0], phone: '' }); setAddRegStatus('success'); setTimeout(() => setAddRegStatus('idle'), 2000); };
            const handleAddDirectReg = async (eventInfo, customerData) => { let currentData = csvInput.trim(); if (!currentData || !currentData.startsWith("æ—¥æœŸ")) { currentData = CSV_HEADER + "\n" + currentData; } const newRow = `\n${eventInfo.date},${eventInfo.eventName},${eventInfo.instructor},${customerData.customerName},${customerData.price},${customerData.transport},${customerData.idNo},${customerData.birthday},${customerData.email},${customerData.source},,${toCSVField(customerData.notes)},${customerData.orderDate},${customerData.phone},0`; const updatedCSV = currentData + newRow; await handleSaveCSV(updatedCSV); };
            // æ‰¾åˆ°åŸæœ‰çš„ handleCreateEventï¼Œä¸¦æ›´æ–°è§£æ§‹èˆ‡å„²å­˜é‚è¼¯
const handleCreateEvent = async ({ dates, eventName, instructors, time, link, displayName, activityCategory, tags, capacity, backendColor, statusRules, price }) => { // é€™è£¡åŠ å…¥ price
    let rows = ''; 
    const instr = [...instructors].sort().join(' & ');
    dates.forEach(d => rows += `\n${d},${eventName},${instr},é–‹æ”¾å ±åä¸­,0,,,,,,,,,0`); 
    await handleSaveCSV(csvInput + rows); 
    const batch = writeBatch(db); 
    dates.forEach(d => { 
        const key = `${d}_${eventName}_${instr}`.replace(/[\/\\#\?]/g, '-'); 
        const ref = doc(db, `artifacts/${dbSource}/public/data`, 'event_configs', key); 
        setDoc(ref, { 
            time: time || '', 
            link: link || '', 
            displayName: displayName || '', 
            activityCategory: activityCategory || '', 
            capacity: parseInt(capacity) || 12, 
            price: parseInt(price) || 0, // å„²å­˜åƒ¹æ ¼
            tags: tags || { levels: '', types: '', locations: '' },
            backendColor: backendColor || '#eff6ff',
            statusRules: statusRules || [],
            leadInstructors: instructors || [],
            supportInstructors: [],
            isCancelled: false
        }, { merge: true }); 
    }); 
    await batch.commit(); 
    setShowCreateEvent(false); 
};
            const handleCheckInToggle = async (customerId, currentStatus) => { const row = parsedData.find(r => r.id === customerId); if (row) { await handleUpdateRow({ ...row, isCheckedIn: !currentStatus }); } };
            const handleSaveEventConfig = async (oldEventKey, newConfig, newInstructorStr, newInternalName) => { 
    // 1. æ›´æ–°æ‰€æœ‰å ±åè¡Œ
    const newRows = parsedData.map(r => { 
        const sortedInstr = r.instructor ? r.instructor.split(/[&,]/).map(s=>s.trim()).sort().join(' & ') : '';
        const key = `${r.date}_${r.eventName}_${sortedInstr}`.replace(/[\/\\#\?]/g, '-'); 
        
        if (key === oldEventKey) { 
            return { 
                ...r, 
                instructor: newInstructorStr !== undefined ? newInstructorStr : r.instructor,
                eventName: newInternalName || r.eventName 
            }; 
        } 
        return r; 
    }); 

    await handleSaveCSV(arrayToCSV(newRows)); 
    
    // 2. æ›´æ–° Firestore Config
    const finalName = newInternalName || editingEvent.eventName;
    const finalInstr = newInstructorStr !== undefined ? newInstructorStr : editingEvent.instructor;
    const newKey = `${editingEvent.date}_${finalName}_${finalInstr}`.replace(/[\/\\#\?]/g, '-');

    const oldCfg = eventConfigs[oldEventKey] || {};
    const editedCfg = mergeEventConfigData(newConfig, oldCfg);
    if (newKey !== oldEventKey) {
        const targetCfg = eventConfigs[newKey] || {};
        const mergedToNewKey = mergeEventConfigData(targetCfg, editedCfg);
        await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'event_configs', newKey), mergedToNewKey, { merge: true });
        await deleteDoc(doc(db, `artifacts/${dbSource}/public/data`, 'event_configs', oldEventKey));
    } else {
        await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'event_configs', oldEventKey), editedCfg, { merge: true }); 
    }
};
            const handleSaveTemplate = (tpl) => { let newList; if (tpl.id) { newList = customTemplates.map(t => t.id === tpl.id ? tpl : t); } else { newList = [...customTemplates, { ...tpl, id: `custom_${Date.now()}` }]; } setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'templates'), { list: newList }, { merge: true }); };
            const handleAddTemplate = (tpl) => handleSaveTemplate(tpl);
            const onDeleteTemplate = (id) => { if(confirm("ç¢ºå®šåˆªé™¤?")) setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'templates'), { list: customTemplates.filter(t=>t.id!==id) }, { merge: true }); };
            const handleUpdateProject = async (pid, newData) => { await updateDoc(doc(db, `artifacts/${dbSource}/public/data`, 'projects', pid), newData); };
            const handleProjectStatus = async (pid, status) => { const next = status === 'Stuck' ? 'To Do' : status === 'To Do' ? 'In Progress' : status === 'In Progress' ? 'Done' : 'Stuck'; await updateDoc(doc(db, `artifacts/${dbSource}/public/data`, 'projects', pid), { status: next }); };
            const handleAddProject = async () => { const name = prompt("å°ˆæ¡ˆåç¨±:"); if(name) await addDoc(collection(db, `artifacts/${dbSource}/public/data`, 'projects'), { name, owner: 'Team', status: 'To Do', deadline: new Date().toISOString().split('T')[0], subTasks: [], cloudLink: '' }); };
            const handleDeleteProject = async (pid) => { await deleteDoc(doc(db, `artifacts/${dbSource}/public/data`, 'projects', pid)); };
            const handleAddPromise = async (data) => { await addDoc(collection(db, `artifacts/${dbSource}/public/data`, 'promises'), { ...data, status: 'pending', createdAt: new Date().toISOString() }); setShowAddPromise(false); };
            const handleTogglePromise = async (id, currentStatus) => { await updateDoc(doc(db, `artifacts/${dbSource}/public/data`, 'promises', id), { status: currentStatus === 'done' ? 'pending' : 'done' }); };
            const handleDeletePromise = async (id) => { if(confirm("åˆªé™¤æ­¤æ‰¿è«¾ï¼Ÿ")) await deleteDoc(doc(db, `artifacts/${dbSource}/public/data`, 'promises', id)); };
            const handleDeleteEvent = async () => { 
                if (!editingEvent) return; 
                const { date, eventName, instructor, key } = editingEvent; 
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${date} ${eventName}ã€å—ï¼Ÿ\nâš ï¸ è­¦å‘Šï¼šé€™å°‡æœƒåˆªé™¤è©²å ´æ¬¡çš„æ‰€æœ‰å ±åè³‡æ–™ï¼Œç„¡æ³•å¾©åŸï¼`)) return; 
                
                const newRows = parsedData.filter(r => { 
                    const sortedInstr = r.instructor ? r.instructor.split(/[&,]/).map(s=>s.trim()).sort().join(' & ') : '';
                    const rowKey = `${r.date}_${r.eventName}_${sortedInstr}`.replace(/[\/\\#\?]/g, '-'); 
                    return rowKey !== key; 
                }); 
                
                await handleSaveCSV(arrayToCSV(newRows)); 
                try { await deleteDoc(doc(db, `artifacts/${dbSource}/public/data`, 'event_configs', key)); } catch(e) { console.log('Config removal optional', e); } 
                setEditingEvent(null); 
            };
            const handleAddTagDefinition = async (type, newValue) => { const currentList = tagDefinitions[type] || []; if (currentList.includes(newValue)) return; const newDefs = { ...tagDefinitions, [type]: [...currentList, newValue] }; setTagDefinitions(newDefs); await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'main'), { tagDefinitions: newDefs }, { merge: true }); };

            const handleInitializeAnalytics = async () => {
                if (!db || !user) return alert("è³‡æ–™åº«æœªé€£ç·š");
                if (!confirm("ç¢ºå®šè¦åˆå§‹åŒ–æµé‡çµ±è¨ˆè³‡æ–™åº«å—ï¼Ÿ")) return;
                
                try {
                    const batch = writeBatch(db);
                    const basePath = `artifacts/${dbSource}/analytics`;
                    const todayStr = new Date().toISOString().slice(0, 10);

                    const totalRef = doc(db, basePath, 'stats', 'overview', 'total');
                    batch.set(totalRef, { count: 0 }, { merge: true });
                    
                    const dailyRef = doc(db, basePath, 'stats', 'daily', todayStr);
                    batch.set(dailyRef, { count: 0 }, { merge: true });

                    const testSessionRef = doc(db, basePath, 'traffic', 'sessions', `init_${Date.now()}`);
                    batch.set(testSessionRef, {
                        startTime: new Date().toISOString(),
                        date: todayStr,
                        device: 'System',
                        lastAction: 'ç³»çµ±åˆå§‹åŒ–å»ºç«‹',
                        durationSeconds: 1,
                        userAgent: 'System Admin Tool',
                        lastActive: new Date().toISOString()
                    });

                    await batch.commit();
                    alert("âœ… åˆå§‹åŒ–æˆåŠŸï¼è«‹åˆ‡æ›è‡³ã€Œæµé‡åˆ†æã€é ç±¤æŸ¥çœ‹ã€‚");
                } catch (e) {
                    console.error(e);
                    alert("âŒ åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Console éŒ¯èª¤è¨Šæ¯");
                }
            };
            const stats = useMemo(() => { const totalRev = parsedData.reduce((a,c) => a + c.price, 0); const events = {}; const instrs = {}; parsedData.forEach(c => { const sortedInstr = c.instructor ? c.instructor.split(/[&,]/).map(s=>s.trim()).sort().join(' & ') : '';
const key = `${c.date}_${c.eventName}_${sortedInstr}`.replace(/[\/\\#\?]/g, '-'); if(!events[key]) events[key] = { ...c, count: 0, customers: [], key }; if(c.customerName !== 'é–‹æ”¾å ±åä¸­') { events[key].count++; events[key].customers.push(c); } if(c.instructor) c.instructor.split(/[&,]/).forEach(i => { const name = i.trim(); if(name && name !== 'æœªå®š') instrs[name] = (instrs[name]||0)+1; }); }); return { totalRev, totalPax: parsedData.length, events, instrs }; }, [parsedData]);
            const dashboardData = useMemo(() => { const now = new Date(); const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; const monthlyGroups = {}; parsedData.forEach(c => { if (!c.date) return; const m = c.date.substring(0, 7); if (c.customerName === 'é–‹æ”¾å ±åä¸­') return; if (!monthlyGroups[m]) monthlyGroups[m] = []; monthlyGroups[m].push(c); }); const currentMonthData = monthlyGroups[currentMonthStr] || []; const currentMonthRev = currentMonthData.reduce((a,c)=>a+c.price,0); const currentMonthPax = currentMonthData.length; return { monthlyGroups, currentMonthRev, currentMonthPax }; }, [parsedData]);
            const tasks = useMemo(() => { const list = []; Object.values(stats.events).forEach(evt => { const cfg = eventConfigs[evt.key] || {}; const tList = cfg.tasks || DEFAULT_TASKS_TEMPLATE; tList.forEach((t, i) => { if(!t.completed) list.push({ ...t, taskIdx: i, evtDate: evt.date, evtName: evt.eventName, cfgKey: evt.key, style: getTaskStatusStyle(t.type, evt.date), fullEvent: evt }); }); }); return list.sort((a,b) => new Date(a.evtDate) - new Date(b.evtDate)); }, [stats.events, eventConfigs]);
            const toggleTask = async (key, idx) => { const cfg = eventConfigs[key] || {}; const tList = cfg.tasks || JSON.parse(JSON.stringify(DEFAULT_TASKS_TEMPLATE)); tList[idx].completed = !tList[idx].completed; await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'event_configs', key), { ...cfg, tasks: tList }, { merge: true }); };

            const [ltvTimeframe, setLtvTimeframe] = useState('all'); 
            const ltvStats = useMemo(() => { const now = new Date(); const map = {}; const countMap = {}; let periodRevenue = 0; let periodPax = 0; parsedData.forEach(d => { const name = d.customerName; if (!name || name === 'é–‹æ”¾å ±åä¸­') return; let include = true; if (ltvTimeframe !== 'all') { const date = new Date(d.date); const diffTime = Math.abs(now - date); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if (ltvTimeframe === 'year' && diffDays > 365) include = false; if (ltvTimeframe === 'quarter' && diffDays > 90) include = false; if (ltvTimeframe === 'month' && diffDays > 30) include = false; } if (include) { const price = parseInt(d.price) || 0; map[name] = (map[name] || 0) + price; countMap[name] = (countMap[name] || 0) + 1; periodRevenue += price; periodPax++; } }); const sortedCustomers = Object.keys(map).sort((a, b) => map[b] - map[a]); const activeCustomerCount = sortedCustomers.length; const avgLtv = activeCustomerCount > 0 ? Math.round(periodRevenue / activeCustomerCount) : 0; return { map, countMap, sortedCustomers, avgLtv, periodRevenue, activeCustomerCount }; }, [parsedData, ltvTimeframe]);
            const filteredCrmCustomers = ltvStats.sortedCustomers.filter(c => c.toLowerCase().includes(crmSearchTerm.toLowerCase()));
            const customerProfile = useMemo(() => { if (!selectedCustomer) return null; const history = parsedData.filter(d => d.customerName === selectedCustomer); const totalSpend = history.reduce((a,c)=>a+c.price,0); const avgSpend = history.length ? Math.round(totalSpend / history.length) : 0; const lastReg = history[history.length-1]; return { history, totalSpend, avgSpend, email: lastReg?.email, source: lastReg?.source, idNo: lastReg?.idNo, birthday: lastReg?.birthday, transport: lastReg?.transport, phone: lastReg?.phone, socialName: lastReg?.socialName, notes: lastReg?.notes, latestRecord: lastReg }; }, [selectedCustomer, parsedData]);
            const calendarDays = useMemo(() => { const year = currentDate.getFullYear(); const month = currentDate.getMonth(); const daysInMonth = getDaysInMonth(year, month); const firstDay = getFirstDayOfMonth(year, month); return Array(firstDay).fill(null).concat([...Array(daysInMonth).keys()].map(i => i + 1)); }, [currentDate]);
            
            // [ä¿®æ­£] è¨ˆç®—æœˆæ›†æ¯å¤©çš„ä½”ç”¨æƒ…å½¢ (åŒ…å«è·¨æ—¥èˆ‡å‰ç½®) - å¢åŠ æ—¥æœŸæª¢æŸ¥èˆ‡æ’åº
            const calendarOccupancy = useMemo(() => {
                const map = {};
                Object.values(stats.events).forEach(evt => {
                    if (!evt.date) return;
                    const mainDate = new Date(evt.date);
                    if (isNaN(mainDate.getTime())) return;

                    const cfg = eventConfigs[evt.key] || {};
                    const duration = parseInt(cfg.duration) || 1;
                    const prepDays = parseInt(cfg.prepDays) || 0;
                    const prepTime = cfg.prepTime || '09:00'; // é è¨­å‰ç½®æ™‚é–“
                    const mainTime = cfg.time || '23:59';     // é è¨­æ´»å‹•æ™‚é–“

                    // 1. å‰ç½®
                    for (let i = prepDays; i > 0; i--) {
                        const d = new Date(mainDate);
                        d.setDate(d.getDate() - i);
                        const dateStr = d.toISOString().split('T')[0];
                        if (!map[dateStr]) map[dateStr] = [];
                        map[dateStr].push({ 
                            type: 'prep', evt, cfg, 
                            displayTime: prepTime, // ç¶å®šå‰ç½®æ™‚é–“
                            label: `âš ï¸ å‰ç½®: ${evt.eventName}` 
                        });
                    }

                    // 2. ä¸»æ´»å‹•èˆ‡è·¨æ—¥
                    for (let i = 0; i < duration; i++) {
                        const d = new Date(mainDate);
                        d.setDate(d.getDate() + i);
                        const dateStr = d.toISOString().split('T')[0];
                        if (!map[dateStr]) map[dateStr] = [];
                        
                        if (i === 0) {
                            map[dateStr].push({ type: 'main', evt, cfg, displayTime: mainTime });
                        } else {
                            map[dateStr].push({ 
                                type: 'cont', evt, cfg, 
                                displayTime: '00:00', // è·¨æ—¥é€šå¸¸ç½®é ‚
                                label: `â†³ D${i+1}: ${evt.eventName}` 
                            });
                        }
                    }
                });

                // é‡å°æ¯ä¸€å¤©é€²è¡Œæ™‚é–“æ’åº
                Object.keys(map).forEach(date => {
                    map[date].sort((a, b) => a.displayTime.localeCompare(b.displayTime));
                });

                return map;
            }, [stats.events, eventConfigs]);

            const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
            const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            const groupedTasks = useMemo(() => { return tasks.reduce((acc, task) => { const groupKey = task.name; if (!acc[groupKey]) acc[groupKey] = []; acc[groupKey].push(task); return acc; }, {}); }, [tasks]);
            const checkEventMatchesFilters = (eventKey, filters = publicFilters) => { if (filters.level.length === 0 && filters.type.length === 0 && filters.location.length === 0) return true; const cfg = eventConfigs[eventKey] || {}; const tags = cfg.tags || {}; const matchLevel = filters.level.length === 0 || filters.level.includes(tags.levels); const matchType = filters.type.length === 0 || filters.type.includes(tags.types); const matchLocation = filters.location.length === 0 || filters.location.includes(tags.locations); return matchLevel && matchType && matchLocation; };
            const availableOptions = useMemo(() => { const result = { levels: new Set(), types: new Set(), locations: new Set() }; const allEvents = Object.values(stats.events); allEvents.forEach(e => { const cfg = eventConfigs[e.key] || {}; const t = cfg.tags || {}; const matchType = publicFilters.type.length === 0 || publicFilters.type.includes(t.types); const matchLocation = publicFilters.location.length === 0 || publicFilters.location.includes(t.locations); if (matchType && matchLocation && t.levels) result.levels.add(t.levels); }); allEvents.forEach(e => { const cfg = eventConfigs[e.key] || {}; const t = cfg.tags || {}; const matchLevel = publicFilters.level.length === 0 || publicFilters.level.includes(t.levels); const matchLocation = publicFilters.location.length === 0 || publicFilters.location.includes(t.locations); if (matchLevel && matchLocation && t.types) result.types.add(t.types); }); allEvents.forEach(e => { const cfg = eventConfigs[e.key] || {}; const t = cfg.tags || {}; const matchLevel = publicFilters.level.length === 0 || publicFilters.level.includes(t.levels); const matchType = publicFilters.type.length === 0 || publicFilters.type.includes(t.types); if (matchLevel && matchType && t.locations) result.locations.add(t.locations); }); return result; }, [stats.events, eventConfigs, publicFilters]);
            const matchingDates = useMemo(() => { const filtersActive = publicFilters.level.length > 0 || publicFilters.type.length > 0 || publicFilters.location.length > 0; if (!publicSearchTerm && !filtersActive) return []; return Object.values(stats.events).filter(e => { const cfg = eventConfigs[e.key] || {}; const nameToCheck = cfg.displayName || e.eventName; if (!checkEventMatchesFilters(e.key)) return false; if (publicSearchTerm) { return nameToCheck.includes(publicSearchTerm) || (e.instructor && e.instructor.includes(publicSearchTerm)); } return true; }).map(e => e.date).sort(); }, [publicSearchTerm, stats.events, eventConfigs, publicFilters]);
            const matchingMonths = useMemo(() => { const months = new Set(matchingDates.map(d => d.substring(0, 7))); return Array.from(months); }, [matchingDates]);
            const toggleFilter = (type, value) => { setPublicFilters(prev => { const list = prev[type]; if (list.includes(value)) { return { ...prev, [type]: list.filter(item => item !== value) }; } else { return { ...prev, [type]: [...list, value] }; } }); };
            const clearFilters = () => setPublicFilters({ level: [], type: [], location: [] });
            const hasActiveFilters = publicFilters.level.length > 0 || publicFilters.type.length > 0 || publicFilters.location.length > 0;

            useEffect(() => {
                const selectedOuting = outingDays[selectedPublicDate];
                if (!selectedOuting?.enabled || selectedOuting?.posterFilename) {
                    setSelectedOutingPosterRandom(null);
                    return;
                }
                setSelectedOutingPosterRandom(prev => {
                    const nextPoster = getWeightedOutingPoster(outingPosterConfig, prev?.filename || null);
                    return nextPoster || null;
                });
            }, [selectedPublicDate, outingDays, outingPosterConfig, publicDateEntryNonce]);

            if(loading) return <div className="min-h-screen flex items-center justify-center bg-slate-50 text-slate-400"><Icon name="loader-2" className="animate-spin mr-2"/> è¼‰å…¥ä¸­...</div>;
            const activeEditingEvent = editingEvent && stats.events[editingEvent.key] ? stats.events[editingEvent.key] : editingEvent;

                if (viewMode === 'public') {
                    // [ä¿®æ”¹] æ”¹ç”¨ calendarOccupancy å–å¾—è©²æ—¥æ‰€æœ‰äº‹é … (å«ä¸»æ´»å‹•ã€å‰ç½®ã€è·¨æ—¥)
                    const selectedDayItems = (calendarOccupancy[selectedPublicDate] || []).filter(item => checkEventMatchesFilters(item.evt.key));
                    const selectedOuting = outingDays[selectedPublicDate];
                    const isSelectedOutingDay = !!selectedOuting?.enabled;
                    const selectedOutingPoster = isSelectedOutingDay
                        ? (selectedOuting?.posterFilename
                            ? { filename: selectedOuting.posterFilename, label: 'æŒ‡å®šå ´åˆŠ' }
                            : selectedOutingPosterRandom)
                        : null;
                    const currentMonthStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`;
                    const appliedTheme = normalizePublicTheme(publicTheme);
                    const appliedSideDecor = normalizePublicSideDecor(publicSideDecor);
                    
                    return (
                    <div className="min-h-screen pb-20 relative" style={{ background: `linear-gradient(180deg, ${appliedTheme.pageBg} 0%, ${appliedTheme.pageBgAlt} 100%)`, color: appliedTheme.textColor }}>
                        <nav className="glass-nav sticky top-0 z-50 px-6 py-4 flex justify-between items-center relative" style={{ backgroundColor: `${appliedTheme.surfaceBg}f2`, borderBottomColor: appliedTheme.surfaceBorder }}><Logo className="h-8 w-auto" /><button onClick={() => setShowLoginModal(true)} className="text-sm flex items-center gap-1 px-3 py-1.5 rounded-lg transition-colors" style={{ color: appliedTheme.textColor, backgroundColor: 'transparent' }} onMouseEnter={(e) => e.currentTarget.style.color = appliedTheme.accentColor} onMouseLeave={(e) => e.currentTarget.style.color = appliedTheme.textColor}><Icon name="lock" size={14}/> ç®¡ç†å“¡ç™»å…¥</button></nav>
                        {latestNews && (
                            <div className="overflow-hidden py-2 relative z-40 marquee-container border-b border-slate-700 shadow-sm" style={{ backgroundColor: marqueeBgColor, color: marqueeTextColor }}>
                                <div className="animate-marquee font-bold text-sm tracking-wide flex items-center" style={{ animationDuration: `${marqueeSpeed}s` }}>
                                    {marqueeIcon && (<img src={marqueeIcon} className="w-auto mr-3 -mt-1 pixel-art inline-block" style={{ height: `${marqueeIconSize}px` }} alt="icon" />)}
                                    <span className="text-yellow-400 mr-2"> æœ€æ–°æ¶ˆæ¯ï¼š</span>
                                    {latestNews}
                                </div>
                            </div>
                        )}
                        
                        <div className="bg-amber-50 text-amber-800 text-xs py-2 px-4 text-center font-bold border-b border-amber-100 flex items-center justify-center gap-2 relative z-10"><Icon name="alert-circle" size={14}/> ç³»çµ±äººæ•¸æ›´æ–°å¯èƒ½æœ‰å»¶é²ï¼Œæº–ç¢ºåé¡è«‹ä»¥é»æ“Šã€Œå‰å¾€å ±åã€å¾Œçš„è¡¨å–®ç‚ºä¸»</div>
                        <main className="max-w-6xl mx-auto p-6 relative z-10">
                            <div className="max-w-2xl mx-auto relative z-10">
                            <div className="mb-6 text-center relative schedule-title-wrap">
                                {appliedSideDecor.leftImage && (
                                    <img
                                        src={appliedSideDecor.leftImage}
                                        alt="left decor"
                                        className="absolute schedule-side-decor schedule-side-decor-left"
                                        style={{
                                            left: `calc(-${Number(appliedSideDecor.width || 180)}px - ${Number(appliedSideDecor.offsetX || 24)}px)`,
                                            bottom: `${-Number(appliedSideDecor.offsetY || 0)}px`,
                                            width: `${appliedSideDecor.width}px`,
                                            '--decor-mobile-width': `${Number(appliedSideDecor.mobileWidth || appliedSideDecor.width || 180)}px`,
                                            opacity: Number(appliedSideDecor.opacity) || 1
                                        }}
                                    />
                                )}
                                {appliedSideDecor.rightImage && (
                                    <img
                                        src={appliedSideDecor.rightImage}
                                        alt="right decor"
                                        className="absolute schedule-side-decor schedule-side-decor-right"
                                        style={{
                                            right: `calc(-${Number(appliedSideDecor.width || 180)}px - ${Number(appliedSideDecor.offsetX || 24)}px)`,
                                            bottom: `${-Number(appliedSideDecor.offsetY || 0)}px`,
                                            width: `${appliedSideDecor.width}px`,
                                            '--decor-mobile-width': `${Number(appliedSideDecor.mobileWidth || appliedSideDecor.width || 180)}px`,
                                            opacity: Number(appliedSideDecor.opacity) || 1
                                        }}
                                    />
                                )}
                                <h1 className="text-2xl font-bold mb-2" style={{ color: appliedTheme.titleColor }}>æ´»å‹•å ´æ¬¡è¡¨</h1><p className="text-sm" style={{ color: appliedTheme.textColor }}>æ­¡è¿æŸ¥çœ‹æœ€æ–°çš„æ´»å‹•è³‡è¨Š</p>
                            </div>
                            <div className="relative mb-2"><Icon name="search" className="absolute left-4 top-3 text-slate-400" size={20}/><input type="text" placeholder="æœå°‹æ´»å‹•é—œéµå­—..." className="w-full pl-12 pr-4 py-3 border-none rounded-2xl outline-none focus:ring-2 transition-all" style={{ backgroundColor: `${appliedTheme.surfaceBg}`, color: appliedTheme.textColor, boxShadow: `0 0 0 1px ${appliedTheme.surfaceBorder} inset`, '--tw-ring-color': appliedTheme.accentColor }} value={publicSearchTerm} onChange={e => setPublicSearchTerm(e.target.value)} /></div>
                            
                            <div className="mb-6 p-5 rounded-2xl border shadow-sm" style={{ backgroundColor: appliedTheme.surfaceBg, borderColor: appliedTheme.surfaceBorder }}><div className="flex justify-between items-center mb-4"><h3 className="text-sm font-bold flex items-center gap-2" style={{ color: appliedTheme.titleColor }}><Icon name="filter" size={18} className="text-blue-500"/> æ´»å‹•ç¯©é¸</h3>{hasActiveFilters && (<button onClick={clearFilters} className="text-xs text-red-500 hover:bg-red-50 px-2 py-1 rounded-lg transition-colors flex items-center gap-1"><Icon name="x" size={14}/> é‡ç½®æ¢ä»¶</button>)}</div><div className="space-y-4"><div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4"><span className="text-xs font-bold text-slate-400 w-12 shrink-0 flex items-center gap-1"><Icon name="bar-chart-2" size={12}/> ç­‰ç´š</span><div className="flex flex-wrap gap-2">{(tagDefinitions.levels || []).map(t => { const isActive = publicFilters.level.includes(t); const isAvailable = availableOptions.levels.has(t); return ( <button key={t} onClick={() => toggleFilter('level', t)} disabled={!isAvailable && !isActive} className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all border ${ isActive ? 'bg-blue-600 text-white border-blue-600 shadow-md ring-2 ring-blue-100' : !isAvailable ? 'bg-slate-50 text-slate-300 border-slate-100 cursor-not-allowed' : 'bg-slate-50 text-slate-600 border-slate-200 hover:bg-white hover:border-blue-300' }`} > {t} </button> ); })}</div></div><div className="border-t border-slate-50 my-2"></div><div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4"><span className="text-xs font-bold text-slate-400 w-12 shrink-0 flex items-center gap-1"><Icon name="tag" size={12}/> ç¨®é¡</span><div className="flex flex-wrap gap-2">{(tagDefinitions.types || []).map(t => { const isActive = publicFilters.type.includes(t); const isAvailable = availableOptions.types.has(t); return ( <button key={t} onClick={() => toggleFilter('type', t)} disabled={!isAvailable && !isActive} className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all border ${ isActive ? 'bg-emerald-600 text-white border-emerald-600 shadow-md ring-2 ring-emerald-100' : !isAvailable ? 'bg-slate-50 text-slate-300 border-slate-100 cursor-not-allowed' : 'bg-slate-50 text-slate-600 border-slate-200 hover:bg-white hover:border-emerald-300' }`} > {t} </button> ); })}</div></div><div className="border-t border-slate-50 my-2"></div><div className="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4"><span className="text-xs font-bold text-slate-400 w-12 shrink-0 flex items-center gap-1"><Icon name="map-pin" size={12}/> åœ°é»</span><div className="flex flex-wrap gap-2">{(tagDefinitions.locations || []).map(t => { const isActive = publicFilters.location.includes(t); const isAvailable = availableOptions.locations.has(t); return ( <button key={t} onClick={() => toggleFilter('location', t)} disabled={!isAvailable && !isActive} className={`px-3 py-1.5 rounded-lg text-xs font-medium transition-all border ${ isActive ? 'bg-purple-600 text-white border-purple-600 shadow-md ring-2 ring-purple-100' : !isAvailable ? 'bg-slate-50 text-slate-300 border-slate-100 cursor-not-allowed' : 'bg-slate-50 text-slate-600 border-slate-200 hover:bg-white hover:border-purple-300' }`} > {t} </button> ); })}</div></div></div></div>

                            {/* æœˆæ›†æœå°‹çµæœæç¤º (ä¿æŒåŸæ¨£) */}
                            {(publicSearchTerm || hasActiveFilters) && matchingMonths.length > 0 && (<div className="mb-6 flex flex-wrap gap-2 animate-in fade-in slide-in-from-top-2"><span className="text-xs text-slate-400 py-1.5 flex items-center"><Icon name="search" size={12} className="mr-1"/> ç¬¦åˆæ¢ä»¶çš„æœˆä»½ï¼š</span>{matchingMonths.sort().map(m => { const isCurrentView = m === currentMonthStr; return (<button key={m} onClick={() => { const [y, mon] = m.split('-'); setCurrentDate(new Date(parseInt(y), parseInt(mon)-1, 1)); }} className={`text-xs px-3 py-1.5 rounded-full font-bold transition-all flex items-center gap-1 ${isCurrentView ? 'bg-slate-800 text-white shadow-md ring-2 ring-slate-200' : 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200'}`} >{m} {!isCurrentView && <Icon name="arrow-right" size={12}/>}</button>); })}</div>)}
                            
                            {/* [ä¿®æ”¹] åœ–ä¾‹èªªæ˜ï¼šå¢åŠ ã€Œé¡æ»¿ã€ */}
                            {!publicSearchTerm && !hasActiveFilters && <div className="flex justify-center gap-4 mb-4 text-xs text-slate-400"><div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-500"></span> æœ‰æ´»å‹•</div><div className="flex items-center gap-1"><span className="text-red-500 font-bold text-[10px]">é¡æ»¿</span> å·²é¡æ»¿</div><div className="flex items-center gap-1"><span className="text-amber-500 font-bold text-[10px]">å¤–å‡º</span> å–æä¸­</div><div className="flex items-center gap-1"><span className="text-slate-300 font-bold">âœ•</span> å…¬ä¼‘</div></div>}
                            
                            {/* æœˆæ›†æœ¬é«” */}
                            <div className="rounded-3xl shadow-lg border overflow-hidden mb-8" style={{ backgroundColor: appliedTheme.surfaceBg, borderColor: appliedTheme.surfaceBorder }}>
                                <div className="p-4 border-b flex justify-between items-center" style={{ borderColor: appliedTheme.surfaceBorder, backgroundColor: `${appliedTheme.surfaceBg}cc` }}>
                                    <div className="flex items-center gap-4 w-full justify-between px-2">
                                        <button onClick={prevMonth} className="p-2 hover:bg-white hover:shadow-sm rounded-full transition-all text-slate-500"><Icon name="chevron-left"/></button>
                                        <h2 className="text-lg font-bold text-slate-800">{currentDate.getFullYear()}å¹´ {currentDate.getMonth()+1}æœˆ</h2>
                                        <button onClick={nextMonth} className="p-2 hover:bg-white hover:shadow-sm rounded-full transition-all text-slate-500"><Icon name="chevron-right"/></button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-7 text-center py-3 text-xs font-bold text-slate-400 bg-white border-b border-slate-100">{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><div key={d}>{d}</div>)}</div>
                                <div className="grid grid-cols-7 auto-rows-[50px] bg-white">
                                    {calendarDays.map((day, i) => { 
                                        const dateStr = day ? `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}` : ''; 
                                        
                                        // [ä¿®æ”¹] æ”¹ç”¨ calendarOccupancy åˆ¤æ–·æ ¼å­å…§å®¹ï¼Œæ”¯æ´å‰ç½®èˆ‡è·¨æ—¥é¡¯ç¤º
                                        const dayItems = day ? (calendarOccupancy[dateStr] || []).filter(item => checkEventMatchesFilters(item.evt.key)) : [];
                                        const hasEvents = dayItems.length > 0;

                                        // [ä¿®æ”¹] æª¢æŸ¥ç•¶å¤©æ‰€æœ‰äº‹é …æ˜¯å¦éƒ½å·²æ»¿ (é‡å°ä¸»æ´»å‹•æˆ–è·¨æ—¥)
                                        const areAllFull = hasEvents && dayItems.every(item => {
                                            const cfg = eventConfigs[item.evt.key] || {};
                                            const cap = cfg.capacity || 12;
                                            // å‰ç½®æº–å‚™é€šå¸¸ä¸ç®—é¡æ»¿ï¼Œä½†ç‚ºäº†è¦–è¦ºçµ±ä¸€ï¼Œè‹¥ä¸»æ´»å‹•æ»¿äº†å‰ç½®ä¹Ÿé¡¯ç¤ºæ»¿
                                            return item.evt.count >= cap;
                                        });
                                        // åˆ¤æ–·æ˜¯å¦åŒ…å«å‰ç½®æº–å‚™ (ç”¨æ–¼é¡¯ç¤ºä¸åŒé¡è‰²çš„é»)
                                        const hasPrep = hasEvents && dayItems.some(item => item.type === 'prep');

                                        const isSelected = dateStr === selectedPublicDate;
                                        const isRestDay = companyRestDates.includes(dateStr);
                                        const isOutingDay = !!(outingDays[dateStr] && outingDays[dateStr].enabled);

                                        // [ä¿®æ”¹é‚è¼¯] åˆ¤æ–·æ˜¯å¦ç¬¦åˆç¯©é¸
                                        const isSearchMatch = publicSearchTerm && matchingDates.includes(dateStr);
                                        const isFilterMatch = hasActiveFilters && hasEvents;
                                        const shouldHighlight = isSearchMatch || isFilterMatch;

                                        // [ä¿®æ”¹] ç‚ºäº†è®“å…§éƒ¨çš„ã€Œé»ã€èƒ½é€£æˆç·šï¼Œç§»é™¤ mx-1 è®“æ ¼å­ç·Šè²¼
                                        let cellClass = "cursor-pointer flex flex-col items-center justify-center relative transition-all border-b border-r border-slate-50"; 
                                        let numClass = "text-sm font-medium text-slate-700 z-10 relative"; 

                                        if (isRestDay) { 
                                            cellClass += " bg-slate-50 cursor-not-allowed"; 
                                            numClass = "text-slate-300"; 
                                        } else if (isSelected) { 
                                            cellClass += " bg-slate-800 text-white hover:bg-slate-900 shadow-md z-20"; 
                                            numClass = "text-white font-bold"; 
                                        } else if (shouldHighlight) { 
                                            cellClass += " bg-yellow-100 text-yellow-800 z-10"; 
                                        } else {
                                            cellClass += " hover:bg-slate-50";
                                        }
                                        
                                        return ( 
                                            <div key={i} onClick={() => { if (day && !isRestDay) { setSelectedPublicDate(dateStr); setPublicDateEntryNonce(n => n + 1); } }} className={cellClass}> 
                                                {day && ( <> 
                                                    <div className={numClass}>{day}</div> 
                                                    {isRestDay ? ( 
                                                        <div className="text-slate-300 font-bold text-lg select-none">âœ•</div> 
                                                    ) : ( 
                                                        isOutingDay && !isSelected ? (
                                                            <div className="text-[9px] font-bold text-amber-500 mt-0.5 scale-90 relative z-10">å¤–å‡º</div>
                                                        ) : (
                                                        hasEvents && !isSelected && (
                                                            // [ä¿®æ”¹] é¡¯ç¤ºç´…å­—é¡æ»¿ æˆ– é€£çºŒç·šæ¢(Bar)
                                                            areAllFull ? (
                                                                <div className="text-[9px] font-bold text-red-500 mt-0.5 scale-90 relative z-10">é¡æ»¿</div>
                                                            ) : (
                                                                (() => {
                                                                    // --- è¨ˆç®—é€£çµé‚è¼¯ ---
                                                                    const dObj = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                                                                    dObj.setDate(dObj.getDate() + 1);
                                                                    const nextDateStr = `${dObj.getFullYear()}-${String(dObj.getMonth()+1).padStart(2,'0')}-${String(dObj.getDate()).padStart(2,'0')}`;
                                                                    const nextDayItems = calendarOccupancy[nextDateStr] || [];

                                                                    // åˆ¤æ–·è—è‰² (ä¸»æ´»å‹•)
                                                                    const isBlueCont = dayItems.some(i => i.type === 'cont'); // ä»Šå¤©æ˜¯çºŒ
                                                                    const willBlueCont = nextDayItems.some(i => i.type === 'cont'); // æ˜å¤©æ˜¯çºŒ
                                                                    // åˆ¤æ–·æ©˜è‰² (å‰ç½®) - ç°¡å–®åˆ¤æ–·ï¼šåªè¦ä»Šå¤©æ˜¯å‰ç½®ï¼Œä¸”æ˜å¤©æœ‰æ±è¥¿(å‰ç½®æˆ–ä¸»)ï¼Œå°±å¾€å³é€£
                                                                    const isPrep = dayItems.some(i => i.type === 'prep');
                                                                    const willPrepConnect = isPrep && nextDayItems.some(i => i.type === 'prep' || i.type === 'main');

                                                                    let dotClass = "h-1.5 mt-1 transition-all relative z-0 "; // åŸºç¤é«˜åº¦
                                                                    let colorClass = "bg-blue-500";

                                                                    if (isPrep) {
                                                                        colorClass = "bg-orange-400";
                                                                        // å‰ç½®çš„é€£çµé‚è¼¯
                                                                        if (willPrepConnect) {
                                                                            // é€™è£¡ç°¡åŒ–ï¼šå‰ç½®é€šå¸¸æ˜¯é€£çºŒçš„ï¼Œè‹¥é€™å¤©æ˜¯å‰ç½®ä¸”æ˜å¤©ä¹Ÿæœ‰æ´»å‹•ï¼Œè¦–ç‚ºã€Œé–‹å§‹ã€æˆ–ã€Œä¸­é–“ã€
                                                                            // ç‚ºäº†è¦–è¦ºç°¡å–®ï¼Œå‡è¨­å‰ç½®ä¸€å®šé€£å‘æ˜å¤©
                                                                            dotClass += "w-full mr-[-50%] rounded-l-full rounded-r-none ml-auto"; 
                                                                            // ä¿®æ­£ï¼šå¦‚æœæ˜¯ä¸­é–“å¤©æ•¸(æ˜¨å¤©ä¹Ÿæ˜¯å‰ç½®)ï¼Œæ‡‰è©²å…¨å¹³ï¼Œä½†é€™è£¡æ²’è®€æ˜¨å¤©è³‡æ–™
                                                                            // ç”¨ç°¡å–®ç­–ç•¥ï¼šé å³é€£
                                                                            dotClass = "h-1.5 mt-1 bg-orange-400 w-[60%] ml-[40%] rounded-l-full rounded-r-none"; 
                                                                            if (dayItems.length > 1 && dayItems[0].label?.includes('å‰ç½®')) {
                                                                                // å¦‚æœæœ‰å¤šå€‹æ¨™è¨˜æˆ–æ˜é¡¯æ˜¯ä¸­é–“æ…‹ï¼Œæ”¹å…¨å¯¬
                                                                                dotClass = "h-1.5 mt-1 bg-orange-400 w-full rounded-none";
                                                                            }
                                                                        } else {
                                                                            // å‰ç½®æœ€å¾Œä¸€å¤© (é€šå¸¸ä¸æœƒç™¼ç”Ÿï¼Œå› ç‚ºå‰ç½®æ¥ä¸»æ´»å‹•)
                                                                            dotClass += "w-1.5 rounded-full mx-auto";
                                                                        }
                                                                    } else {
                                                                        // ä¸»æ´»å‹•é€£çµé‚è¼¯
                                                                        if (isBlueCont && willBlueCont) {
                                                                            // ä¸­é–“ï¼šå…¨å¯¬ã€ç„¡åœ“è§’
                                                                            dotClass += "w-full rounded-none mx-0";
                                                                        } else if (willBlueCont) {
                                                                            // é–‹å§‹ï¼šé å³ã€å·¦åœ“å³å¹³
                                                                            dotClass += "w-[60%] ml-[40%] rounded-l-full rounded-r-none";
                                                                        } else if (isBlueCont) {
                                                                            // çµæŸï¼šé å·¦ã€å·¦å¹³å³åœ“
                                                                            dotClass += "w-[60%] mr-[40%] rounded-r-full rounded-l-none";
                                                                        } else {
                                                                            // å–®æ—¥ï¼šç½®ä¸­åœ“é»
                                                                            dotClass += "w-1.5 rounded-full mx-auto";
                                                                        }
                                                                    }
                                                                    
                                                                    // é«˜äº®æ™‚å¼·åˆ¶æ›è‰²
                                                                    if (shouldHighlight) colorClass = "bg-blue-600 ring-1 ring-white";

                                                                    return <div className={`${dotClass} ${colorClass}`}></div>;
                                                                })()
                                                            )
                                                        )
                                                        )
                                                    )} 
                                                </> )} 
                                            </div> 
                                        ); 
                                    })}
                                </div>
                            </div>
                            
                            {/* ...ä¸‹æ–¹æ´»å‹•åˆ—è¡¨ä¿æŒåŸæ¨£... */}
                            <div className="space-y-4 fade-in">
                                {/* ...æ´»å‹•åˆ—è¡¨å…§å®¹... */}
                                <h3 className="font-bold text-slate-800 text-lg flex items-center gap-2 border-l-4 border-blue-500 pl-3">{selectedPublicDate} æ´»å‹•åˆ—è¡¨</h3>{companyRestDates.includes(selectedPublicDate) ? (<div className="text-center py-12 bg-red-50 rounded-3xl border border-red-100"><div className="text-4xl mb-2">ğŸ˜´</div><div className="text-red-400 font-bold">æœ¬æ—¥å…¨å…¬å¸å…¬ä¼‘</div><div className="text-red-300 text-sm mt-1">æˆ‘å€‘ä¼‘æ¯å……é›»ä¸­ï¼Œè«‹æ”¹æœŸå†ä¾†å–”ï¼</div></div>) : isSelectedOutingDay ? (
<div className="bg-amber-50 border border-amber-200 rounded-3xl p-6 text-center">
    {selectedOutingPoster?.filename && <img src={selectedOutingPoster.filename} alt="outing-poster" className="max-h-56 mx-auto mb-4 rounded-2xl border border-amber-200 bg-transparent object-contain" />}
    <div className="text-2xl mb-2">ğŸ“·</div>
    <div className="text-amber-700 font-bold text-xl">å‡ºå¤–å–æä¸­</div>
    <div className="text-amber-500 text-sm mt-1">ä»Šæ—¥æš«åœå‰å°æ´»å‹•å±•ç¤ºï¼Œæ„Ÿè¬ç­‰å¾…ï¼</div>
</div>
) : (selectedDayItems.length > 0 ? (selectedDayItems.map((item) => {
    // [ä¿®æ”¹] è§£æ§‹ item å–å¾— evt (åŸå§‹æ´»å‹•) èˆ‡ type (é¡å‹: main/cont/prep)
    const e = item.evt;
    const itemType = item.type; // 'main', 'cont', 'prep'
    const itemLabel = item.label; // ä¾‹å¦‚ "âš ï¸ å‰ç½®: ..." æˆ– "â†³ D2: ..."
    
    const cfg = eventConfigs[e.key] || {};
    const status = getEventStatus(e.count, cfg.capacity, cfg, e.date, globalRules);
    const displayName = cfg.displayName || e.eventName;
    
    // --- [æ–°å¢ 1] è¨ˆç®—æ˜ŸæœŸå¹¾ ---
    const dayIndex = new Date(e.date).getDay();
    const weekDays = ['é€±æ—¥', 'é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”', 'é€±å…­'];
    const weekDayStr = weekDays[dayIndex] || '';
    
    // --- [æ–°å¢ 2] çµ„åˆè¦è¿½è¹¤çš„å­—ä¸² (ä¾‹å¦‚: 2023-10-10 (é€±äºŒ) ç™»å±±åœ˜) ---
    const analyticsLabel = `${e.date} (${weekDayStr}) ${displayName}`;

    // æ¨£å¼è¨­å®š
    let cardClass = 'bg-white border-slate-100 shadow-sm hover:shadow-md border-l-4';
    const borderColor = (status.colorObj && status.colorObj.border) ? status.colorObj.border.replace('border-', 'border-l-') : 'border-l-blue-500';
    
    if (status.isFull) cardClass = 'bg-slate-50 border-slate-200 border-l-slate-400';
    else cardClass = `bg-white border-slate-100 shadow-sm hover:shadow-md border-l-4 ${borderColor.replace('border-l-100', 'border-l-500')}`;
    
    const statusBadgeClass = status.isFull ? "bg-slate-600 text-white" : `${status.colorObj?.bg || 'bg-blue-50'} ${status.colorObj?.text || 'text-blue-600'}`;
    const tags = cfg.tags || {};

    return (
        // --- [æ–°å¢ 3] åŠ å…¥ data-analytics-event å±¬æ€§ ---
        <div 
            key={e.key} 
            data-analytics-event={analyticsLabel}
            className={`p-5 rounded-2xl border transition-all group relative ${cardClass}`}
        >
            
            {/* ä¸ŠåŠéƒ¨ï¼šæ¨™é¡Œèˆ‡ç‹€æ…‹ (ä¿æŒä¸è®Š) */}
          
           <div className="flex justify-between items-start mb-3">
    <div className="font-bold text-lg text-slate-800">
        {/* [æ–°å¢] é¡¯ç¤ºå‰ç½®æˆ–è·¨æ—¥æ¨™ç±¤ */}
        {itemType === 'prep' && <span className="inline-block bg-orange-100 text-orange-700 text-xs px-2 py-0.5 rounded mr-2 align-middle">âš ï¸ å‰ç½®æº–å‚™</span>}
        {itemType === 'cont' && <span className="inline-block bg-slate-100 text-slate-600 text-xs px-2 py-0.5 rounded mr-2 align-middle">{itemLabel?.split(':')[0]}</span>}
        <span className="align-middle">{displayName}</span>
    </div>
                <div className="flex flex-col items-end gap-1">
                    <span className={`text-xs px-2 py-1 rounded-lg font-bold ${statusBadgeClass}`}>{status.label}</span>
                    {!status.isEnded && (<span className="text-[10px] text-slate-500 font-bold bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100">ç›®å‰: <span className="text-blue-600">{e.count}</span> äºº</span>)}
                </div>
            </div>

            {/* ä¸­é–“ï¼šæ¨™ç±¤ (ä¿æŒä¸è®Š) */}
            {(tags.levels || tags.types || tags.locations) && (
                <div className="flex gap-2 mb-3">
                    {tags.levels && <span className="text-[10px] bg-blue-50 text-blue-700 px-2 py-0.5 rounded border border-blue-100">{tags.levels}</span>}
                    {tags.types && <span className="text-[10px] bg-emerald-50 text-emerald-700 px-2 py-0.5 rounded border border-emerald-100">{tags.types}</span>}
                    {tags.locations && <span className="text-[10px] bg-purple-50 text-purple-700 px-2 py-0.5 rounded border border-purple-100">{tags.locations}</span>}
                </div>
            )}

            {/* ä¸­é–“ï¼šè³‡è¨Š (ä¿æŒä¸è®Š) */}
            <div className="space-y-2 text-sm text-slate-600">
                <div className="flex items-center gap-2"><Icon name="user" size={16} className="text-slate-400"/> <span>è¬›å¸«ï¼š{e.instructor || 'æœªå®š'}</span></div>
                {cfg.time && (<div className="flex items-center gap-2"><Icon name="clock" size={16} className="text-slate-400"/> <span>æ™‚é–“ï¼š{cfg.time}</span></div>)}
            </div>

            {/* åº•éƒ¨å€åŸŸï¼šä¿®æ”¹æŒ‰éˆ•ä½ç½®èˆ‡è¡Œç‚º */}
            <div className="mt-4 pt-4 border-t border-slate-200/50 flex items-center min-h-[40px]">
                
                {/* [ä¿®æ”¹] æŒ‰éˆ•é‚è¼¯ï¼šå³ä½¿é¡æ»¿/çµæŸä¹Ÿé¡¯ç¤ºï¼Œæ”¹ç‚ºç°è‰²ä¸å¯é»æ“Š */}
                {cfg.link && (
                    <button
    /* å¦‚æœé¡æ»¿æˆ–çµæŸï¼Œè¨­ç‚º disabled */
    disabled={status.isFull}
                        onClick={(evt) => {
                            evt.stopPropagation();
                            // åªæœ‰æœªé¡æ»¿ä¸”æœªçµæŸæ™‚ï¼Œæ‰é–‹å•Ÿé€£çµ
                            if (!status.isFull) window.open(cfg.link, '_blank');
                        }}
                        className={`text-sm font-bold px-4 py-2 rounded-lg shadow-md flex items-center gap-2 z-20 relative transition-all ${
                            status.isFull 
                            ? 'bg-slate-100 text-slate-400 cursor-not-allowed border border-slate-200' // é¡æ»¿/çµæŸæ¨£å¼ (ç°)
                            : 'bg-blue-600 text-white hover:bg-blue-700 hover:shadow-lg hover:scale-105 cursor-pointer' // æ­£å¸¸æ¨£å¼ (è—)
                        }`}
                    >
                        {/* æ ¹æ“šç‹€æ…‹é¡¯ç¤ºä¸åŒæ–‡å­— */}
                        {status.isEnded ? 'æ´»å‹•å·²çµæŸ' : (status.isFull ? 'åé¡å·²æ»¿' : 'å‰å¾€å ±å')}
                        
                        {/* åªæœ‰å¯å ±åæ™‚æ‰é¡¯ç¤ºç®­é ­ */}
                        {!status.isFull && <Icon name="arrow-right" size={16}/>}
                    </button>
                )}

                {/* ğŸ¿ï¸ å‰ç¥¥ç‰©çµ„ä»¶ (å‚³å…¥è¨­å®šæª”) */}
                <EventMascot eventName={displayName} db={db} dbSource={dbSource} dailyStats={dailyStats} config={mascotConfig} />
            </div>
        </div>  
    );
})) : (<div className="text-center py-12 bg-slate-50 rounded-3xl border border-dashed border-slate-200"><div className="text-4xl mb-2">ğŸ“…</div><div className="text-slate-400 font-medium">{hasActiveFilters ? 'æ­¤ç¯©é¸æ¢ä»¶ä¸‹ç„¡æ´»å‹•' : 'æœ¬æ—¥ç„¡æ´»å‹•'}</div><div className="text-slate-300 text-sm mt-1">è«‹é»é¸å…¶ä»–æœ‰è—é»çš„æ—¥æœŸ</div></div>))}
                            </div>
                            </div>
                        </main>
                        {showLoginModal && <LoginModal onClose={() => setShowLoginModal(false)} onLogin={handleVerifyLogin} />}
                    </div>
                );
            }

            return (
                <div className="flex min-h-screen">
                    {mobileMenuOpen && ( <div className="fixed inset-0 z-50 bg-slate-800/50 backdrop-blur-sm md:hidden" onClick={() => setMobileMenuOpen(false)}> <div className="absolute top-0 left-0 w-64 h-full bg-white shadow-xl p-4" onClick={e => e.stopPropagation()}> <div className="flex justify-between items-center mb-6"><Logo className="h-6 w-auto" /><button onClick={() => setMobileMenuOpen(false)} className="p-2 text-slate-500"><Icon name="x" /></button></div> <nav className="space-y-1"> <NavItem id="tasks" icon="check-square" label="ä»»å‹™æŒ‡æ®ä¸­å¿ƒ" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} /> <NavItem id="promises" icon="message-square" label="æ‰¿è«¾ç‰†" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} /> <NavItem id="projects" icon="briefcase" label="å°ˆæ¡ˆé€²åº¦" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} /> <NavItem id="projectOwners" icon="users" label="Owneræ™‚ç¨‹" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} /> <NavItem id="dashboard" icon="trending-up" label="ç‡Ÿé‹å„€è¡¨æ¿" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} /> <NavItem id="stats" icon="bar-chart-2" label="æˆæ•ˆåˆ†æ" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} /> <NavItem id="enrollment" icon="pie-chart" label="å ±åç›£æ§" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} /> <NavItem id="crm" icon="users" label="å®¢æˆ¶ CRM" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} /> <NavItem id="analytics" icon="activity" label="æµé‡åˆ†æ" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} /> <div className="border-t border-slate-100 my-2 pt-2"> <NavItem id="events" icon="calendar" label="æ´»å‹•å ´æ¬¡è¡¨" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} /> <NavItem id="import" icon="database" label="è³‡æ–™åº«ç®¡ç†" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} /> <button onClick={() => { setViewMode('public'); setMobileMenuOpen(false); }} className="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-all text-left"><Icon name="eye" size={20} /><span className="font-medium tracking-wide">é è¦½å‰å°</span></button> </div> </nav> </div> </div> )}
                    <aside className="w-64 bg-white border-r border-slate-200 flex flex-col p-4 hidden md:flex sticky top-0 h-screen"> <div className="flex items-center space-x-2 px-4 mb-8 mt-2"><Logo className="h-8 w-auto" /></div> <nav className="space-y-1 flex-1"> <NavItem id="tasks" icon="check-square" label="ä»»å‹™æŒ‡æ®ä¸­å¿ƒ" activeTab={activeTab} setActiveTab={setActiveTab} /> <NavItem id="promises" icon="message-square" label="æ‰¿è«¾ç‰†" activeTab={activeTab} setActiveTab={setActiveTab} /> <NavItem id="projects" icon="briefcase" label="å°ˆæ¡ˆé€²åº¦" activeTab={activeTab} setActiveTab={setActiveTab} /> <NavItem id="projectOwners" icon="users" label="Owneræ™‚ç¨‹" activeTab={activeTab} setActiveTab={setActiveTab} /> <NavItem id="dashboard" icon="trending-up" label="ç‡Ÿé‹å„€è¡¨æ¿" activeTab={activeTab} setActiveTab={setActiveTab} /> <NavItem id="stats" icon="bar-chart-2" label="æˆæ•ˆåˆ†æ" activeTab={activeTab} setActiveTab={setActiveTab} /> <NavItem id="enrollment" icon="pie-chart" label="å ±åç›£æ§" activeTab={activeTab} setActiveTab={setActiveTab} /> <NavItem id="crm" icon="users" label="å®¢æˆ¶ CRM" activeTab={activeTab} setActiveTab={setActiveTab} /> <NavItem id="analytics" icon="activity" label="æµé‡åˆ†æ" activeTab={activeTab} setActiveTab={setActiveTab} /> </nav> <div className="pt-4 border-t border-slate-100 space-y-2"> <NavItem id="events" icon="calendar" label="æ´»å‹•å ´æ¬¡è¡¨" activeTab={activeTab} setActiveTab={setActiveTab} /> <NavItem id="import" icon="database" label="è³‡æ–™åº«ç®¡ç†" activeTab={activeTab} setActiveTab={setActiveTab} /> <button onClick={() => setViewMode('public')} className="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-all"><Icon name="eye" size={20} /><span className="font-medium tracking-wide">é è¦½å‰å°</span></button> </div> </aside>
                    <main className="flex-1 p-4 md:p-10 overflow-y-auto bg-slate-50/50 relative h-screen">
                        <div className="md:hidden mb-6 flex justify-between items-center sticky top-0 z-30 bg-slate-50/90 backdrop-blur-sm py-2"><Logo className="h-6 w-auto" /><button onClick={() => setMobileMenuOpen(true)} className="p-2 bg-white rounded-lg shadow-sm text-slate-600 border border-slate-200"><Icon name="menu" /></button></div>
                        {activeTab === 'tasks' && <div className="max-w-6xl mx-auto fade-in pb-20"><header className="mb-8 flex justify-between items-end"><div><h2 className="text-2xl font-bold text-slate-800 mb-1">ä»»å‹™æŒ‡æ®ä¸­å¿ƒ</h2><p className="text-slate-500 text-sm">æ™ºæ…§è¿½è¹¤ç³»çµ±ï¼Œæ ¹æ“šæ´»å‹•æ—¥æœŸè‡ªå‹•æ’åº</p></div><div className="bg-white px-4 py-2 rounded-full border text-sm font-medium whitespace-nowrap">å¾…è™•ç†: <span className="text-blue-600 font-bold ml-1">{tasks.length}</span></div></header>{Object.keys(groupedTasks).length === 0 ? (<div className="text-center py-20"><div className="text-6xl mb-4">ğŸ‰</div><h3 className="text-xl font-bold text-slate-700">å¤ªæ£’äº†ï¼ä»»å‹™å·²æ¸…ç©º</h3></div>) : (<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{(() => { const fixedOrder = ['è¾¦ç†ä¿éšª', 'å¯„é€è¡Œå‰ä¿¡', 'å¯„é€èŠ±çµ®ä¿¡']; const allTaskNames = [...new Set([...fixedOrder, ...Object.keys(groupedTasks)])]; allTaskNames.sort((a, b) => { const idxA = fixedOrder.indexOf(a); const idxB = fixedOrder.indexOf(b); if (idxA !== -1 && idxB !== -1) return idxA - idxB; if (idxA !== -1) return -1; if (idxB !== -1) return 1; return a.localeCompare(b); }); return allTaskNames.map((taskName, index) => { const taskList = groupedTasks[taskName] || []; if (taskList.length === 0 && !fixedOrder.includes(taskName)) return null; const color = TASK_GROUP_COLORS[index % TASK_GROUP_COLORS.length]; return (<div key={taskName} className={`rounded-2xl border ${color.border} ${color.bg} p-4 h-fit`}><h3 className={`font-bold text-lg mb-4 ${color.text} flex items-center gap-2`}><Icon name="layers" className={color.icon} size={20}/>{taskName}<span className="text-sm opacity-75 font-normal ml-auto bg-white/50 px-2 py-0.5 rounded-full">{taskList.length}</span></h3><div className="space-y-3 min-h-[50px]">{taskList.length > 0 ? taskList.map((t, i) => (<div key={`${t.cfgKey}-${t.taskIdx}`} onClick={() => setActiveTaskDetail(t)} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer group relative overflow-hidden"><div className={`absolute top-0 left-0 w-1 h-full ${t.style.bg.replace('bg-', 'bg-') === 'bg-white' ? 'bg-slate-200' : t.style.bg.replace('bg', 'bg').replace('50', '400')}`}></div><div className="flex justify-between mb-2 pl-2"><span className="bg-slate-100 text-slate-600 text-xs font-mono px-2 py-0.5 rounded">{t.evtDate}</span>{t.style.label && <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full border ${t.style.color} ${t.style.border} ${t.style.bg}`}>{t.style.label}</span>}</div><div className="pl-2"><div className="text-sm font-bold text-slate-800 mb-1 truncate">{t.evtName}</div><button onClick={(e) => { e.stopPropagation(); toggleTask(t.cfgKey, t.taskIdx) }} className="w-full mt-3 py-2 rounded-lg bg-slate-50 text-slate-400 hover:bg-green-500 hover:text-white transition-all flex justify-center gap-2 text-xs font-bold"><Icon name="check-circle-2" size={14} /> æ¨™ç¤ºå®Œæˆ</button></div></div>)) : <div className="text-center text-xs text-slate-400 py-8 border-2 border-dashed border-slate-200 rounded-xl">ç›®å‰ç„¡å¾…è¾¦äº‹é …</div>}</div></div>); }); })()}</div>)}</div>}
                        {activeTab === 'promises' && <div className="max-w-6xl mx-auto fade-in pb-20"><header className="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4"><div><h2 className="text-2xl font-bold text-slate-800 mb-1">åœ˜éšŠæ‰¿è«¾ç‰†</h2><p className="text-slate-500 text-sm">ç´€éŒ„é‚£äº›éæ­£å¼ä½†é‡è¦çš„ç´„å®š</p></div><div className="flex gap-3 w-full md:w-auto"><div className="relative flex-1 md:w-64"><Icon name="search" className="absolute left-3 top-2.5 text-slate-400" size={18}/><input type="text" placeholder="æœå°‹æ‰¿è«¾..." className="w-full pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-purple-500 transition-all" value={promiseSearch} onChange={e => setPromiseSearch(e.target.value)} /></div><button onClick={()=>setShowAddPromise(true)} className="bg-purple-600 text-white px-4 py-2 rounded-xl flex items-center gap-2 shadow-md hover:bg-purple-700 whitespace-nowrap"><Icon name="plus" size={18}/> <span className="hidden md:inline">æ–°å¢</span></button></div></header><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{promises.filter(p => !promiseSearch || (p.content && p.content.toLowerCase().includes(promiseSearch.toLowerCase())) || (p.who && p.who.toLowerCase().includes(promiseSearch.toLowerCase()))).map(p => { const st = getPromiseStatus(p.date, p.time); const isDone = p.status === 'done'; return (<div key={p.id} className={`bg-white p-5 rounded-2xl border shadow-sm relative transition-all ${isDone ? 'opacity-50 border-slate-100' : 'border-slate-200 hover:shadow-md'}`}><button onClick={()=>handleDeletePromise(p.id)} className="absolute top-3 right-3 text-slate-300 hover:text-red-400 opacity-0 hover:opacity-100 transition"><Icon name="trash-2" size={16}/></button><div className="flex items-center gap-2 mb-3"><span className={`text-[10px] font-bold px-2 py-0.5 rounded-full border ${isDone ? 'text-slate-400 border-slate-200 bg-slate-50' : `${st.color} ${st.border} ${st.bg}`}`}>{isDone ? 'å·²å®Œæˆ' : st.label}</span><span className="text-xs text-slate-400 flex items-center gap-1"><Icon name="clock" size={12}/> {p.date} {p.time}</span></div><h4 className={`font-bold text-lg mb-2 ${isDone ? 'text-slate-400 line-through' : 'text-slate-800'}`}>{p.content}</h4>{p.who && <div className="text-sm text-slate-500 mb-4 flex items-center gap-1"><Icon name="user" size={14}/> {p.who}</div>}<button onClick={()=>handleTogglePromise(p.id, p.status)} className={`w-full py-2 rounded-xl border font-bold text-sm flex items-center justify-center gap-2 transition-all ${isDone ? 'bg-slate-50 text-slate-400 border-slate-200' : 'bg-white text-purple-600 border-purple-200 hover:bg-purple-50'}`}>{isDone ? 'é‡å•Ÿä»»å‹™' : 'æ¨™ç¤ºå®Œæˆ'}</button></div>);})}</div></div>}
                        {activeTab === 'events' && <div className="fade-in max-w-6xl mx-auto pb-20">
                            <header className="flex justify-between items-center mb-6">
                                <h2 className="text-2xl font-bold">æ´»å‹•å ´æ¬¡</h2>
                                <div className="flex gap-3">
                                    {/* ä¿®æ”¹å¾Œçš„æŒ‰éˆ•ï¼šå­—é«”è®Šå° (text-xs)ï¼Œpadding è®Šå° (px-3 py-1.5) */}
                                    <button onClick={()=>setShowExportModal(true)} className="bg-slate-800 hover:bg-slate-900 text-white px-3 py-1.5 text-xs font-bold rounded-lg flex items-center gap-2 shadow-md">
                                        <Icon name="download" size={14}/> åŒ¯å‡ºæœˆæ›†è³‡æ–™
                                    </button>
                                    
                                    <button onClick={()=>setShowCreateEvent(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 text-xs font-bold rounded-lg flex items-center gap-2 shadow-md">
                                        <Icon name="plus" size={14}/> å¿«é€Ÿé–‹åœ˜
                                    </button>
                                    
                                    <div className="bg-white p-1 rounded-lg border flex">
                                        <button onClick={()=>setEventsViewMode('list')} className={`p-2 rounded-md ${eventsViewMode==='list'?'bg-slate-100':''}`}><Icon name="list" size={18}/></button>
                                        <button onClick={()=>setEventsViewMode('calendar')} className={`p-2 rounded-md ${eventsViewMode==='calendar'?'bg-slate-100':''}`}><Icon name="calendar" size={18}/></button>
                                    </div>
                                </div>
                            </header>
                            
                            {/* ... ä¸‹æ¥ eventsViewMode === 'list' çš„å…§å®¹ ... */}{eventsViewMode === 'list' && (<div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden table-container"><table className="w-full text-left min-w-[600px]"><thead className="bg-slate-50 border-b border-slate-100 text-slate-500 text-sm"><tr><th className="px-6 py-4 whitespace-nowrap">æ—¥æœŸ</th><th className="px-6 py-4 whitespace-nowrap">æ´»å‹•</th><th className="px-6 py-4 whitespace-nowrap">å ±å</th><th className="px-6 py-4 whitespace-nowrap">æ“ä½œ</th></tr></thead><tbody className="divide-y divide-slate-100">{Object.values(stats.events).map((e, i) => { const cfg = eventConfigs[e.key] || {}; const cap = cfg.capacity || 12; const isFull = e.count >= cap; const carpool = e.customers ? e.customers.filter(c=>c.transport==='å…±ä¹˜').length : 0; const isCancelled = !!cfg.isCancelled; return (<tr key={i} className="hover:bg-slate-50/80"><td className="px-6 py-4 text-slate-600 whitespace-nowrap">{e.date}</td><td className="px-6 py-4"><div className="font-bold text-slate-800 flex items-center gap-2">{e.eventName}{isCancelled && <span className="text-[10px] px-1.5 py-0.5 rounded bg-rose-100 text-rose-700 border border-rose-200">æµåœ˜</span>}</div><div className="text-xs text-slate-400 mt-0.5">{e.instructor}</div></td><td className="px-6 py-4"><div className="flex items-center gap-2"><span className={`font-bold ${isFull?'text-red-500':'text-slate-700'}`}>{e.count}</span><span className="text-xs text-slate-400">/ {cap}</span><div className="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden"><div className={`h-full ${isFull?'bg-red-500':'bg-green-500'}`} style={{width:`${Math.min((e.count/cap)*100,100)}%`}}></div></div></div>{carpool > 0 && <div className="text-[10px] text-orange-500 mt-1 flex items-center"><Icon name="car" size={10} className="mr-1"/> å…±ä¹˜ {carpool} äºº</div>}</td><td className="px-6 py-4"><button onClick={()=>setEditingEvent(e)} className="text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded flex items-center gap-1 text-sm whitespace-nowrap"><Icon name="settings" size={14}/> ç®¡ç†</button></td></tr>);})}</tbody></table></div>)}{eventsViewMode === 'calendar' && (<div className="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-slate-200 table-container"><div className="flex justify-between items-center mb-6 sticky left-0"><div className="flex items-center gap-2"><button onClick={prevMonth} className="p-2 hover:bg-slate-100 rounded-full"><Icon name="chevron-left"/></button><h3 className="text-xl font-bold text-slate-800 whitespace-nowrap">{currentDate.getFullYear()}å¹´ {currentDate.getMonth()+1}æœˆ</h3><button onClick={nextMonth} className="p-2 hover:bg-slate-100 rounded-full"><Icon name="chevron-right"/></button></div></div><div className="min-w-[600px]"><div className="grid grid-cols-7 mb-2 text-center text-sm font-bold text-slate-400">{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><div key={d}>{d}</div>)}</div><div className="grid grid-cols-7 auto-rows-[160px] border-t border-l border-slate-200">{calendarDays.map((day, i) => { const dateStr = day ? `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}` : ''; const dayItems = day ? (calendarOccupancy[dateStr] || []) : []; return (<div key={i} 
    onClick={() => { if(day) { setScheduleDate(dateStr); setShowCreateEvent(true); } }} 
    className={`border-b border-r border-slate-200 p-1 md:p-2 relative group ${day ? 'hover:bg-blue-50 cursor-pointer' : 'bg-slate-50/50'}`}
>
    {day && (
        <>
            <div className="flex justify-between items-start">
                <div className="text-sm font-medium mb-1 group-hover:text-blue-600 transition-colors">{day}</div>
                <button onClick={(e)=>{e.stopPropagation(); setShowScheduleModal(true); setScheduleDate(dateStr)}} className="text-slate-300 hover:text-blue-600 p-1 rounded-full hover:bg-white shadow-sm transition-all"><Icon name="calendar-days" size={14}/></button>
            </div>
            
            {companyRestDates.includes(dateStr) ? (
                <div className="flex items-center justify-center h-[100px] text-slate-300 font-bold text-2xl select-none bg-slate-50/50 rounded-lg">âœ•</div>
            ) : (
                <div className="space-y-1 overflow-y-auto max-h-[120px] no-scrollbar">
                    {/* [ä¿®æ”¹] æ”¹ç”¨ dayItems æ¸²æŸ“ï¼ŒåŒ…å«å‰ç½®èˆ‡è·¨æ—¥ï¼Œä¸¦é¡¯ç¤ºè¬›å¸« */ }
                    {dayItems.map((item, idx) => {
                        const { type, evt, cfg, label, displayTime } = item;
                        const isMain = type === 'main';
                        const isPrep = type === 'prep';
                        const isCancelled = !!cfg.isCancelled;
                        
                        // æ¨£å¼è¨­å®š
                        let cardClass = 'mb-1 p-1 px-1.5 rounded-md border cursor-pointer transition-all group hover:shadow-md text-[10px] relative overflow-hidden ';
                        let cardStyle = {};
                        
                        const baseColor = cfg.backendColor || '#3b82f6';
                        
                        if (isPrep) {
                            cardClass += 'bg-amber-50 text-amber-700 border-amber-200 opacity-90';
                            cardStyle = { backgroundImage: 'repeating-linear-gradient(45deg, transparent, transparent 5px, rgba(251, 191, 36, 0.1) 5px, rgba(251, 191, 36, 0.1) 10px)' };
                        } else if (type === 'cont') {
                            cardClass += 'text-slate-600 border-slate-200';
                            cardStyle = { backgroundColor: baseColor + '22', borderLeft: `3px solid ${baseColor}` };
                        } else {
                            const isFull = (cfg.capacity > 0 && evt.count >= cfg.capacity);
                            if (cfg.backendColor) {
                                const bgColor = cfg.backendColor.startsWith('#') ? cfg.backendColor + '33' : cfg.backendColor;
                                cardStyle = { backgroundColor: bgColor, borderColor: cfg.backendColor, borderWidth: '1.5px' };
                                cardClass += 'border font-bold text-slate-800';
                            } else {
                                cardClass += 'bg-blue-50 border-blue-100 font-bold text-blue-800';
                            }
                            if (isFull) cardClass += ' contrast-95';
                        }
                        if (isMain && isCancelled) cardClass += ' ring-1 ring-rose-300';

                        return (
                            <div key={`${evt.key}_${type}_${idx}`} onClick={(e)=>{ e.stopPropagation(); setEditingEvent(evt); }} className={cardClass} style={cardStyle} title={`${evt.eventName} @${evt.instructor || 'æœªå®š'}`}>
                                {isMain && isCancelled && (
                                    <div className="absolute bottom-0 right-0 bg-rose-600 text-white text-[8px] leading-none px-1 py-0.5 rounded-tl-md font-bold tracking-wide">
                                        æµåœ˜
                                    </div>
                                )}
                                {isMain ? (
                                    // [ä¿®æ”¹] ä¸»æ´»å‹•ï¼šå…©è¡Œå¼ä½ˆå±€
                                    // ç¬¬ä¸€è¡Œï¼šæ™‚é–“ + äººæ•¸
                                    // ç¬¬äºŒè¡Œï¼šæ´»å‹•åç¨±
                                    // ç¬¬ä¸‰è¡Œï¼š@è¬›å¸« (æ›è¡Œé¡¯ç¤º)
                                    <div className="flex flex-col leading-none py-0.5">
                                        <div className="flex justify-between items-center opacity-70 text-[8px] mb-0.5 font-mono">
                                            <span>{displayTime}</span>
                                            <span className="font-bold">{evt.count}äºº</span>
                                        </div>
                                        <div className="truncate font-bold text-[10px] mb-0.5">
                                            {evt.eventName}
                                        </div>
                                        <div className="truncate opacity-60 font-normal text-[9px]">
                                            @{evt.instructor || '?'}
                                        </div>
                                    </div>
                                ) : isPrep ? (
                                    // [ä¿®æ”¹] å‰ç½®ï¼šåŒæ¨£ä½µç‚ºå–®è¡Œ
                                    <div className="flex flex-col leading-none py-0.5">
                                        <div className="flex items-center gap-1 opacity-70 text-[8px] mb-0.5 font-mono">
                                            <span>{displayTime}</span>
                                            <Icon name="alert-circle" size={8}/> 
                                            <span>å‰ç½®</span>
                                        </div>
                                        <div className="truncate text-[10px]">
                                            {evt.eventName} <span className="opacity-60 text-[9px]">@{evt.instructor}</span>
                                        </div>
                                    </div>
                                ) : (
                                    // è·¨æ—¥ (ä¿æŒåŸæ¨£)
                                    <div className="flex items-center gap-1">
                                        {label}
                                    </div>
                                )}
                            </div>
                        );
                    })}
                </div>
            )}
            {instructorSchedule[dateStr] && instructorSchedule[dateStr].length > 0 && !companyRestDates.includes(dateStr) && (
                <div className="text-[10px] text-red-400 flex flex-wrap gap-1 mt-1">
                    {instructorSchedule[dateStr].map(name => <span key={name} className="bg-red-50 px-1 rounded">{name}ä¼‘</span>)}
                </div>
            )}
            {outingDays[dateStr]?.enabled && !companyRestDates.includes(dateStr) && (
                <div className="absolute bottom-1 right-1 max-w-[90%] text-[10px] text-amber-700 bg-amber-50 border border-amber-200 rounded px-1.5 py-0.5 leading-tight shadow-sm pointer-events-none">
                    <span className="font-bold">å ´å‹˜</span>
                    {Array.isArray(outingDays[dateStr]?.people) && outingDays[dateStr].people.length > 0 && (
                        <span className="ml-1">: {outingDays[dateStr].people.join('ã€')}</span>
                    )}
                </div>
            )}
        </>
    )}
</div>);})}</div></div></div>)}</div>}
                        
                        {activeTab === 'projects' && <ProjectConsoleTab user={user} db={db} dbSource={dbSource} sourceProjects={projects} />}
                        {activeTab === 'projectOwners' && <ProjectOwnerTimelineTab sourceProjects={projects} />}

                        {activeTab === 'dashboard' && <div className="fade-in max-w-6xl mx-auto space-y-8 pb-20"><header className="flex justify-between items-center"><h2 className="text-2xl font-bold">ç‡Ÿé‹å„€è¡¨æ¿</h2><button onClick={()=>downloadCSV(csvInput, 'full_export.csv')} className="text-sm bg-slate-800 text-white px-4 py-2 rounded-lg flex items-center gap-2"><Icon name="download" size={16}/> åŒ¯å‡ºç¸½è¡¨ (Excel)</button></header><div className="grid grid-cols-1 md:grid-cols-3 gap-6"><div className="bg-white p-6 rounded-2xl shadow-sm border border-blue-100 relative overflow-hidden"><div className="absolute -right-4 -top-4 text-blue-50 opacity-50"><Icon name="trending-up" size={100}/></div><div className="relative"><div className="text-sm font-bold text-blue-600 mb-1 uppercase tracking-wider">æœ¬æœˆç‡Ÿæ”¶</div><div className="text-4xl font-bold text-slate-800">${dashboardData.currentMonthRev.toLocaleString()}</div></div></div><div className="bg-white p-6 rounded-2xl shadow-sm border border-indigo-100 relative overflow-hidden"><div className="absolute -right-4 -top-4 text-indigo-50 opacity-50"><Icon name="users" size={100}/></div><div className="relative"><div className="text-sm font-bold text-indigo-600 mb-1 uppercase tracking-wider">æœ¬æœˆäººæ¬¡</div><div className="text-4xl font-bold text-slate-800">{dashboardData.currentMonthPax} <span className="text-lg font-normal text-slate-400">äºº</span></div></div></div><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><div className="text-sm font-medium text-slate-500 mb-4">æ­·å²ç¸½ç‡Ÿæ”¶</div><div className="text-2xl font-bold text-slate-700">${stats.totalRev.toLocaleString()}</div></div></div><div><h3 className="text-lg font-bold text-slate-700 mb-4">æœˆåº¦ç‡Ÿé‹å ±è¡¨</h3>{Object.entries(dashboardData.monthlyGroups).sort((a,b)=>b[0].localeCompare(a[0])).map(([month, data]) => (<MonthlyReport key={month} month={month} data={data} />))}</div></div>}
                       
                        {activeTab === 'stats' && <ActivityPerformance parsedData={parsedData} eventConfigs={eventConfigs} />}
{activeTab === 'enrollment' && (
    <EnrollmentMonitor 
        stats={stats} 
        eventConfigs={eventConfigs} 
        tagDefinitions={tagDefinitions} 
    />
)}

                        {activeTab === 'crm' && (
                            <div className="fade-in max-w-6xl mx-auto pb-20">
                                <header className="mb-6 flex flex-col md:flex-row justify-between items-center gap-4"><div><h2 className="text-2xl font-bold text-slate-800">å®¢æˆ¶åƒ¹å€¼åˆ†æ (CRM)</h2><p className="text-sm text-slate-500">æŒæ¡é«˜åƒ¹å€¼å®¢æˆ¶èˆ‡å¹³å‡å®¢å–®è¡¨ç¾</p></div><div className="flex bg-slate-100 p-1 rounded-xl">{[{id:'all', label:'å…¨æ™‚æ®µ'}, {id:'year', label:'è¿‘ä¸€å¹´'}, {id:'quarter', label:'è¿‘ä¸€å­£'}, {id:'month', label:'è¿‘ä¸€æœˆ'}].map(t => (<button key={t.id} onClick={() => setLtvTimeframe(t.id)} className={`px-4 py-1.5 rounded-lg text-sm font-bold transition-all ${ltvTimeframe === t.id ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>{t.label}</button>))}</div></header>
                                <div className="grid grid-cols-3 gap-4 mb-6">
                                    <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-4 text-white shadow-lg shadow-blue-200"><div className="text-blue-100 text-xs font-bold mb-1">å€é–“å¹³å‡ LTV (äººå‡è²¢ç»)</div><div className="text-2xl font-bold">${ltvStats.avgLtv.toLocaleString()}</div></div>
                                    <div className="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm"><div className="text-slate-400 text-xs font-bold mb-1">å€é–“ç¸½ç‡Ÿæ”¶</div><div className="text-2xl font-bold text-slate-700">${ltvStats.periodRevenue.toLocaleString()}</div></div>
                                    <div className="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm"><div className="text-slate-400 text-xs font-bold mb-1">æ´»èºå®¢æˆ¶æ•¸</div><div className="text-2xl font-bold text-slate-700">{ltvStats.activeCustomerCount} <span className="text-sm font-normal text-slate-400">äºº</span></div></div>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                    <div className="lg:col-span-1 space-y-4">
                                        <div className="relative">
                                            <Icon name="search" className="absolute left-3 top-3 text-slate-400" size={20}/>
                                            <input type="text" className="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 shadow-sm" placeholder="æœå°‹å®¢æˆ¶å§“å..." value={crmSearchTerm} onChange={(e) => { setCrmSearchTerm(e.target.value); setShowCrmDropdown(true); setSelectedCustomer(''); }} onFocus={() => setShowCrmDropdown(true)} onBlur={() => setTimeout(() => setShowCrmDropdown(false), 200)} />
                                            {showCrmDropdown && crmSearchTerm && (<div className="absolute z-10 w-full bg-white border border-slate-200 rounded-xl shadow-lg mt-1 max-h-60 overflow-y-auto">{filteredCrmCustomers.length > 0 ? (filteredCrmCustomers.map(c => (<div key={c} className="p-3 hover:bg-blue-50 cursor-pointer text-slate-700 flex justify-between items-center" onClick={() => { setSelectedCustomer(c); setCrmSearchTerm(c); setShowCrmDropdown(false); }}><span>{c}</span><span className="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded font-mono">${ltvStats.map[c]?.toLocaleString()}</span></div>))) : (<div className="p-3 text-slate-400 text-sm">ç„¡ç›¸ç¬¦å®¢æˆ¶</div>)}</div>)}
                                        </div>
                                        <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden"><div className="p-4 border-b border-slate-100 bg-slate-50/50 font-bold text-slate-700 flex justify-between items-center"><span>ğŸ† LTV æ’è¡Œæ¦œ ({ltvTimeframe === 'all' ? 'å…¨æ™‚æ®µ' : 'å€é–“'})</span></div><div className="max-h-[500px] overflow-y-auto">{ltvStats.sortedCustomers.slice(0, 50).map((name, idx) => (<div key={name} onClick={() => { setSelectedCustomer(name); setCrmSearchTerm(name); }} className={`p-3 flex items-center justify-between border-b border-slate-50 cursor-pointer hover:bg-blue-50 transition-colors ${selectedCustomer === name ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''}`}><div className="flex items-center gap-3"><div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${idx < 3 ? 'bg-yellow-100 text-yellow-700' : 'bg-slate-100 text-slate-500'}`}>{idx + 1}</div><span className="text-sm font-medium text-slate-700 truncate max-w-[100px]">{name}</span></div><div className="text-right"><div className="text-sm font-bold text-blue-600">${ltvStats.map[name].toLocaleString()}</div><div className="text-[10px] text-slate-400">{ltvStats.countMap[name]} æ¬¡æ¶ˆè²»</div></div></div>))}</div></div>
                                    </div>
                                    <div className="lg:col-span-2">
                                        {customerProfile ? (
                                            <div className="animate-in fade-in slide-in-from-top-4">
                                                <div className="flex flex-col md:flex-row justify-between items-start gap-6 mb-8 pb-8 border-b border-slate-100">
                                                    <div className="flex items-center gap-6">
                                                        <div className="w-24 h-24 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-4xl font-bold text-white shadow-lg shrink-0">{selectedCustomer[0]}</div>
                                                        <div>
                                                            <div className="text-3xl font-bold text-slate-800 mb-1">{selectedCustomer}</div>
                                                            <div className="text-sm text-slate-500 flex items-center gap-2"><Icon name="credit-card" size={14}/> LTV (çµ‚èº«åƒ¹å€¼): <span className="text-blue-600 font-bold">${customerProfile.totalSpend.toLocaleString()}</span></div>
                                                        </div>
                                                    </div>
                                                    <button onClick={() => setEditingRow(customerProfile.latestRecord)} className="text-slate-400 hover:text-blue-600 flex items-center gap-1 text-sm border border-slate-200 px-3 py-1.5 rounded-lg hover:bg-blue-50 transition whitespace-nowrap"><Icon name="edit-2" size={14}/> ç·¨è¼¯è³‡æ–™/å‚™è¨»</button>
                                                </div>
                                                <div className="flex-1 bg-slate-50 p-4 rounded-xl border border-slate-100 grid grid-cols-2 gap-y-3 gap-x-6 text-sm mb-8">
                                                    <div><span className="block text-xs text-slate-400 font-bold uppercase">Email</span>{customerProfile.email || '-'}</div>
                                                    <div><span className="block text-xs text-slate-400 font-bold uppercase">æ‰‹æ©Ÿ</span>{customerProfile.phone || '-'}</div>
                                                    <div><span className="block text-xs text-slate-400 font-bold uppercase">èº«åˆ†è­‰</span>{customerProfile.idNo || '-'}</div>
                                                    <div><span className="block text-xs text-slate-400 font-bold uppercase">ç”Ÿæ—¥</span>{customerProfile.birthday || '-'}</div>
                                                    <div><span className="block text-xs text-slate-400 font-bold uppercase">å¸¸ç”¨äº¤é€š</span>{customerProfile.transport || '-'}</div>
                                                    <div><span className="block text-xs text-slate-400 font-bold uppercase">ä¾†æºç®¡é“</span>{customerProfile.source || '-'}</div>
                                                    <div><span className="block text-xs text-slate-400 font-bold uppercase">ç¤¾ç¾¤æš±ç¨±</span>{customerProfile.socialName || '-'}</div>
                                                    <div className="col-span-2"><span className="block text-xs text-slate-400 font-bold uppercase">å‚™è¨»</span>{customerProfile.notes || '-'}</div>
                                                </div>
                                                <h4 className="font-bold text-slate-700 mb-4">æ¶ˆè²»æ­·å² ({customerProfile.history.length})</h4>
                                                <div className="space-y-2 table-container max-h-[400px] overflow-y-auto">
                                                    {customerProfile.history.map((h,i) => (
                                                        <div key={i} className="flex justify-between items-center p-4 border border-slate-100 rounded-xl hover:bg-slate-50 transition">
                                                            <div>
                                                                <div className="font-bold text-slate-700">{h.eventName}</div>
                                                                <div className="text-xs text-slate-400 mt-1">{h.date} â€¢ {h.instructor}</div>
                                                                {h.orderDate && <div className="text-xs text-blue-500 mt-0.5">ğŸ“… ä¸‹å®šæ–¼: {h.orderDate}</div>}
                                                            </div>
                                                            <div className="font-mono font-bold text-slate-600">${h.price}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="h-full flex flex-col items-center justify-center text-slate-400 bg-white rounded-2xl border border-dashed border-slate-200 min-h-[400px]">
                                                <div className="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4"><Icon name="user-check" size={32} className="text-slate-300"/></div>
                                                <p className="font-bold">è«‹å¾å·¦å´æ’è¡Œæ¦œé¸æ“‡ä¸€ä½å®¢æˆ¶</p>
                                                <p className="text-sm mt-1">æˆ–ä½¿ç”¨ä¸Šæ–¹æœå°‹æ¬„æŸ¥æ‰¾</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        )}
{activeTab === 'analytics' && <AnalyticsDashboard db={db} dbSource={dbSource} />}
                        {activeTab === 'import' && <div className="fade-in max-w-6xl mx-auto space-y-8 pb-20">
                            <header className="flex flex-col md:flex-row justify-between items-center gap-4">
                                <h2 className="text-2xl font-bold">è³‡æ–™åº«èˆ‡å ±åç®¡ç†</h2>
                                <div className="flex gap-2 items-center w-full md:w-auto justify-end">
                                    <div className="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">ä¾†æº: {dbSource}</div>
                                    <select className="text-xs p-1 border rounded" onChange={e=>handleDbSourceChange(e.target.value)} value={dbSource}><option value="crm-system-v1">v1 (æ‚¨çš„çœŸå¯¦è³‡æ–™)</option><option value="default-app-id">Default (èˆŠç‰ˆæ¸¬è©¦)</option></select>
                                    <button onClick={()=>setShowGlobalRules(true)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-indigo-700 shadow-md whitespace-nowrap"><Icon name="settings" size={18}/> é è¨­ç‹€æ…‹è¦å‰‡</button>
                                    <button onClick={()=>setShowTagSettings(true)} className="bg-emerald-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-emerald-700 shadow-md whitespace-nowrap"><Icon name="tag" size={18}/> æ´»å‹•æ¨™ç±¤è¨­å®š</button>
                                    {/* æ–°å¢ï¼šå‰ç¥¥ç‰©è¨­å®šæŒ‰éˆ• */}
                                    <button onClick={()=>setShowMascotSettings(true)} className="bg-pink-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-pink-700 shadow-md whitespace-nowrap"><Icon name="smile" size={18}/> å‰ç¥¥ç‰©è¨­å®š</button>
                                    <button onClick={()=>setShowOutingPosterSettings(true)} className="bg-amber-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-amber-700 shadow-md whitespace-nowrap"><Icon name="image" size={18}/> å¤–å‡ºå ´åˆŠè¨­å®š</button>
                                    {/* ğŸ‘‡ æ–°å¢é€™é¡†æŒ‰éˆ• ğŸ‘‡ */}
                                    <button onClick={handleInitializeAnalytics} className="bg-orange-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-orange-600 shadow-md whitespace-nowrap"><Icon name="refresh-cw" size={18}/> åˆå§‹åŒ–æµé‡æ•¸æ“š</button>
                                </div>
                            </header>

                            <details className="group bg-white p-4 rounded-2xl shadow-sm border border-slate-200 transition-all open:ring-2 open:ring-blue-100">
                                <summary className="flex items-center justify-between cursor-pointer list-none select-none">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-blue-50 p-2 rounded-lg text-blue-600"><Icon name="database" size={20}/></div>
                                        <div className="flex flex-col">
                                            <span className="font-bold text-slate-700 text-sm">åŸå§‹ CSV è³‡æ–™åº«</span>
                                            <span className="text-xs text-slate-400 font-normal">é€²éšå…¨é‡ç·¨è¼¯æ¨¡å¼</span>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded-full group-open:hidden">å±•é–‹</span>
                                        <Icon name="chevron-down" size={18} className="text-slate-400 group-open:rotate-180 transition-transform duration-300"/>
                                    </div>
                                </summary>
                                <div className="mt-4 pt-4 border-t border-slate-100 animate-in fade-in slide-in-from-top-2">
                                    <textarea className="w-full h-80 p-3 font-mono text-xs bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none resize-none leading-relaxed tracking-wide" value={csvInput} onChange={e=>setCsvInput(e.target.value)} onFocus={() => isEditingRef.current = true} onBlur={() => isEditingRef.current = false} spellCheck="false" />
                                    <div className="mt-4 flex flex-col md:flex-row justify-between items-center gap-4">
                                        <div className="w-full md:w-auto flex items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200">
                                            <Icon name="lock" size={14} className="text-slate-400"/>
                                            <span className="text-xs font-bold text-slate-600 whitespace-nowrap">å®‰å…¨é–</span>
                                            <input type="password" placeholder="ç®¡ç†å“¡å¯†ç¢¼..." className="px-2 py-1.5 border rounded text-xs w-full md:w-32 outline-none focus:border-blue-400 bg-white" value={newPasswordInput} onChange={e=>setNewPasswordInput(e.target.value)} />
                                            <button onClick={handleUpdatePassword} className={`text-xs text-white px-3 py-1.5 rounded transition-colors whitespace-nowrap ${passwordSaveStatus==='success' ? 'bg-green-500' : 'bg-slate-600 hover:bg-slate-700'}`}>{passwordSaveStatus==='success' ? 'å·²æ›´æ–°' : 'æ›´æ–°'}</button>
                                        </div>
                                        <div className="flex items-center gap-2 w-full md:w-auto">
                                            <button onClick={() => handleSaveCSV(csvInput)} disabled={isSaving || csvSaveStatus === 'saving'} className={`flex-1 md:flex-none text-white px-6 py-2.5 rounded-xl flex items-center justify-center gap-2 shadow-md transition-all ${csvSaveStatus === 'success' ? 'bg-green-600 hover:bg-green-700' : csvSaveStatus === 'error' ? 'bg-red-600 hover:bg-red-700' : 'bg-slate-800 hover:bg-slate-900'}`}>
                                                {csvSaveStatus === 'saving' ? <Icon name="loader-2" className="animate-spin"/> : csvSaveStatus === 'success' ? <Icon name="check"/> : <Icon name="save"/>} 
                                                <span>{csvSaveStatus === 'saving' ? 'å„²å­˜ä¸­...' : csvSaveStatus === 'success' ? 'âœ… å·²æˆåŠŸå„²å­˜ï¼' : 'å„²å­˜è®Šæ›´'}</span>
                                            </button>
                                            {csvSaveStatus === 'success' && <span className="text-xs text-slate-400 hidden md:inline">Saved</span>}
                                        </div>
                                    </div>
                                </div>
                            </details>

                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden table-container">
                                <div className="p-4 border-b border-slate-100 flex gap-4 sticky left-0">
                                    <div className="relative flex-1">
                                        <Icon name="search" className="absolute left-3 top-2.5 text-slate-400" size={18}/>
                                        <input type="text" placeholder="æœå°‹å§“åã€æ´»å‹•æˆ–æ—¥æœŸ..." className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" value={importSearch} onChange={e=>setImportSearch(e.target.value)}/>
                                    </div>
                                </div>
                                <div className="max-h-[600px] overflow-y-auto">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-50 border-b border-slate-100 text-slate-500 sticky top-0"><tr><th className="p-2 md:p-4 whitespace-nowrap">æ—¥æœŸ</th><th className="p-2 md:p-4 whitespace-nowrap">æ´»å‹•</th><th className="p-2 md:p-4 whitespace-nowrap">å®¢æˆ¶</th><th className="p-4 hidden md:table-cell text-right">é‡‘é¡</th><th className="p-2 md:p-4 text-right">æ“ä½œ</th></tr></thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {(() => {
                                                const today = new Date(); today.setHours(0, 0, 0, 0);
                                                const filtered = parsedData.filter(r => !importSearch || JSON.stringify(r).toLowerCase().includes(importSearch.toLowerCase()));
                                                const sorted = filtered.sort((a, b) => {
                                                    const dateA = new Date(a.date); const dateB = new Date(b.date);
                                                    if (isNaN(dateA)) return 1; if (isNaN(dateB)) return -1;
                                                    const isAFuture = dateA >= today; const isBFuture = dateB >= today;
                                                    if (isAFuture && !isBFuture) return -1; if (!isAFuture && isBFuture) return 1;
                                                    if (isAFuture) return dateA - dateB; return dateB - dateA;
                                                });
                                                return sorted.map((row) => (
                                                    <tr key={row.id} className="hover:bg-slate-50">
                                                        <td className="p-2 md:p-4 text-slate-600 text-xs md:text-sm whitespace-nowrap">{row.date}</td>
                                                        <td className="p-2 md:p-4 font-medium text-slate-700 text-xs md:text-sm">{row.eventName}</td>
                                                        <td className="p-2 md:p-4 text-xs md:text-sm truncate max-w-[80px] md:max-w-none">{row.customerName}</td>
                                                        <td className="p-4 font-mono hidden md:table-cell text-right">${row.price}</td>
                                                        <td className="p-2 md:p-4 text-right flex justify-end gap-1 md:gap-2"><button onClick={()=>setEditingRow(row)} className="p-2 text-blue-600 hover:bg-blue-50 rounded border border-transparent hover:border-blue-100"><Icon name="edit-2" size={16}/></button><button onClick={()=>handleDeleteRow(row.id)} className="p-2 text-red-400 hover:bg-red-50 rounded hidden md:inline-block"><Icon name="trash-2" size={16}/></button></td>
                                                    </tr>
                                                ));
                                            })()}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            {/* [ä¿®æ”¹] è·‘é¦¬ç‡ˆè¨­å®šå€å¡Š (åŒ…å«é€Ÿåº¦èˆ‡åœ–ç¤º) */}
                            <section className="mb-8">
                                <h2 className="text-2xl font-bold mb-4">ğŸ¨ å‰å°ä¸»é¡Œè¨­å®š</h2>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                                        <button onClick={() => handleApplyThemePreset('sunny')} className="bg-amber-500 text-white px-3 py-2 rounded-lg text-sm font-bold hover:bg-amber-600">å¥—ç”¨ æ™´ç©ºç¥ç€</button>
                                        <button onClick={() => handleApplyThemePreset('forest')} className="bg-emerald-600 text-white px-3 py-2 rounded-lg text-sm font-bold hover:bg-emerald-700">å¥—ç”¨ æ£®æ—è–„éœ§</button>
                                        <button onClick={() => handleApplyThemePreset('ocean')} className="bg-sky-600 text-white px-3 py-2 rounded-lg text-sm font-bold hover:bg-sky-700">å¥—ç”¨ æµ·æ´‹æ™¨å…‰</button>
                                        <button onClick={() => handleApplyThemePreset('newyear')} className="bg-red-600 text-white px-3 py-2 rounded-lg text-sm font-bold hover:bg-red-700">å¥—ç”¨ æ–°å¹´å–œæ…¶</button>
                                        <button onClick={() => setPublicTheme(DEFAULT_PUBLIC_THEME)} className="bg-slate-700 text-white px-3 py-2 rounded-lg text-sm font-bold hover:bg-slate-800">é‚„åŸé è¨­</button>
                                    </div>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">èƒŒæ™¯ä¸»è‰²</label><input type="color" className="w-full h-10 p-1 border rounded-xl cursor-pointer" value={publicTheme.pageBg} onChange={e => setPublicTheme({ ...publicTheme, pageBg: e.target.value })} /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">èƒŒæ™¯è¼”è‰²</label><input type="color" className="w-full h-10 p-1 border rounded-xl cursor-pointer" value={publicTheme.pageBgAlt} onChange={e => setPublicTheme({ ...publicTheme, pageBgAlt: e.target.value })} /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">å¡ç‰‡èƒŒæ™¯</label><input type="color" className="w-full h-10 p-1 border rounded-xl cursor-pointer" value={publicTheme.surfaceBg} onChange={e => setPublicTheme({ ...publicTheme, surfaceBg: e.target.value })} /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">å¡ç‰‡é‚Šæ¡†</label><input type="color" className="w-full h-10 p-1 border rounded-xl cursor-pointer" value={publicTheme.surfaceBorder} onChange={e => setPublicTheme({ ...publicTheme, surfaceBorder: e.target.value })} /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">æ¨™é¡Œè‰²</label><input type="color" className="w-full h-10 p-1 border rounded-xl cursor-pointer" value={publicTheme.titleColor} onChange={e => setPublicTheme({ ...publicTheme, titleColor: e.target.value })} /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">å…§æ–‡å­—è‰²</label><input type="color" className="w-full h-10 p-1 border rounded-xl cursor-pointer" value={publicTheme.textColor} onChange={e => setPublicTheme({ ...publicTheme, textColor: e.target.value })} /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">å¼·èª¿è‰²</label><input type="color" className="w-full h-10 p-1 border rounded-xl cursor-pointer" value={publicTheme.accentColor} onChange={e => setPublicTheme({ ...publicTheme, accentColor: e.target.value })} /></div>
                                    </div>
                                    <div className="mt-4 flex justify-end">
                                        <button onClick={handleSavePublicTheme} className="bg-indigo-600 text-white px-6 py-2 rounded-xl hover:bg-indigo-700 shadow-md font-bold">
                                            <Icon name="save" size={18} className="inline mr-2"/>å„²å­˜å‰å°ä¸»é¡Œ
                                        </button>
                                    </div>
                                </div>
                            </section>

                            <section className="mb-8">
                                <h2 className="text-2xl font-bold mb-4">ğŸ–¼ï¸ æ´»å‹•å ´æ¬¡è¡¨å·¦å³è£é£¾åœ–</h2>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                                    <p className="text-xs text-slate-500">å¯å¡«åœ–ç‰‡æª”åï¼ˆä¾‹å¦‚ `left-newyear.png`ï¼‰æˆ–å®Œæ•´ç¶²å€ã€‚ç©ºç™½å°±ä¸é¡¯ç¤ºã€‚åœ–ç‰‡æœƒé¡¯ç¤ºåœ¨ã€Œæ´»å‹•å ´æ¬¡è¡¨ã€æ¨™é¡Œå·¦å³å…©å´ï¼ˆæ¡Œé¢ `xl` ä»¥ä¸Šï¼‰ã€‚</p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">å·¦å´åœ–ç‰‡</label>
                                            <input type="text" className="w-full p-2 border rounded-lg text-sm" placeholder="ä¾‹å¦‚: left.png æˆ– https://..." value={publicSideDecor.leftImage} onChange={e => setPublicSideDecor({ ...publicSideDecor, leftImage: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">å³å´åœ–ç‰‡</label>
                                            <input type="text" className="w-full p-2 border rounded-lg text-sm" placeholder="ä¾‹å¦‚: right.png æˆ– https://..." value={publicSideDecor.rightImage} onChange={e => setPublicSideDecor({ ...publicSideDecor, rightImage: e.target.value })} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">åœ–ç‰‡å¯¬åº¦(px)</label>
                                            <input type="number" min="60" max="480" className="w-full p-2 border rounded-lg text-sm" value={publicSideDecor.width} onChange={e => setPublicSideDecor({ ...publicSideDecor, width: Number(e.target.value) || 180 })} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">æ‰‹æ©Ÿåœ–ç‰‡å¯¬åº¦(pxï¼Œç•™ç©º=åŒæ¡Œæ©Ÿ)</label>
                                            <input type="number" min="40" max="480" className="w-full p-2 border rounded-lg text-sm" value={publicSideDecor.mobileWidth || ''} onChange={e => setPublicSideDecor({ ...publicSideDecor, mobileWidth: e.target.value === '' ? 0 : Number(e.target.value) })} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">ä¸Šä¸‹è·é›¢(px)</label>
                                            <input type="number" min="-300" max="500" className="w-full p-2 border rounded-lg text-sm" value={publicSideDecor.offsetY} onChange={e => setPublicSideDecor({ ...publicSideDecor, offsetY: Number(e.target.value) || 0 })} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">å·¦å³è·é›¢(px)</label>
                                            <input type="number" min="0" max="400" className="w-full p-2 border rounded-lg text-sm" value={publicSideDecor.offsetX} onChange={e => setPublicSideDecor({ ...publicSideDecor, offsetX: Number(e.target.value) || 24 })} />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">é€æ˜åº¦(0-1)</label>
                                            <input type="number" min="0" max="1" step="0.1" className="w-full p-2 border rounded-lg text-sm" value={publicSideDecor.opacity} onChange={e => setPublicSideDecor({ ...publicSideDecor, opacity: Number(e.target.value) })} />
                                        </div>
                                    </div>
                                    <div className="flex justify-end gap-2">
                                        <button onClick={() => setPublicSideDecor(DEFAULT_PUBLIC_SIDE_DECOR)} className="bg-slate-100 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-200 text-sm font-bold">æ¸…ç©º</button>
                                        <button onClick={handleSavePublicSideDecor} className="bg-indigo-600 text-white px-6 py-2 rounded-xl hover:bg-indigo-700 shadow-md font-bold">
                                            <Icon name="save" size={18} className="inline mr-2"/>å„²å­˜æ´»å‹•å ´æ¬¡è¡¨å·¦å³åœ–
                                        </button>
                                    </div>
                                </div>
                            </section>

                            <section className="mb-8">
                                <h2 className="text-2xl font-bold mb-4">ğŸ“¢ å‰å°å…¬å‘Šè¨­å®š</h2>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex flex-col gap-4">
                                    
                                    {/* ç¬¬ä¸€åˆ—ï¼šæ–‡å­—è¼¸å…¥ */}
                                    <div className="w-full">
                                        <label className="block text-xs font-bold text-slate-500 mb-1">è·‘é¦¬ç‡ˆå…§å®¹</label>
                                        <input 
                                            type="text" 
                                            className="w-full p-3 border rounded-xl outline-none focus:ring-2 focus:ring-blue-500" 
                                            placeholder="è¼¸å…¥è¦é¡¯ç¤ºåœ¨é¦–é ä¸Šæ–¹çš„æœ€æ–°æ¶ˆæ¯..." 
                                            value={latestNews} 
                                            onChange={e => setLatestNews(e.target.value)} 
                                        />
                                    </div>

                                    {/* ç¬¬äºŒåˆ—ï¼šé€²éšè¨­å®š (é€Ÿåº¦ & åœ–ç¤º & å„²å­˜æŒ‰éˆ•) */}
                                    <div className="flex flex-col md:flex-row gap-4 items-end">
                                        
                                        <div className="flex-1">
                                            <label className="block text-xs font-bold text-slate-500 mb-1">è·‘é¦¬ç‡ˆåœ–ç¤º (åƒç´ é¢¨)</label>
                                            <div className="relative">
    <input 
        type="text" 
        list="marquee-icon-history"
        className="w-full p-3 border rounded-xl outline-none bg-white" 
        placeholder="è¼¸å…¥æ–°æª”åï¼Œå„²å­˜å¾Œæœƒè‡ªå‹•åŠ å…¥æ¸…å–®..." 
        value={marqueeIcon} 
        onChange={e => setMarqueeIcon(e.target.value)} 
    />
    <datalist id="marquee-icon-history">
        {/* é è¨­é¸é … */}
        <option value="eating.gif">ğŸ” è²ªåƒæ¾é¼ </option>
        <option value="cleaning.gif">ğŸ§¹ æ‰“æƒæ¾é¼ </option>
        <option value="climbing.gif">ğŸ§— æ”€å²©æ¾é¼ </option>
        <option value="sliding.gif">ğŸ„ æ»‘è¡Œæ¾é¼ </option>
        <option value="milking.gif">ğŸ¥› å–å¥¶æ¾é¼ </option>
        {/* è‡ªå‹•ç´€éŒ„çš„æ­·å²é¸é … */}
        {marqueeIconHistory.map(icon => (
            <option key={icon} value={icon}>{icon}</option>
        ))}
    </datalist>
</div>
                                        </div>

                                        <div className="flex-1">
    <label className="block text-xs font-bold text-slate-500 mb-1">æ»¾å‹•é€Ÿåº¦ ({marqueeSpeed}s)</label>
    <input type="range" min="5" max="60" step="1" className="w-full h-10" value={marqueeSpeed} onChange={e => setMarqueeSpeed(Number(e.target.value))} />
</div>

<div className="w-24">
    <label className="block text-xs font-bold text-slate-500 mb-1">èƒŒæ™¯é¡è‰²</label>
    <input type="color" className="w-full h-10 p-1 border rounded-xl cursor-pointer" title="é»æ“Šé–‹å•Ÿèª¿è‰²ç›¤ï¼Œå¯ä½¿ç”¨æ»´ç®¡" value={marqueeBgColor} onChange={e => setMarqueeBgColor(e.target.value)} />
</div>

<div className="w-24">
    <label className="block text-xs font-bold text-slate-500 mb-1">æ–‡å­—é¡è‰²</label>
    <input type="color" className="w-full h-10 p-1 border rounded-xl cursor-pointer" title="é»æ“Šé–‹å•Ÿèª¿è‰²ç›¤ï¼Œå¯ä½¿ç”¨æ»´ç®¡" value={marqueeTextColor} onChange={e => setMarqueeTextColor(e.target.value)} />
</div>

<div className="w-24">
    <label className="block text-xs font-bold text-slate-500 mb-1">åœ–æ¡ˆå¤§å°</label>
    <input type="number" className="w-full h-10 p-2 border rounded-xl text-center font-bold" value={marqueeIconSize} onChange={e => setMarqueeIconSize(Number(e.target.value))} />
</div>

                                        <button 
                                            onClick={async () => {
    if(!user) return alert("è«‹å…ˆç™»å…¥");
    // å°‡æ–°æª”ååŠ å…¥æ­·å²ï¼Œä¸¦å»é™¤é‡è¤‡èˆ‡ç©ºå€¼
    const newHistory = Array.from(new Set([...marqueeIconHistory, marqueeIcon])).filter(Boolean);
    await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'main'), { 
    latestNews: latestNews,
    marqueeSpeed: marqueeSpeed,
    marqueeIcon: marqueeIcon,
    marqueeIconHistory: newHistory,
    marqueeBgColor: marqueeBgColor,
    marqueeTextColor: marqueeTextColor,
    marqueeIconSize: marqueeIconSize
}, { merge: true });
    setMarqueeIconHistory(newHistory);
    alert("å…¬å‘Šè¨­å®šå·²æ›´æ–°ä¸¦ç´€éŒ„åœ–æª”åç¨±ï¼");
}}
                                            className="bg-slate-800 text-white px-6 py-3 rounded-xl hover:bg-slate-700 shadow-md font-bold whitespace-nowrap w-full md:w-auto h-[50px]"
                                        >
                                            <Icon name="save" size={18} className="inline mr-2"/>
                                            å„²å­˜è¨­å®š
                                        </button>
                                    </div>
                                </div>
                            </section>
				<section>
                                <h2 className="text-2xl font-bold mb-6">æ–°å¢å ±åè³‡æ–™</h2>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label className="block text-xs font-bold text-slate-500 mb-1">æ—¥æœŸ *</label><input type="date" className="w-full p-2 border rounded-lg" value={newReg.date} onChange={e=>setNewReg({...newReg, date: e.target.value})} /></div><div><label className="block text-xs font-bold text-slate-500 mb-1">æ´»å‹•åç¨± *</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="ä¾‹å¦‚: ç™»å±±åœ˜" value={newReg.eventName} onChange={e=>setNewReg({...newReg, eventName: e.target.value})} /></div><div><label className="block text-xs font-bold text-slate-500 mb-1">è¬›å¸«</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="è¬›å¸«å§“å" value={newReg.instructor} onChange={e=>setNewReg({...newReg, instructor: e.target.value})} /></div></div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label className="block text-xs font-bold text-slate-500 mb-1">å®¢æˆ¶å§“å *</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="ç‹å°æ˜" value={newReg.customerName} onChange={e=>setNewReg({...newReg, customerName: e.target.value})} /></div><div><label className="block text-xs font-bold text-slate-500 mb-1">é‡‘é¡</label><input type="number" className="w-full p-2 border rounded-lg" placeholder="3000" value={newReg.price} onChange={e=>setNewReg({...newReg, price: e.target.value})} /></div><div><label className="block text-xs font-bold text-slate-500 mb-1">äº¤é€šæ–¹å¼</label><select className="w-full p-2 border rounded-lg" value={newReg.transport} onChange={e=>setNewReg({...newReg, transport: e.target.value})}><option value="">æœªå®š</option><option value="å…±ä¹˜">å…±ä¹˜</option><option value="è‡ªè¡Œå‰å¾€">è‡ªè¡Œå‰å¾€</option></select></div></div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label className="block text-xs font-bold text-slate-500 mb-1">è¨‚è³¼æ—¥</label><input type="date" className="w-full p-2 border rounded-lg" value={newReg.orderDate} onChange={e=>setNewReg({...newReg, orderDate: e.target.value})} /></div><div><label className="block text-xs font-bold text-slate-500 mb-1">å ±åç®¡é“</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="FB, IG..." value={newReg.source} onChange={e=>setNewReg({...newReg, source: e.target.value})} /></div><div><label className="block text-xs font-bold text-slate-500 mb-1">æ‰‹æ©Ÿ</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="09xx..." value={newReg.phone} onChange={e=>setNewReg({...newReg, phone: e.target.value})} /></div></div>
                                    <div className="flex justify-end pt-2"><button onClick={handleAddManualReg} disabled={isSaving} className={`bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-colors ${addRegStatus==='success'?'bg-green-600 hover:bg-green-700':'hover:bg-blue-700'}`}>{isSaving ? <Icon name="loader-2" className="animate-spin"/> : (addRegStatus==='success' ? <Icon name="check"/> : <Icon name="plus"/>)}{addRegStatus==='success' ? 'æ–°å¢æˆåŠŸï¼' : 'æ–°å¢ä¸€ç­†å ±å'}</button></div>
                                </div>
                            </section>
                            
                            <DataRescueTab currentAppId={dbSource} onSwitch={handleDbSourceChange} />
                        </div>}
                    </main>

                    {showDebug && <DebugPanel onClose={()=>setShowDebug(false)} />}
                    {showCreateEvent && <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 fade-in"><div className="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl m-auto">
                        <CreateEventModal 
                            initialDate={scheduleDate} // [æ–°å¢] å‚³å…¥é»é¸çš„æ—¥æœŸ
                            onClose={()=>setShowCreateEvent(false)} 
                            onSave={handleCreateEvent} 
                            customTemplates={customTemplates} 
                            onSaveTemplate={handleSaveTemplate} 
                            onDeleteTemplate={onDeleteTemplate} 
                            availableInstructors={Object.keys(stats.instrs).sort()} 
                            instructorSchedule={instructorSchedule} 
                            tagDefinitions={tagDefinitions}
                            onAddTag={handleAddTagDefinition}
                        />
                    </div></div>}
                    {showAddPromise && <AddPromiseModal onClose={()=>setShowAddPromise(false)} onSave={handleAddPromise} />}
                    {showBulkImport && <BulkImportModal onClose={()=>setShowBulkImport(false)} onImport={handleBulkImport} existingData={parsedData} />}
                    
                    {showScheduleModal && <InstructorScheduleModal 
                        date={scheduleDate} 
                        availableInstructors={Object.keys(stats.instrs).sort()} 
                        restingList={instructorSchedule[scheduleDate] || []} 
                        onClose={()=>setShowScheduleModal(false)} 
                        onToggle={handleToggleInstructorRest}
                        isCompanyRest={companyRestDates.includes(scheduleDate)}
                        onToggleCompanyRest={handleToggleCompanyRest}
                        isOutingDay={!!(outingDays[scheduleDate] && outingDays[scheduleDate].enabled)}
                        outingPosterFilename={outingDays[scheduleDate]?.posterFilename || ''}
                        outingPosterOptions={outingPosterConfig}
                        outingPeople={outingDays[scheduleDate]?.people || []}
                        onToggleOutingDay={handleToggleOutingDay}
                        onSetOutingPoster={handleSetOutingPoster}
                        onToggleOutingPerson={handleToggleOutingPerson}
                    />}
                    
                    {activeTaskDetail && <TaskDetailModal task={activeTaskDetail} eventData={activeTaskDetail.fullEvent} onClose={()=>setActiveTaskDetail(null)} />}
                    
                    {editingEvent && <EventManagerModal 
                        event={activeEditingEvent} 
                        config={eventConfigs[editingEvent.key]} 
                        onClose={()=>setEditingEvent(null)} 
                        onSaveConfig={(cfg, newInstr, newInternalName)=>handleSaveEventConfig(editingEvent.key, cfg, newInstr, newInternalName)} 
                        availableInstructors={Object.keys(stats.instrs).sort()} 
                        instructorSchedule={instructorSchedule} 
                        onCheckInToggle={handleCheckInToggle}
                        onDeleteEvent={handleDeleteEvent}
                        globalRules={globalRules}
                        onEditCustomer={(c) => setEditingRow(c)}
                        tagDefinitions={tagDefinitions}
                        onAddTag={handleAddTagDefinition}
                        parsedData={parsedData}
                        onAddDirectReg={handleAddDirectReg}
                        adminPassword={adminPassword} 
                    />}
                    
                    {editingProject && <ProjectDetailModal 
                        project={editingProject} 
                        onClose={()=>setEditingProject(null)} 
                        onUpdate={handleUpdateProject}
                        onDelete={handleDeleteProject}
                    />}

                    {showGlobalRules && <GlobalRulesModal currentRules={globalRules} onClose={()=>setShowGlobalRules(false)} onSave={async (newRules) => { await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'main'), { globalRules: newRules }, { merge: true }); setShowGlobalRules(false); }} />}
                    
                    {showTagSettings && <TagSettingsModal currentDefs={tagDefinitions} onClose={()=>setShowTagSettings(false)} onSave={async (newDefs) => { await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'main'), { tagDefinitions: newDefs }, { merge: true }); setShowTagSettings(false); }} />}
                    
                    {/* æ–°å¢ï¼šå‰ç¥¥ç‰©è¨­å®š Modal */}
                    {showMascotSettings && <MascotSettingsModal currentList={mascotConfig} onClose={()=>setShowMascotSettings(false)} onSave={async (newList) => { await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'main'), { mascotConfig: newList }, { merge: true }); setShowMascotSettings(false); }} />}
                    {showOutingPosterSettings && <OutingPosterSettingsModal currentList={outingPosterConfig} onClose={()=>setShowOutingPosterSettings(false)} onSave={async (newList) => { await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'main'), { outingPosterConfig: newList }, { merge: true }); setShowOutingPosterSettings(false); }} />}
                    
                    {editingRow && <EditRowModal rowData={editingRow} existingTransports={uniqueTransports} onClose={()=>setEditingRow(null)} onSave={handleUpdateRow} onDelete={(id) => { handleDeleteRow(id); setEditingRow(null); }} />}
{/* â˜… åŠ åœ¨é€™è£¡ï¼šåŒ¯å‡ºæœˆæ›†è³‡æ–™çš„å½ˆå‡ºè¦–çª— */}
                    {showExportModal && <CalendarExportModal events={stats.events} eventConfigs={eventConfigs} onClose={()=>setShowExportModal(false)} />}
                    {showLoginModal && <LoginModal onClose={()=>setShowLoginModal(false)} onLogin={handleVerifyLogin} />}
                </div>
            );
        };

        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<MainApp />);
        } catch (error) {
            document.getElementById('root').innerHTML = '<div style="padding:20px;color:red"><h3>ç³»çµ±è¼‰å…¥å¤±æ•—</h3><p>è«‹æª¢æŸ¥ console éŒ¯èª¤è¨Šæ¯ã€‚</p></div>';
            console.error("React Render Error:", error);
        }
    </script>
</body>
</html>
